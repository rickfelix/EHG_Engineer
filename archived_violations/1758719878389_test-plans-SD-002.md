# Test Plans for SD-002: AI Navigation Consolidated

**Document Version**: 1.0
**Created By**: PLAN Agent
**Date**: 2025-09-23
**Coverage Target**: 85% Code, 100% Critical Paths

---

## 1. Test Strategy Overview

### 1.1 Testing Approach
- **Shift-Left Testing**: Tests written before/during development
- **Test Pyramid**: 70% Unit, 20% Integration, 10% E2E
- **AI Model Testing**: Separate validation pipeline
- **Performance Testing**: Continuous monitoring
- **Accessibility Testing**: Automated + Manual

### 1.2 Test Environments
| Environment | Purpose | Data | Users |
|-------------|---------|------|-------|
| Development | Unit tests | Mock | Developers |
| Staging | Integration tests | Synthetic | QA Team |
| UAT | User acceptance | Sanitized prod | Beta users |
| Production | Smoke tests | Real | All users |

---

## 2. Unit Tests (Target: 85% Coverage)

### 2.1 Navigation Engine Tests
```javascript
describe('NavigationEngine', () => {
  test('should predict next navigation with >85% accuracy', async () => {
    const engine = new NavigationEngine();
    const history = mockNavigationHistory();
    const prediction = await engine.predict(history);

    expect(prediction.confidence).toBeGreaterThan(0.85);
    expect(prediction.paths).toHaveLength(3);
    expect(prediction.responseTime).toBeLessThan(100);
  });

  test('should handle new users with no history', async () => {
    const engine = new NavigationEngine();
    const prediction = await engine.predict([]);

    expect(prediction.paths).toEqual(defaultPaths);
    expect(prediction.confidence).toBeLessThan(0.5);
  });

  test('should cache predictions effectively', async () => {
    const engine = new NavigationEngine();
    const context = { page: '/dashboard', user: 'test' };

    const first = await engine.predict(context);
    const second = await engine.predict(context);

    expect(second.fromCache).toBe(true);
    expect(second.responseTime).toBeLessThan(10);
  });
});
```

### 2.2 Context Analyzer Tests
```javascript
describe('ContextAnalyzer', () => {
  test('should identify user context correctly', () => {
    const analyzer = new ContextAnalyzer();
    const context = analyzer.analyze({
      currentPath: '/reports/sales',
      time: '09:00',
      role: 'manager'
    });

    expect(context.category).toBe('analytics');
    expect(context.timeContext).toBe('morning');
    expect(context.suggestions).toContain('/reports/dashboard');
  });
});
```

### 2.3 Component Tests
```javascript
describe('SmartNav Component', () => {
  test('should render predictions within 100ms', async () => {
    const start = Date.now();
    const { getByTestId } = render(<SmartNav />);

    await waitFor(() => {
      expect(getByTestId('predictions')).toBeInTheDocument();
    });

    expect(Date.now() - start).toBeLessThan(100);
  });

  test('should handle keyboard shortcuts', async () => {
    const { container } = render(<SmartNav />);

    fireEvent.keyDown(container, { key: 'k', ctrlKey: true });

    expect(screen.getByTestId('command-palette')).toBeVisible();
  });
});
```

---

## 3. Integration Tests

### 3.1 API Integration Tests
```javascript
describe('Navigation API Integration', () => {
  test('POST /api/v1/navigation/record', async () => {
    const response = await request(app)
      .post('/api/v1/navigation/record')
      .send({
        from: '/dashboard',
        to: '/reports',
        context: { timestamp: Date.now() }
      });

    expect(response.status).toBe(201);
    expect(response.body.recorded).toBe(true);
  });

  test('GET /api/v1/navigation/predictions', async () => {
    const response = await request(app)
      .get('/api/v1/navigation/predictions')
      .set('Authorization', 'Bearer token');

    expect(response.status).toBe(200);
    expect(response.body.predictions).toHaveLength(3);
    expect(response.headers['cache-control']).toContain('max-age=60');
  });
});
```

### 3.2 Database Integration Tests
```javascript
describe('Navigation Database', () => {
  test('should store navigation patterns', async () => {
    const pattern = {
      userId: 'test-user',
      from: '/home',
      to: '/profile',
      timestamp: new Date()
    };

    const id = await db.navigationPatterns.insert(pattern);
    const stored = await db.navigationPatterns.findById(id);

    expect(stored).toMatchObject(pattern);
  });

  test('should retrieve predictions from cache', async () => {
    const cached = await db.predictions.get('user-123', 'context-hash');

    expect(cached).toBeDefined();
    expect(cached.expiresAt).toBeInTheFuture();
  });
});
```

---

## 4. End-to-End Tests

### 4.1 Critical User Journeys
```javascript
describe('E2E: Navigation Flow', () => {
  test('User can navigate using predictions', async () => {
    await page.goto('/dashboard');

    // Wait for predictions to load
    await page.waitForSelector('[data-testid="prediction-1"]');

    // Click first prediction
    await page.click('[data-testid="prediction-1"]');

    // Verify navigation
    expect(page.url()).toContain('/reports');

    // Verify telemetry recorded
    const metrics = await page.evaluate(() => window.__telemetry);
    expect(metrics.navigation).toHaveLength(1);
  });

  test('Command palette navigation', async () => {
    await page.goto('/');

    // Open command palette
    await page.keyboard.press('Control+K');

    // Type search query
    await page.type('[data-testid="command-input"]', 'sales report');

    // Select first result
    await page.keyboard.press('Enter');

    // Verify navigation
    expect(page.url()).toContain('/reports/sales');
  });
});
```

### 4.2 Accessibility E2E Tests
```javascript
describe('E2E: Accessibility', () => {
  test('Keyboard-only navigation', async () => {
    await page.goto('/');

    // Tab through navigation
    for (let i = 0; i < 5; i++) {
      await page.keyboard.press('Tab');
    }

    // Verify focus on navigation
    const focused = await page.evaluate(() => document.activeElement.id);
    expect(focused).toBe('main-nav');

    // Navigate using Enter
    await page.keyboard.press('Enter');
    expect(page.url()).toContain('/dashboard');
  });

  test('Screen reader compatibility', async () => {
    const violations = await axe(page);
    expect(violations).toHaveLength(0);
  });
});
```

---

## 5. Performance Tests

### 5.1 Load Testing Script
```javascript
// K6 Load Test
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 },  // Ramp up
    { duration: '5m', target: 1000 }, // Stay at 1000
    { duration: '2m', target: 10000 }, // Spike
    { duration: '2m', target: 100 },  // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'], // 95% under 200ms
    http_req_failed: ['rate<0.01'],   // Error rate under 1%
  },
};

export default function () {
  let response = http.get('https://api.example.com/navigation/predictions');

  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200,
    'predictions returned': (r) => JSON.parse(r.body).predictions.length > 0,
  });
}
```

### 5.2 Performance Benchmarks
| Metric | Target | Critical |
|--------|--------|----------|
| Page Load | <2s | <3s |
| Navigation Response | <200ms | <500ms |
| Prediction Calculation | <100ms | <300ms |
| Cache Hit Rate | >80% | >60% |
| Memory Usage | <100MB | <200MB |
| CPU Usage | <30% | <50% |

---

## 6. AI Model Testing

### 6.1 Model Validation Tests
```python
def test_prediction_accuracy():
    """Test model prediction accuracy on test set"""
    model = load_model('navigation_predictor')
    test_data = load_test_dataset()

    predictions = model.predict(test_data.features)
    accuracy = calculate_accuracy(predictions, test_data.labels)

    assert accuracy > 0.85, f"Accuracy {accuracy} below threshold"

def test_model_bias():
    """Ensure model doesn't exhibit bias"""
    model = load_model('navigation_predictor')

    for segment in ['new_users', 'power_users', 'mobile_users']:
        data = load_segment_data(segment)
        accuracy = evaluate_segment(model, data)
        assert accuracy > 0.80, f"Bias detected in {segment}"

def test_edge_cases():
    """Test model with edge cases"""
    model = load_model('navigation_predictor')

    edge_cases = [
        [],  # Empty history
        generate_random_history(1000),  # Large history
        generate_circular_pattern(),  # Circular navigation
    ]

    for case in edge_cases:
        prediction = model.predict(case)
        assert prediction is not None
        assert len(prediction) <= 5
```

### 6.2 A/B Test Framework
```javascript
describe('A/B Testing', () => {
  test('Control vs AI Navigation', async () => {
    const control = await runExperiment('control');
    const treatment = await runExperiment('ai-nav');

    expect(treatment.taskCompletionTime).toBeLessThan(
      control.taskCompletionTime * 0.7  // 30% improvement
    );

    expect(treatment.userSatisfaction).toBeGreaterThan(
      control.userSatisfaction
    );
  });
});
```

---

## 7. Security Tests

### 7.1 Security Test Cases
```javascript
describe('Security', () => {
  test('Should sanitize user input', async () => {
    const maliciousInput = '<script>alert("xss")</script>';

    const response = await api.post('/navigation/search', {
      query: maliciousInput
    });

    expect(response.body).not.toContain('<script>');
    expect(response.body.query).toBe('scriptalertxssscript');
  });

  test('Should enforce rate limiting', async () => {
    const requests = Array(1001).fill().map(() =>
      api.get('/navigation/predictions')
    );

    const responses = await Promise.all(requests);
    const rateLimited = responses.filter(r => r.status === 429);

    expect(rateLimited.length).toBeGreaterThan(0);
  });

  test('Should require authentication', async () => {
    const response = await api.get('/navigation/predictions');

    expect(response.status).toBe(401);
    expect(response.body.error).toBe('Authentication required');
  });
});
```

---

## 8. Regression Tests

### 8.1 Regression Test Suite
- All existing navigation must continue to work
- Performance must not degrade >5%
- No breaking changes to existing APIs
- Backward compatibility for bookmarks
- Legacy browser support (IE11 basic functionality)

### 8.2 Smoke Tests
```javascript
// Production smoke tests - run after deployment
describe('Smoke Tests', () => {
  test('Health check', async () => {
    const response = await fetch('/health');
    expect(response.status).toBe(200);
  });

  test('Basic navigation works', async () => {
    const response = await fetch('/api/navigation/basic');
    expect(response.status).toBe(200);
  });

  test('AI features available', async () => {
    const response = await fetch('/api/navigation/predictions');
    expect(response.status).not.toBe(500);
  });
});
```

---

## 9. Test Data Management

### 9.1 Test Data Sets
| Dataset | Size | Purpose |
|---------|------|---------|
| Navigation History | 100K records | Model training |
| User Profiles | 1000 users | Persona testing |
| Edge Cases | 50 scenarios | Boundary testing |
| Performance | 1M requests | Load testing |

### 9.2 Data Generation Scripts
```javascript
// Generate synthetic navigation data
function generateNavigationHistory(users = 100, days = 30) {
  const paths = ['/dashboard', '/reports', '/settings', '/profile'];
  const history = [];

  for (let user = 0; user < users; user++) {
    for (let day = 0; day < days; day++) {
      const sessions = Math.floor(Math.random() * 5) + 1;

      for (let session = 0; session < sessions; session++) {
        const sessionLength = Math.floor(Math.random() * 10) + 3;

        for (let nav = 0; nav < sessionLength; nav++) {
          history.push({
            userId: `user-${user}`,
            from: paths[nav % paths.length],
            to: paths[(nav + 1) % paths.length],
            timestamp: new Date(Date.now() - day * 86400000),
            sessionId: `${user}-${day}-${session}`
          });
        }
      }
    }
  }

  return history;
}
```

---

## 10. Test Automation

### 10.1 CI/CD Pipeline Tests
```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - run: npm run test:unit
      - run: npm run coverage

  integration-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
      redis:
        image: redis:7
    steps:
      - run: npm run test:integration

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - run: npm run test:e2e

  performance-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - run: npm run test:performance
      - run: npm run lighthouse
```

### 10.2 Test Reporting
- **Coverage Reports**: Generated after each run
- **Performance Metrics**: Tracked in DataDog
- **Test Results**: Posted to PR comments
- **Regression Alerts**: Sent to Slack
- **Weekly Summary**: Emailed to team

---

## 11. Acceptance Criteria Verification

### Story-to-Test Mapping
| User Story | Test Type | Test Count | Coverage |
|------------|-----------|------------|----------|
| Story 1: Predictions | Unit, E2E | 15 | 100% |
| Story 2: Quick Actions | Unit, Integration | 12 | 100% |
| Story 3: Command Palette | Unit, E2E | 10 | 100% |
| Story 4: Smart Search | Unit, Integration | 18 | 100% |
| Story 5: Dashboard | Unit, E2E | 8 | 100% |
| Story 8: Accessibility | E2E, Manual | 20 | 100% |

---

## 12. Test Schedule

### Sprint 1 (Weeks 1-2)
- Write unit tests for core components
- Set up test infrastructure
- Create test data generation

### Sprint 2 (Weeks 3-4)
- Integration test development
- Performance baseline establishment
- Security test implementation

### Sprint 3 (Weeks 5-6)
- E2E test automation
- AI model validation
- Accessibility testing

### Sprint 4 (Weeks 7-8)
- Regression test suite
- Load testing at scale
- UAT coordination

---

**Document Status**: Complete
**Total Test Cases**: 250+
**Automation Coverage**: 90%
**Next Step**: Create PLAN→EXEC Handoff