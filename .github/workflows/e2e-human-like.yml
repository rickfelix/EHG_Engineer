name: Human-Like E2E Tests

# Reusable workflow for testing any venture's frontend
# Called by venture repos (EHG, future ventures) with their target URL
on:
  workflow_call:
    inputs:
      target_url:
        description: 'Base URL of the application to test (e.g., http://localhost:8080)'
        required: true
        type: string
      venture_name:
        description: 'Name of the venture being tested (for reporting)'
        required: false
        type: string
        default: 'Unknown Venture'
      stringency:
        description: 'Test stringency level'
        required: false
        type: string
        default: 'standard'
      pr_lines_changed:
        description: 'Number of lines changed in PR (for stringency calculation)'
        required: false
        type: number
        default: 0
    secrets:
      SUPABASE_URL:
        required: true
      SUPABASE_SERVICE_ROLE_KEY:
        required: true
      OPENAI_API_KEY:
        required: false

  # Manual trigger for testing from EHG_Engineer
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Base URL of the application to test'
        required: true
        type: string
        default: 'http://localhost:8080'
      venture_name:
        description: 'Name of the venture being tested'
        required: false
        type: string
        default: 'EHG'
      stringency:
        description: 'Override stringency level'
        required: false
        type: choice
        options:
          - strict
          - standard
          - relaxed
        default: 'standard'

env:
  NODE_VERSION: '22'

jobs:
  # Validate target is reachable
  preflight:
    name: Preflight Check
    runs-on: ubuntu-latest
    outputs:
      target_reachable: ${{ steps.check.outputs.reachable }}
      stringency: ${{ inputs.stringency || 'standard' }}

    steps:
      - name: Check target URL
        id: check
        run: |
          TARGET="${{ inputs.target_url }}"
          echo "Checking if $TARGET is reachable..."

          # Try to reach the target (with timeout)
          if curl -s --max-time 10 --head "$TARGET" > /dev/null 2>&1; then
            echo "reachable=true" >> $GITHUB_OUTPUT
            echo "✅ Target $TARGET is reachable"
          else
            echo "reachable=false" >> $GITHUB_OUTPUT
            echo "❌ Target $TARGET is not reachable"
            echo "::warning::Target URL is not reachable. Tests will be skipped."
          fi

  # Accessibility checks with axe-core
  accessibility:
    name: Accessibility (axe-core)
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.target_reachable == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout EHG_Engineer (testing framework)
        uses: actions/checkout@v4
        with:
          repository: rickfelix/EHG_Engineer
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run accessibility tests
        run: npx playwright test tests/e2e/accessibility/ --project=chromium
        env:
          BASE_URL: ${{ inputs.target_url }}
          A11Y_STRINGENCY: ${{ needs.preflight.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.preflight.outputs.stringency == 'relaxed' }}

      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results-${{ inputs.venture_name }}
          path: test-results/**/accessibility-results.json

  # Chaos/resilience testing
  chaos:
    name: Chaos & Resilience
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.target_reachable == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout EHG_Engineer (testing framework)
        uses: actions/checkout@v4
        with:
          repository: rickfelix/EHG_Engineer
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run chaos tests
        run: npx playwright test tests/e2e/resilience/ --project=chromium
        env:
          BASE_URL: ${{ inputs.target_url }}
          E2E_STRINGENCY: ${{ needs.preflight.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.preflight.outputs.stringency == 'relaxed' }}

      - name: Upload chaos results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-results-${{ inputs.venture_name }}
          path: test-results/**/chaos-results.json

  # Visual regression (CLS)
  visual:
    name: Visual & CLS
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.target_reachable == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout EHG_Engineer (testing framework)
        uses: actions/checkout@v4
        with:
          repository: rickfelix/EHG_Engineer
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual tests
        run: npx playwright test tests/e2e/visual/ --project=chromium
        env:
          BASE_URL: ${{ inputs.target_url }}
          E2E_STRINGENCY: ${{ needs.preflight.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.preflight.outputs.stringency == 'relaxed' }}

      - name: Upload visual results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-results-${{ inputs.venture_name }}
          path: test-results/**/visual-results.json

  # LLM UX evaluation
  llm-ux:
    name: LLM UX Evaluation
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.target_reachable == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout EHG_Engineer (testing framework)
        uses: actions/checkout@v4
        with:
          repository: rickfelix/EHG_Engineer
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run LLM UX evaluation
        run: npx playwright test tests/e2e/ux-evaluation/ --project=chromium
        env:
          BASE_URL: ${{ inputs.target_url }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          E2E_STRINGENCY: ${{ needs.preflight.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.preflight.outputs.stringency != 'strict' }}

      - name: Upload UX evaluation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: llm-ux-results-${{ inputs.venture_name }}
          path: test-results/**/llm-ux-evaluation.json

  # Aggregate results and create summary
  summary:
    name: Results Summary
    runs-on: ubuntu-latest
    needs: [preflight, accessibility, chaos, visual, llm-ux]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Human-Like E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Venture:** ${{ inputs.venture_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stringency Level:** ${{ needs.preflight.outputs.stringency }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Reachable:** ${{ needs.preflight.outputs.target_reachable }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos/Resilience | ${{ needs.chaos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Visual/CLS | ${{ needs.visual.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LLM UX | ${{ needs.llm-ux.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check blocking failures
        if: needs.preflight.outputs.target_reachable == 'true'
        run: |
          STRINGENCY="${{ needs.preflight.outputs.stringency }}"

          # For strict stringency, all checks must pass
          if [ "$STRINGENCY" = "strict" ]; then
            if [ "${{ needs.accessibility.result }}" = "failure" ] ||
               [ "${{ needs.chaos.result }}" = "failure" ] ||
               [ "${{ needs.visual.result }}" = "failure" ] ||
               [ "${{ needs.llm-ux.result }}" = "failure" ]; then
              echo "Strict stringency: One or more checks failed"
              exit 1
            fi
          fi

          # For standard stringency, core checks must pass
          if [ "$STRINGENCY" = "standard" ]; then
            if [ "${{ needs.accessibility.result }}" = "failure" ] ||
               [ "${{ needs.chaos.result }}" = "failure" ]; then
              echo "Standard stringency: Core human-like checks failed"
              exit 1
            fi
          fi

          echo "All required checks passed for $STRINGENCY stringency"
