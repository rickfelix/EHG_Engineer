name: Human-Like E2E Tests

# Runs on every PR to main - comprehensive quality checks
on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      stringency:
        description: 'Override stringency level'
        required: false
        type: choice
        options:
          - auto
          - strict
          - standard
          - relaxed
        default: 'auto'

env:
  NODE_VERSION: '22'

jobs:
  # Calculate stringency and PR metrics
  setup:
    name: Setup & Stringency Detection
    runs-on: ubuntu-latest
    outputs:
      stringency: ${{ steps.stringency.outputs.level }}
      pr_lines: ${{ steps.metrics.outputs.lines }}
      is_critical_path: ${{ steps.paths.outputs.critical }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate PR metrics
        id: metrics
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LINES=$(git diff --numstat origin/main...HEAD | awk '{add+=$1; del+=$2} END {print add+del}')
          else
            LINES=0
          fi
          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "PR changes: $LINES lines"

      - name: Detect critical paths
        id: paths
        run: |
          CRITICAL_PATTERNS="checkout|auth|payment|onboarding|signup|login"
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || echo "")

          if echo "$CHANGED_FILES" | grep -qE "$CRITICAL_PATTERNS"; then
            echo "critical=true" >> $GITHUB_OUTPUT
            echo "Critical path changes detected"
          else
            echo "critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine stringency
        id: stringency
        run: |
          OVERRIDE="${{ github.event.inputs.stringency }}"
          if [ "$OVERRIDE" != "" ] && [ "$OVERRIDE" != "auto" ]; then
            echo "level=$OVERRIDE" >> $GITHUB_OUTPUT
            echo "Stringency: $OVERRIDE (manual override)"
            exit 0
          fi

          LINES=${{ steps.metrics.outputs.lines }}
          CRITICAL=${{ steps.paths.outputs.critical }}

          # Large PR (>500 lines) → strict
          if [ "$LINES" -gt 500 ]; then
            echo "level=strict" >> $GITHUB_OUTPUT
            echo "Stringency: strict (large PR: $LINES lines)"
            exit 0
          fi

          # Critical paths → strict
          if [ "$CRITICAL" = "true" ]; then
            echo "level=strict" >> $GITHUB_OUTPUT
            echo "Stringency: strict (critical path changes)"
            exit 0
          fi

          # Feature branch with small changes → relaxed
          BRANCH_NAME="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          if [[ "$BRANCH_NAME" == feat/* ]] && [ "$LINES" -lt 100 ]; then
            echo "level=relaxed" >> $GITHUB_OUTPUT
            echo "Stringency: relaxed (small feature branch)"
            exit 0
          fi

          # Default
          echo "level=standard" >> $GITHUB_OUTPUT
          echo "Stringency: standard (default)"

  # Core E2E tests with Playwright
  e2e-core:
    name: Core E2E Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npx playwright test --project=chromium
        env:
          E2E_STRINGENCY: ${{ needs.setup.outputs.stringency }}
          PR_LINES_CHANGED: ${{ needs.setup.outputs.pr_lines }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            playwright-report/
            test-results/

  # Accessibility checks with axe-core
  accessibility:
    name: Accessibility (axe-core)
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run accessibility tests
        run: npx playwright test tests/e2e/accessibility/ --project=chromium
        env:
          A11Y_STRINGENCY: ${{ needs.setup.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.setup.outputs.stringency == 'relaxed' }}

      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: test-results/**/accessibility-results.json

  # Chaos/resilience testing
  chaos:
    name: Chaos & Resilience
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run chaos tests
        run: npx playwright test tests/e2e/resilience/ --project=chromium
        env:
          E2E_STRINGENCY: ${{ needs.setup.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.setup.outputs.stringency == 'relaxed' }}

      - name: Upload chaos results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-results
          path: test-results/**/chaos-results.json

  # LLM UX evaluation (GPT-5.2)
  llm-ux:
    name: LLM UX Evaluation
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    # Only run on PRs to save costs, or when explicitly triggered
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run LLM UX evaluation
        run: npx playwright test tests/e2e/ux-evaluation/ --project=chromium
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          E2E_STRINGENCY: ${{ needs.setup.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.setup.outputs.stringency != 'strict' }}

      - name: Upload UX evaluation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: llm-ux-results
          path: test-results/**/llm-ux-evaluation.json

  # Visual regression (CLS)
  visual:
    name: Visual & CLS
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual tests
        run: npx playwright test tests/e2e/visual/ --project=chromium
        env:
          E2E_STRINGENCY: ${{ needs.setup.outputs.stringency }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true
        continue-on-error: ${{ needs.setup.outputs.stringency == 'relaxed' }}

      - name: Upload visual results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-results
          path: test-results/**/visual-results.json

  # Aggregate results and create summary
  summary:
    name: Results Summary
    runs-on: ubuntu-latest
    needs: [setup, e2e-core, accessibility, chaos, llm-ux, visual]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create summary
        run: |
          echo "## Human-Like E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stringency Level:** ${{ needs.setup.outputs.stringency }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR Size:** ${{ needs.setup.outputs.pr_lines }} lines" >> $GITHUB_STEP_SUMMARY
          echo "**Critical Paths:** ${{ needs.setup.outputs.is_critical_path }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Core E2E | ${{ needs.e2e-core.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos/Resilience | ${{ needs.chaos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LLM UX | ${{ needs.llm-ux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Visual/CLS | ${{ needs.visual.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check blocking failures
        run: |
          STRINGENCY="${{ needs.setup.outputs.stringency }}"

          # Core E2E always blocks
          if [ "${{ needs.e2e-core.result }}" = "failure" ]; then
            echo "Core E2E tests failed - blocking"
            exit 1
          fi

          # For strict stringency, all checks must pass
          if [ "$STRINGENCY" = "strict" ]; then
            if [ "${{ needs.accessibility.result }}" = "failure" ] ||
               [ "${{ needs.chaos.result }}" = "failure" ] ||
               [ "${{ needs.visual.result }}" = "failure" ] ||
               [ "${{ needs.llm-ux.result }}" = "failure" ]; then
              echo "Strict stringency: One or more checks failed"
              exit 1
            fi
          fi

          # For standard stringency, core checks must pass
          if [ "$STRINGENCY" = "standard" ]; then
            if [ "${{ needs.accessibility.result }}" = "failure" ] ||
               [ "${{ needs.chaos.result }}" = "failure" ]; then
              echo "Standard stringency: Core human-like checks failed"
              exit 1
            fi
          fi

          echo "All required checks passed for $STRINGENCY stringency"
