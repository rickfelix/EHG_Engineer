name: Lovable Import Checklist

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '**/*.js'
      - '**/*.jsx'

jobs:
  check-lovable-imports:
    name: Check for Lovable Imports
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Lovable-generated code
        id: check-lovable
        run: |
          # Check if PR contains Lovable-generated code patterns
          git diff origin/${{ github.base_ref }}..HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx' > changes.diff

          # Look for Lovable markers:
          # 1. Comments mentioning "Lovable" or "lovable.dev"
          # 2. Lovable-specific file patterns
          # 3. Imports from @lovable/* packages
          LOVABLE_FOUND=false

          if grep -i "lovable" changes.diff > /dev/null 2>&1; then
            echo "Found Lovable reference in code"
            LOVABLE_FOUND=true
          fi

          if grep -E "@lovable/|from ['\"]lovable" changes.diff > /dev/null 2>&1; then
            echo "Found Lovable imports"
            LOVABLE_FOUND=true
          fi

          echo "lovable_found=$LOVABLE_FOUND" >> $GITHUB_OUTPUT

      - name: Comment with Lovable checklist
        if: steps.check-lovable.outputs.lovable_found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const issue_number = context.issue.number;
            const repo = context.repo.owner;
            const repoName = context.repo.repo;

            // Check if checklist comment already exists
            const comments = await github.rest.issues.listComments({
              owner: repo,
              repo: repoName,
              issue_number: issue_number,
            });

            const checklistExists = comments.data.some(comment =>
              comment.body.includes('ðŸŽ¨ Lovable Import Checklist')
            );

            if (checklistExists) {
              console.log('Lovable checklist already exists, skipping...');
              return;
            }

            // Post checklist comment - using template literal to avoid YAML issues
            const body = [
              '## ðŸŽ¨ Lovable Import Checklist',
              '',
              '**Lovable-generated code detected in this PR.** Please verify the following handoff requirements per [Stage 21 SOP](https://github.com/' + repo + '/' + repoName + '/blob/main/docs/workflow/sop/21-final-pre-flight-check.md#213-lovable-handoff-protocol):',
              '',
              '### ðŸ“‹ Pre-Merge Validation',
              '- [ ] **GitHub URL documented**: Lovable-generated repo URL recorded in EHG',
              '- [ ] **PRD backfill complete**: PRD created/updated to reflect imported code',
              '- [ ] **Code review passed**: Standard review process completed',
              '- [ ] **Tests added**: Unit and/or E2E tests included for new components',
              '- [ ] **Documentation updated**: README or component docs reflect new functionality',
              '',
              '### ðŸ”„ Lovable â†’ EHG Handoff (Manual by Design)',
              '> This handoff is **intentionally manual** to preserve Chairman oversight.',
              '',
              '- [ ] Chairman initiated build in Lovable',
              '- [ ] Lovable generated initial repo',
              '- [ ] GitHub URL pasted into EHG system',
              '- [ ] EHG provided/refined PRDs back to Lovable',
              '',
              '### ðŸ“Š Post-Merge Actions',
              '- [ ] Update Stage 21 metrics (lovable_build_success_rate, handoff_time_minutes)',
              '- [ ] Document any integration issues in `docs/workflow/sop/21-final-pre-flight-check.md`',
              '',
              '---',
              '',
              '**Note**: If this PR does not contain Lovable-generated code, this checklist can be ignored (false positive detection).',
              '',
              '*Generated by Lovable Import Checklist workflow*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: repo,
              repo: repoName,
              issue_number: issue_number,
              body: body
            });

      - name: No Lovable imports found
        if: steps.check-lovable.outputs.lovable_found == 'false'
        run: |
          echo "âœ… No Lovable-generated code detected in this PR"
