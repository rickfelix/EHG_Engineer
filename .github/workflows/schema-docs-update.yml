name: Update Schema Documentation

# Automatically regenerate schema documentation when database migrations change
# or on a weekly schedule to catch any drift

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'database/migrations/**/*.sql'
      - 'supabase/migrations/**/*.sql'

  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'

  workflow_dispatch:
    inputs:
      target:
        description: 'Which database to document'
        required: true
        default: 'both'
        type: choice
        options:
          - engineer
          - app
          - both

jobs:
  update-schema-docs:
    name: Regenerate Schema Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating PRs
      pull-requests: write  # Required for creating PRs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper commit

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set up environment variables
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_POOLER_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "Environment variables configured"
          echo "SUPABASE_URL=${SUPABASE_URL}" >> .env
          echo "SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env
          echo "SUPABASE_POOLER_URL=${SUPABASE_POOLER_URL}" >> .env
          echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}" >> .env

      - name: Generate Engineer database schema docs
        if: github.event.inputs.target == 'engineer' || github.event.inputs.target == 'both' || github.event.inputs.target == ''
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_POOLER_URL: ${{ secrets.DATABASE_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
        run: npm run schema:docs:engineer
        continue-on-error: false

      - name: Generate EHG app database schema docs
        if: github.event.inputs.target == 'app' || github.event.inputs.target == 'both' || github.event.inputs.target == ''
        env:
          SUPABASE_URL: ${{ secrets.EHG_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.EHG_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.EHG_SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_POOLER_URL: ${{ secrets.EHG_POOLER_URL }}
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
        run: npm run schema:docs:app
        continue-on-error: true  # EHG app might not be configured yet

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain docs/reference/schema/) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Schema documentation has changes"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to schema documentation"
          fi

      - name: Create Pull Request for schema changes
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs(schema): Auto-update schema documentation

            Auto-generated schema documentation update triggered by:
            - Event: ${{ github.event_name }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}

            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          branch: automated/schema-docs-update
          delete-branch: true
          title: "docs(schema): Auto-update schema documentation"
          body: |
            ## Summary
            Automated schema documentation regeneration.

            ### Triggered by
            - **Event**: ${{ github.event_name }}
            - **Target**: ${{ github.event.inputs.target || 'both' }}
            - **Commit**: ${{ github.sha }}

            ### Changes
            This PR updates the schema documentation in `docs/reference/schema/` to reflect the current database structure.

            ---
            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          labels: |
            automated
            documentation
          add-paths: |
            docs/reference/schema/**

      - name: Log governance event
        if: steps.check_changes.outputs.changes == 'true' && steps.create_pr.outputs.pull-request-number
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Log the automated schema update for governance transparency
          node scripts/log-governance-bypass.js \
            --category WORKFLOW_CHECK \
            --control "schema-docs-auto-update" \
            --reason "Automated CI/CD schema documentation update via PR #${{ steps.create_pr.outputs.pull-request-number }}" \
            --changed-by "github-actions[bot]" \
            --severity LOW \
            --pr-number "${{ steps.create_pr.outputs.pull-request-number }}" \
            --context "{\"workflow\": \"schema-docs-update.yml\", \"event\": \"${{ github.event_name }}\", \"branch\": \"${{ github.ref_name }}\", \"pr_url\": \"${{ steps.create_pr.outputs.pull-request-url }}\"}" \
            || echo "Warning: Failed to log governance event (non-blocking)"

      - name: Auto-merge PR
        if: steps.check_changes.outputs.changes == 'true' && steps.create_pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Enable auto-merge for the PR (will merge when checks pass)
          gh pr merge ${{ steps.create_pr.outputs.pull-request-number }} \
            --auto --squash \
            --delete-branch \
            || echo "Warning: Could not enable auto-merge (may require admin)"

      - name: Create summary
        if: always()
        run: |
          echo "## Schema Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]]; then
            if [[ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]]; then
              echo "âœ… Schema documentation PR created: #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ”— [View PR](${{ steps.create_pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Changes detected but PR creation may have failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ No changes to schema documentation (already up-to-date)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggered by" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "- Migration files changed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "- Weekly scheduled run" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
          fi

