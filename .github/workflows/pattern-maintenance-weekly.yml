name: Pattern Maintenance Weekly

on:
  schedule:
    # Run every Sunday at 6 AM UTC (before Monday work starts)
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  issues: write

jobs:
  pattern-maintenance:
    name: Run Pattern Maintenance
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Pattern Maintenance
        id: maintenance
        run: |
          # Run maintenance and capture output
          npm run pattern:maintenance 2>&1 | tee maintenance-output.txt

          # Extract stats from output
          echo "## Pattern Maintenance Report" > maintenance-report.md
          echo "" >> maintenance-report.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> maintenance-report.md
          echo "" >> maintenance-report.md

          # Extract key metrics
          if grep -q "Patterns updated:" maintenance-output.txt; then
            echo "### Statistics" >> maintenance-report.md
            grep -E "(Active patterns|Patterns updated|New mappings|New triggers)" maintenance-output.txt >> maintenance-report.md
          fi

          echo "" >> maintenance-report.md
          echo "### Full Output" >> maintenance-report.md
          echo "\`\`\`" >> maintenance-report.md
          cat maintenance-output.txt >> maintenance-report.md
          echo "\`\`\`" >> maintenance-report.md

      - name: Check for stale/obsolete patterns
        id: stale_check
        run: |
          # Run staleness detection in dry-run to count
          npm run pattern:stale:dry 2>&1 | tee stale-output.txt

          # Check for patterns needing attention
          DECREASING=$(grep -c "MARK AS DECREASING" stale-output.txt || echo "0")
          OBSOLETE=$(grep -c "MARK AS OBSOLETE" stale-output.txt || echo "0")

          echo "decreasing_count=$DECREASING" >> $GITHUB_OUTPUT
          echo "obsolete_count=$OBSOLETE" >> $GITHUB_OUTPUT

          if [ "$DECREASING" -gt "0" ] || [ "$OBSOLETE" -gt "0" ]; then
            echo "STALE_DETECTED=true" >> $GITHUB_ENV
          fi

      - name: Regenerate CLAUDE.md files
        run: npm run leo:generate

      - name: Commit updated CLAUDE files if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check for changes
          if git diff --quiet CLAUDE*.md; then
            echo "No changes to CLAUDE files"
          else
            git add CLAUDE*.md
            git commit -m "chore(patterns): Weekly CLAUDE.md regeneration with latest patterns

            Auto-generated by pattern-maintenance-weekly workflow

            ðŸ¤– Generated with GitHub Actions"
            git push
            echo "CLAUDE_UPDATED=true" >> $GITHUB_ENV
          fi

      - name: Upload maintenance report
        uses: actions/upload-artifact@v4
        with:
          name: pattern-maintenance-report-${{ github.run_number }}
          path: |
            maintenance-output.txt
            maintenance-report.md
            stale-output.txt
          retention-days: 30

      - name: Create issue if stale patterns detected
        if: env.STALE_DETECTED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const decreasing = '${{ steps.stale_check.outputs.decreasing_count }}';
            const obsolete = '${{ steps.stale_check.outputs.obsolete_count }}';

            const issueBody = [
              '## Pattern Lifecycle Alert',
              '',
              `**Decreasing (90+ days):** ${decreasing} patterns`,
              `**Obsolete (180+ days):** ${obsolete} patterns`,
              '',
              '### What This Means',
              '',
              '- **Decreasing**: Patterns not seen in 90+ days - may indicate root cause was fixed',
              '- **Obsolete**: Patterns not seen in 180+ days - should be reviewed for resolution',
              '',
              '### Recommended Actions',
              '',
              '1. Review the patterns: `npm run pattern:stale`',
              '2. If root cause fixed, resolve: `npm run pattern:resolve PAT-XXX "Resolution notes"`',
              '3. If still relevant, update occurrence manually',
              '',
              '### Commands',
              '',
              '```bash',
              '# View stale patterns',
              'npm run pattern:stale:dry',
              '',
              '# Apply staleness updates',
              'npm run pattern:stale',
              '',
              '# Resolve a pattern',
              'npm run pattern:resolve PAT-XXX "Fixed by implementing XYZ"',
              '```',
              '',
              `ðŸ”— **Workflow Run:** [View Details](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '',
              '---',
              '**Auto-generated by pattern-maintenance-weekly workflow**'
            ].join('\n');

            // Check for existing open issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,patterns,maintenance',
              per_page: 5
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              const existingIssue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: [
                  `## Weekly Update: ${new Date().toISOString().split('T')[0]}`,
                  '',
                  `- Decreasing: ${decreasing} patterns`,
                  `- Obsolete: ${obsolete} patterns`,
                  '',
                  `ðŸ”— [Workflow Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
                ].join('\n')
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“‹ Pattern Maintenance: Stale Patterns Detected',
                body: issueBody,
                labels: ['automated', 'patterns', 'maintenance', 'tech-debt']
              });
              console.log('Created new pattern maintenance issue');
            }

      - name: Post summary
        if: always()
        run: |
          echo "## Pattern Maintenance Weekly Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f maintenance-report.md ]; then
            cat maintenance-report.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CLAUDE_UPDATED" == "true" ]; then
            echo "âœ… CLAUDE.md files regenerated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ CLAUDE.md files unchanged" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$STALE_DETECTED" == "true" ]; then
            echo "âš ï¸ Stale patterns detected - issue created/updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All patterns healthy" >> $GITHUB_STEP_SUMMARY
          fi
