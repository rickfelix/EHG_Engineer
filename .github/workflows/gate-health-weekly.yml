name: Gate Health Weekly

on:
  schedule:
    # Every Sunday at 7 AM UTC (same day as pattern-maintenance)
    - cron: '0 7 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes)'
        required: false
        default: 'false'
        type: boolean
      threshold:
        description: 'Custom pass rate threshold'
        required: false
        default: '70'
        type: string

jobs:
  gate-health-check:
    name: Gate Health Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Refresh gate health metrics
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "üîÑ Refreshing gate health materialized view..."
          node -e "
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(
              process.env.SUPABASE_URL,
              process.env.SUPABASE_SERVICE_ROLE_KEY
            );
            supabase.rpc('refresh_gate_health_metrics')
              .then(() => console.log('‚úÖ Metrics refreshed'))
              .catch(e => console.log('‚ö†Ô∏è Refresh skipped:', e.message));
          "

      - name: Run gate health check
        id: gate_health
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          FLAGS=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [ -n "${{ inputs.threshold }}" ] && [ "${{ inputs.threshold }}" != "70" ]; then
            FLAGS="$FLAGS --threshold=${{ inputs.threshold }}"
          fi

          echo "üè• Running gate health check with flags: $FLAGS"
          node scripts/gate-health-check.js $FLAGS

      - name: Regenerate CLAUDE.md with gate health
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "üìù Regenerating CLAUDE.md with gate health section..."
          npm run leo:generate || echo "‚ö†Ô∏è CLAUDE.md generation skipped"

      - name: Create GitHub Issue for failing gates
        if: steps.gate_health.outputs.alerts_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const alertsCount = '${{ steps.gate_health.outputs.alerts_count }}';
            const sdsCreated = '${{ steps.gate_health.outputs.sds_created }}';

            if (parseInt(alertsCount) > 0) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'gate-health,automated',
                state: 'open'
              });

              // Check if issue already exists this week
              const weekStart = new Date();
              weekStart.setDate(weekStart.getDate() - weekStart.getDay());
              const recentIssue = existingIssues.data.find(issue =>
                new Date(issue.created_at) >= weekStart
              );

              if (!recentIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üè• Gate Health Alert: ${alertsCount} gate(s) below threshold`,
                  body: `## Weekly Gate Health Report\n\n` +
                    `**Date:** ${new Date().toISOString().split('T')[0]}\n\n` +
                    `### Summary\n` +
                    `- **Gates below threshold:** ${alertsCount}\n` +
                    `- **SDs auto-created:** ${sdsCreated}\n\n` +
                    `### Action Required\n` +
                    `Review the auto-created SDs and address gate failures.\n\n` +
                    `Run \`npm run gate:health\` locally for details.\n\n` +
                    `---\n` +
                    `_Auto-generated by gate-health-weekly.yml_`,
                  labels: ['gate-health', 'automated', 'priority:high']
                });
                console.log('Created gate health issue');
              } else {
                console.log('Gate health issue already exists for this week');
              }
            }

      - name: Commit CLAUDE.md changes
        if: success() && inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet CLAUDE.md CLAUDE_CORE.md 2>/dev/null; then
            echo "No CLAUDE.md changes to commit"
          else
            git add CLAUDE.md CLAUDE_CORE.md || true
            git commit -m "chore: Update CLAUDE.md with gate health metrics

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: GitHub Actions <noreply@github.com>" || echo "Nothing to commit"
            git push || echo "Push skipped"
          fi

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: gate-health-check
    if: failure()

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Gate Health Weekly workflow failed',
              body: `The gate-health-weekly workflow failed.\n\n` +
                `**Run:** ${context.runId}\n` +
                `**Triggered by:** ${context.eventName}\n\n` +
                `Please investigate the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
              labels: ['gate-health', 'bug', 'automated']
            });
