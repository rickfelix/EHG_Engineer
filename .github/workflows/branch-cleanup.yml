name: Branch Cleanup

on:
  schedule:
    - cron: '0 6 * * 0'  # Every Sunday 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-merged-branches:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete merged report branches
        run: |
          echo "## Cleaning Up Merged Report Branches" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Delete housekeeping report branches that are merged
          DELETED=0
          for branch in $(git branch -r --merged origin/main | grep 'origin/reports/housekeeping-week-' | sed 's/origin\///'); do
            echo "Deleting merged branch: $branch"
            git push origin --delete "$branch" 2>/dev/null && ((DELETED++)) || true
          done

          echo "Deleted $DELETED merged report branches." >> $GITHUB_STEP_SUMMARY

      - name: List stale branches
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Stale Branches (no commits in 30+ days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | Last Commit | Days Old |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|----------|" >> $GITHUB_STEP_SUMMARY

          CUTOFF=$(date -d '30 days ago' +%s)
          STALE_COUNT=0

          for branch in $(git branch -r | grep -v HEAD | grep -v 'origin/main$'); do
            LAST_COMMIT=$(git log -1 --format=%ct "$branch" 2>/dev/null || echo 0)
            if [ "$LAST_COMMIT" -lt "$CUTOFF" ] && [ "$LAST_COMMIT" -gt 0 ]; then
              BRANCH_NAME=$(echo $branch | sed 's/origin\///')
              LAST_DATE=$(git log -1 --format=%ci "$branch" 2>/dev/null | cut -d' ' -f1)
              DAYS_OLD=$(( ($(date +%s) - $LAST_COMMIT) / 86400 ))
              echo "| \`$BRANCH_NAME\` | $LAST_DATE | $DAYS_OLD |" >> $GITHUB_STEP_SUMMARY
              ((STALE_COUNT++))
            fi
          done

          if [ "$STALE_COUNT" -eq 0 ]; then
            echo "*No stale branches found.*" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**$STALE_COUNT stale branches** may need review or deletion." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Count open PRs by age
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const now = new Date();
            const summary = {
              fresh: 0,      // < 7 days
              aging: 0,      // 7-14 days
              stale: 0,      // 14-30 days
              abandoned: 0   // > 30 days
            };

            for (const pr of prs.data) {
              const created = new Date(pr.created_at);
              const daysOld = Math.floor((now - created) / (1000 * 60 * 60 * 24));

              if (daysOld < 7) summary.fresh++;
              else if (daysOld < 14) summary.aging++;
              else if (daysOld < 30) summary.stale++;
              else summary.abandoned++;
            }

            const summaryText = `
## Open PR Age Distribution

| Age | Count |
|-----|-------|
| Fresh (< 7 days) | ${summary.fresh} |
| Aging (7-14 days) | ${summary.aging} |
| Stale (14-30 days) | ${summary.stale} |
| Abandoned (> 30 days) | ${summary.abandoned} |

**Total open PRs:** ${prs.data.length}
`;
            core.summary.addRaw(summaryText);
            await core.summary.write();
