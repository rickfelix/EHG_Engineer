/**
 * LEO v4.4 Global Teardown
 *
 * Backup mechanism for evidence pack generation and trace cleanup.
 * Runs after all Playwright tests complete, ensuring artifacts are
 * processed even if the reporter fails.
 *
 * Part of LEO Protocol v4.4 - Unified Test Evidence Architecture
 *
 * This file is invoked via playwright.config.js:
 *   globalTeardown: './tests/e2e/setup/global-teardown.js'
 *
 * @module global-teardown
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.join(__dirname, '..', '..', '..');

/**
 * Global teardown function
 *
 * Checks if evidence pack was already generated by the reporter.
 * If not, generates it as a backup. Also performs cleanup if not done.
 */
async function globalTeardown() {
  const testResultsDir = path.join(PROJECT_ROOT, 'test-results');
  const manifestPath = path.join(testResultsDir, 'evidence-pack-manifest.json');

  // Check if reporter already generated evidence pack
  const manifestExists = fs.existsSync(manifestPath);

  // Check if evidence pack generation is enabled
  const evidencePackEnabled = process.env.LEO_EVIDENCE_PACK === 'true';
  const cleanupEnabled = process.env.LEO_CLEANUP_TRACES === 'true';

  // Skip if features not enabled
  if (!evidencePackEnabled && !cleanupEnabled) {
    console.log('[LEO Teardown] Evidence pack and cleanup disabled, skipping');
    return;
  }

  console.log('[LEO Teardown] Running global teardown...');

  // Generate evidence pack if reporter didn't (backup)
  if (evidencePackEnabled && !manifestExists) {
    console.log('[LEO Teardown] Reporter did not generate evidence pack, generating as backup...');
    try {
      const { generateManifest, saveManifest } = await import('../../../lib/evidence/manifest-generator.js');

      const manifest = generateManifest(testResultsDir, {
        sdId: process.env.SD_ID,
        triggeredBy: 'GLOBAL_TEARDOWN'
      });

      saveManifest(manifest, manifestPath);
      console.log(`[LEO Teardown] Backup evidence pack generated: ${manifest.pack_id}`);
    } catch (error) {
      console.error('[LEO Teardown] Failed to generate backup evidence pack:', error.message);
    }
  } else if (manifestExists) {
    console.log('[LEO Teardown] Evidence pack already exists, skipping backup generation');
  }

  // Perform cleanup as backup if needed
  if (cleanupEnabled) {
    // Check if cleanup was already performed by checking stats in manifest
    let cleanupNeeded = true;

    if (manifestExists) {
      try {
        const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
        // If manifest has cleanup_performed flag, skip
        if (manifest.metadata?.cleanup_performed) {
          cleanupNeeded = false;
          console.log('[LEO Teardown] Cleanup already performed by reporter, skipping');
        }
      } catch {
        // Continue with cleanup
      }
    }

    if (cleanupNeeded) {
      console.log('[LEO Teardown] Performing backup trace cleanup...');
      try {
        const { cleanupPassingTraces, formatBytes } = await import('../../../lib/evidence/trace-cleanup.js');

        const stats = cleanupPassingTraces({
          testResultsDir,
          maxAgeDays: parseInt(process.env.LEO_CLEANUP_MAX_AGE_DAYS || '7', 10),
          dryRun: false,
          verbose: process.env.LEO_VERBOSE === 'true',
          cleanupPassing: true
        });

        console.log('[LEO Teardown] Cleanup complete:');
        console.log('   Traces deleted: ' + stats.tracesDeleted);
        console.log('   Space freed: ' + formatBytes(stats.bytesFreed));
      } catch (error) {
        console.error('[LEO Teardown] Failed to perform cleanup:', error.message);
      }
    }
  }

  console.log('[LEO Teardown] Global teardown complete');
}

export default globalTeardown;
