# Vision Governance Apply Operations Guide

## Overview
The Vision Governance Apply job creates draft Strategic Directives (SDs) and Product Requirements (PRDs) in EHG_Engineering based on curated manifest CSVs. It operates with multiple safety guards and supports dry-run mode for safe preview.

## Safety Features
- **Staging only**: Uses `PG*_STAGING` secrets
- **Double guards required**: `STAGING_WRITE_OK=1` AND `APPLY_VISION_GOV=1`
- **DRY_RUN default = 1**: No commits by default
- **Two-app boundary**: Writes only to EHG_Engineering tables (`strategic_directives_v2`, `product_requirements_v2`)
- **Idempotent**: Keyed on `sd_key` (SD) and `(sd_id, title)` (PRD) to avoid duplicates
- **Transactional**: All changes are atomic - either all succeed or none are applied

## Input Files
Place curated manifest CSVs in `ops/inbox/`:
- `vision_sd_manifest.csv` - Strategic Directives to create
- `vision_prd_manifest.csv` - Product Requirements to create

### SD Manifest Columns
- `action`: create|ignore
- `venture_id`: UUID
- `stage`: Stage name
- `urgency`: high|medium|low
- `sd_id`: Leave blank (will be generated)
- `sd_key`: Leave blank (will be derived) or provide custom
- `title`: SD title (required)
- `owner`: Owner name (required)
- `decision_log_ref`: Decision log reference (required)
- `evidence_ref`: Evidence reference (required)
- `rationale`: Reason for creation

### PRD Manifest Columns
- `action`: create|ignore
- `venture_id`: UUID
- `stage`: Stage name
- `urgency`: high|medium|low
- `prd_id`: Leave blank (will be generated)
- `sd_id`: Link to SD (required)
- `title`: PRD title
- `priority`: P0-P3 or High/Medium/Low
- `completeness_score`: 0-100
- `risk_rating`: low|medium|high
- `acceptance_criteria_json`: JSON array string
- `notes`: Additional notes

## How to Run

### Preview Run (DRY_RUN=1)
```bash
# Set up guards and dry-run mode
gh variable set STAGING_WRITE_OK -b "1"
gh variable set APPLY_VISION_GOV -b "1"
gh variable set DRY_RUN -b "1"

# Run the workflow
gh workflow run "Vision Governance Apply (Staging)"

# Check results
gh run list --workflow="Vision Governance Apply (Staging)" --limit=1
```

### Commit Run (DRY_RUN=0)
```bash
# Enable actual commits
gh variable set DRY_RUN -b "0"

# Run the workflow
gh workflow run "Vision Governance Apply (Staging)"

# Check results
gh run list --workflow="Vision Governance Apply (Staging)" --limit=1
```

### Reset to Safe Defaults
```bash
# Remove guards and reset to dry-run
gh variable delete APPLY_VISION_GOV
gh variable delete STAGING_WRITE_OK
gh variable set DRY_RUN -b "1"
```

## Output
The job produces `ops/checks/out/vision_apply_results.csv` with:
- `entity`: sd|prd
- `action`: create
- `status`: created|exists|would_create|error
- `sd_id`: UUID (if created)
- `sd_key`: Derived key (for SDs)
- `prd_id`: UUID (if created)
- `msg`: Status message

## Workflow Sequence
1. Copy manifest templates from Vision Alignment workflow artifacts
2. Edit to add required fields (owner, decision_log_ref, evidence_ref for SDs)
3. Place edited files in `ops/inbox/`
4. Run preview with DRY_RUN=1
5. Review `vision_apply_results.csv`
6. If satisfied, run with DRY_RUN=0 to commit

## Troubleshooting

### Common Issues
- **"SD manifest missing"**: Ensure `ops/inbox/vision_sd_manifest.csv` exists
- **"missing required fields"**: Check that owner, decision_log_ref, evidence_ref are filled
- **"missing sd_id"**: PRDs must have valid sd_id linking to an SD

### Rollback
To revert actual inserts, use normal database migration/ops procedures. The system maintains audit trails via RLS.

## User Story Apply Operations

### Overview
The Vision Stories Apply job creates user stories in either `eng_user_stories` table (if exists) or `sd_backlog_map` with `item_type='story'`. It targets ventures with low AC coverage and PRDs with contract gaps.

### Story Manifest Template
Generated by Vision Alignment workflow based on:
- Ventures with AC coverage < 50%
- PRDs with contract violations
- Template stories for common user journeys

### Story Manifest Columns
- `action`: create|ignore
- `venture_id`: UUID (optional)
- `sd_id`: Link to SD (optional)
- `prd_id`: Link to PRD (recommended)
- `title`: Story title (required)
- `priority`: P0-P3 or High/Medium/Low
- `status`: Story status (default: draft)
- `item_type`: Type (default: story)
- `acceptance_criteria_json`: JSON array of criteria
- `story_points`: Effort estimate (default: 3)
- `notes`: Additional context

### How to Run Stories Apply

#### Preview Run (DRY_RUN=1)
```bash
# Download template from Vision Alignment artifacts
# Edit and place in ops/inbox/vision_story_manifest.csv

# Set up guards and dry-run mode
gh variable set STAGING_WRITE_OK -b "1"
gh variable set APPLY_VISION_STORIES -b "1"
gh variable set DRY_RUN -b "1"

# Run the workflow
gh workflow run "Vision Stories Apply (Staging)"
```

#### Commit Run (DRY_RUN=0)
```bash
# Enable actual commits
gh variable set DRY_RUN -b "0"

# Run the workflow
gh workflow run "Vision Stories Apply (Staging)"
```

#### Reset Guards
```bash
gh variable delete APPLY_VISION_STORIES
gh variable delete STAGING_WRITE_OK
gh variable set DRY_RUN -b "1"
```

### Story Apply Output
- `vision_story_apply_results.csv`: Created/exists/would_create/error status
- `ac_coverage_delta.csv`: Shows AC coverage improvements per venture
- Target table detection: Automatically uses `eng_user_stories` if exists, otherwise `sd_backlog_map`

### Complete Vision Pipeline Sequence

1. **Analysis Phase**:
   - Run Vision Alignment workflow â†’ generates templates
   - Review `vision_scorecard.csv` for low-scoring ventures
   - Check `vision_gap_recommendations.csv` for priorities

2. **SD/PRD Creation**:
   - Download and edit `vision_sd_manifest_template.csv` and `vision_prd_manifest_template.csv`
   - Add required fields (owner, decision_log_ref, evidence_ref for SDs)
   - Place in `ops/inbox/`
   - Run Vision Governance Apply

3. **Story Creation**:
   - Download and edit `vision_story_manifest_template.csv`
   - Link stories to created SDs/PRDs via their IDs
   - Enhance acceptance criteria as needed
   - Place in `ops/inbox/`
   - Run Vision Stories Apply

4. **Verification**:
   - Check delta reports to see alignment improvements
   - Review AC coverage changes
   - Validate in staging database

## Future Enhancements
- PRD `sd_key` support (reference SDs by key instead of UUID)
- Automatic story generation from PRD acceptance criteria
- Promotion to production via existing workflows
- Story dependency mapping