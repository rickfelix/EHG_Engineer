/**
 * One-time script: Store DATABASE analysis for SD-EVA-FEAT-DFE-PRESENTATION-001
 * Run: node scripts/one-time/_store-dfe-db-analysis.cjs
 */
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');

async function main() {
  const sb = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
  const sdId = '5ad6f554-74ad-49cb-9afe-cc608973a8d0';

  const detailedAnalysis = [
    '# DATABASE Analysis: SD-EVA-FEAT-DFE-PRESENTATION-001',
    '## DFE Escalation Presentation: Context + Mitigations in Dashboard',
    '',
    '### Executive Summary',
    'This SD requires TARGETED database modifications to support DFE escalation presentation in the Chairman Dashboard. The existing schema (eva_orchestration_events + chairman_decisions) provides a solid foundation but has THREE critical gaps that must be resolved before implementation can proceed safely.',
    '',
    '### Analysis Scope',
    '- **Tables Analyzed**: eva_orchestration_events, chairman_decisions, ventures, issue_patterns',
    '- **Code Analyzed**: lib/eva/decision-filter-engine.js (DFE engine v1.0.0)',
    '- **PRD Sections**: FR-1 through FR-7, TR-1 through TR-3, System Architecture',
    '- **DESIGN Context**: Integrated (EscalationPanel, DFEContextAdapter, metadata storage pattern)',
    '',
    '---',
    '',
    '## CRITICAL FINDING 1: Missing metadata Column on chairman_decisions',
    '',
    '**Severity**: CRITICAL (blocks FR-1, FR-4, TR-2)',
    '',
    'The PRD specifies storing DFE escalation context in `chairman_decisions.metadata.dfe_context` and persisting mitigation actions as append-only entries in `chairman_decisions.metadata`. However, the chairman_decisions table has NO `metadata` column.',
    '',
    '**Current JSONB columns on chairman_decisions**:',
    '- risks_acknowledged (JSONB)',
    '- quick_fixes_applied (JSONB)',
    '- preference_snapshot (JSONB)',
    '- brief_data (JSONB)',
    '',
    '**Options**:',
    '1. **ADD metadata JSONB column** (RECOMMENDED): Add a general-purpose metadata column to chairman_decisions for DFE context, mitigation actions, and future extensibility. Aligns with PRD wording and DESIGN architecture.',
    '2. **Use brief_data for DFE context**: Repurpose the existing brief_data JSONB column to include dfe_context and mitigation_actions keys. Avoids migration but conflates data purposes.',
    '3. **Use risks_acknowledged for DFE context**: DFE escalations are risk-related, but this column has a different semantic (acknowledged risks vs active trigger context).',
    '',
    '**Recommendation**: Option 1. Add `metadata JSONB DEFAULT \'{}\'` column via migration. This matches the PRD specification exactly and maintains semantic clarity.',
    '',
    '**Migration Required**:',
    '```sql',
    'ALTER TABLE chairman_decisions ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT \'{}\';',
    'CREATE INDEX IF NOT EXISTS idx_chairman_decisions_metadata_dfe ON chairman_decisions USING gin ((metadata->\'dfe_context\'));',
    '```',
    '',
    '---',
    '',
    '## CRITICAL FINDING 2: DFE Trigger Type Mismatch (PRD vs Engine)',
    '',
    '**Severity**: HIGH (affects FR-2 data integrity and UI correctness)',
    '',
    'The PRD (FR-2) defines 6 trigger types:',
    '- financial_threshold, safety_concern, legal_risk, reputation_risk, resource_constraint, strategic_misalignment',
    '',
    'The actual DFE engine (lib/eva/decision-filter-engine.js) defines 6 DIFFERENT trigger types:',
    '- cost_threshold, new_tech_vendor, strategic_pivot, low_score, novel_pattern, constraint_drift',
    '',
    'These are completely different sets. The DFEContextAdapter MUST map between engine triggers and presentation triggers, OR the PRD must be updated to reflect the actual engine trigger types.',
    '',
    '**Impact on Database**:',
    '- eva_orchestration_events.event_data JSONB stores trigger arrays from the DFE engine',
    '- If UI expects PRD trigger types but DB stores engine trigger types, queries will return mismatched data',
    '- The DFEContextAdapter must perform mapping, but the database schema should document the canonical trigger types',
    '',
    '**Recommendation**: The adapter layer handles mapping. Database stores engine-native trigger types (cost_threshold, etc.). Document the mapping in event_data schema. No schema change needed, but this MUST be accounted for in implementation.',
    '',
    '---',
    '',
    '## CRITICAL FINDING 3: PRD References eva_event_log but Table is eva_orchestration_events',
    '',
    '**Severity**: MEDIUM (naming inconsistency, not a blocker but causes confusion)',
    '',
    'The PRD system architecture references `eva_event_log` with `event_type=\'dfe.escalation\'`. The actual table is `eva_orchestration_events` with `event_type=\'dfe_triggered\'` or `event_type=\'escalation\'`.',
    '',
    '**Impact**:',
    '- Code using PRD-specified table name will fail',
    '- Event type format differs (dot-separated vs underscore)',
    '- CHECK constraint on eva_orchestration_events.event_type does NOT include \'dfe.escalation\'',
    '',
    '**Recommendation**: Implementation must use `eva_orchestration_events` table name and `event_type IN (\'dfe_triggered\', \'escalation\')` filter. No schema change needed.',
    '',
    '---',
    '',
    '## Schema Sufficiency Analysis',
    '',
    '### eva_orchestration_events - SUFFICIENT with notes',
    '',
    '| Aspect | Status | Notes |',
    '|--------|--------|-------|',
    '| event_type coverage | PASS | dfe_triggered and escalation cover DFE events |',
    '| event_data JSONB | PASS | Can store trigger arrays, severity, source data |',
    '| venture_id FK | PASS | Links to ventures for context |',
    '| chairman_flagged | PASS | Marks events needing Chairman attention |',
    '| Indexes | PASS | created_at DESC, event_type, venture_id, chairman_flagged all indexed |',
    '| RLS | PASS | authenticated can SELECT, service_role can ALL |',
    '| Realtime | PASS | Added to supabase_realtime publication |',
    '',
    '**event_data JSONB Schema Recommendation for DFE events**:',
    '```json',
    '{',
    '  "dfe_version": "1.0.0",',
    '  "venture_name": "string",',
    '  "stage": "string",',
    '  "auto_proceed": false,',
    '  "recommendation": "PRESENT_TO_CHAIRMAN",',
    '  "triggers": [',
    '    {',
    '      "type": "cost_threshold",',
    '      "severity": "HIGH",',
    '      "message": "Cost exceeds threshold",',
    '      "details": { "cost": 15000, "threshold": 10000 }',
    '    }',
    '  ],',
    '  "source_inputs": {',
    '    "cost": 15000,',
    '    "technologies": ["new-framework"],',
    '    "score": 5',
    '  }',
    '}',
    '```',
    '',
    '### chairman_decisions - REQUIRES MIGRATION',
    '',
    '| Aspect | Status | Notes |',
    '|--------|--------|-------|',
    '| metadata column | FAIL | Column does not exist, required by PRD |',
    '| brief_data JSONB | PASS | Exists but wrong semantic for DFE context |',
    '| venture_id FK | PASS | Links to ventures |',
    '| status workflow | PASS | pending/approved/rejected/cancelled |',
    '| Indexes | PASS | venture, stage, status, created_at all indexed |',
    '| RLS | PASS | fn_is_chairman() for all CRUD |',
    '| Unique pending | PASS | One pending decision per venture+stage |',
    '',
    '### issue_patterns - SUFFICIENT (read-only)',
    '',
    'The EscalationPanel queries issue_patterns for similar historical patterns. This table is already RLS-accessible for SELECT by authenticated users. No changes needed.',
    '',
    '---',
    '',
    '## Migration Plan',
    '',
    '### Required Migration: Add metadata column to chairman_decisions',
    '',
    '```sql',
    '-- Migration: Add metadata JSONB to chairman_decisions for DFE context storage',
    '-- SD: SD-EVA-FEAT-DFE-PRESENTATION-001',
    '',
    '-- Step 1: Add metadata column',
    'ALTER TABLE chairman_decisions',
    '  ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT \'{}\';',
    '',
    '-- Step 2: GIN index for JSONB queries on dfe_context',
    'CREATE INDEX IF NOT EXISTS idx_chairman_decisions_metadata_dfe',
    '  ON chairman_decisions USING gin ((metadata->\'dfe_context\'));',
    '',
    '-- Step 3: GIN index for mitigation_actions queries',
    'CREATE INDEX IF NOT EXISTS idx_chairman_decisions_metadata_mitigations',
    '  ON chairman_decisions USING gin ((metadata->\'mitigation_actions\'));',
    '',
    '-- Step 4: Comment',
    'COMMENT ON COLUMN chairman_decisions.metadata IS \'General-purpose metadata JSONB. Used for DFE escalation context (dfe_context key), mitigation actions (mitigation_actions key), and future extensibility.\';',
    '```',
    '',
    '### No Migration Needed For:',
    '- eva_orchestration_events (already has dfe_triggered/escalation event types)',
    '- issue_patterns (read-only access, existing schema sufficient)',
    '- ventures (existing FK relationships sufficient)',
    '',
    '---',
    '',
    '## RLS Policy Assessment',
    '',
    '| Table | Operation | Policy | Sufficient? |',
    '|-------|-----------|--------|-------------|',
    '| eva_orchestration_events | SELECT | authenticated USING true | YES - Dashboard reads all events |',
    '| eva_orchestration_events | INSERT | service_role only | YES - Events written by backend |',
    '| chairman_decisions | SELECT | fn_is_chairman() | YES - Only Chairman sees decisions |',
    '| chairman_decisions | UPDATE | fn_is_chairman() | YES - Only Chairman can act on mitigations |',
    '| issue_patterns | SELECT | Existing policy | YES - Read-only for similar patterns |',
    '',
    'No RLS changes required. The existing policies correctly scope access for the DFE presentation use case.',
    '',
    '---',
    '',
    '## Index Assessment',
    '',
    'All query patterns identified in the PRD are covered by existing indexes:',
    '',
    '1. **Get DFE events for a venture by time** -> idx_eva_orch_events_venture + idx_eva_orch_events_created',
    '2. **Get flagged events for Chairman feed** -> idx_eva_orch_events_flagged (partial: chairman_flagged=true)',
    '3. **Get decision by venture and stage** -> idx_chairman_decisions_unique_pending',
    '4. **Get recent decisions** -> idx_chairman_decisions_created',
    '',
    'The new metadata GIN indexes will support:',
    '5. **Get decisions with DFE context** -> idx_chairman_decisions_metadata_dfe',
    '6. **Get decisions with mitigation actions** -> idx_chairman_decisions_metadata_mitigations',
    '',
    '---',
    '',
    '## TypeScript Interface Alignment Notes',
    '',
    'The DFEContextAdapter must define interfaces matching the database JSONB schemas:',
    '',
    '1. **DFEContext** (stored in chairman_decisions.metadata.dfe_context):',
    '   - Maps from DFE engine output (auto_proceed, triggers[], recommendation)',
    '   - Trigger types are engine-native (cost_threshold, not financial_threshold)',
    '',
    '2. **MitigationAction** (stored in chairman_decisions.metadata.mitigation_actions[]):',
    '   - action_id: string (UUID)',
    '   - trigger_type: string',
    '   - action: accept | reject',
    '   - rationale?: string',
    '   - acted_at: ISO timestamp',
    '   - acted_by: string (chairman user ID)',
    '',
    '3. **EscalationEvent** (from eva_orchestration_events.event_data):',
    '   - Uses the JSONB schema documented above',
    '',
    '---',
    '',
    '## Risk Assessment',
    '',
    '| Risk | Likelihood | Impact | Mitigation |',
    '|------|-----------|--------|------------|',
    '| metadata column migration fails | LOW | HIGH | IF NOT EXISTS is idempotent; rollback is DROP COLUMN |',
    '| DFE trigger type confusion in UI | MEDIUM | MEDIUM | Document mapping in DFEContextAdapter; add mapping tests |',
    '| eva_event_log naming confusion | LOW | LOW | Use eva_orchestration_events consistently in code |',
    '| JSONB structure drift over time | MEDIUM | MEDIUM | Version field in event_data; adapter handles multiple versions |',
    '| RLS blocks Chairman reads | LOW | HIGH | fn_is_chairman() already tested; no changes needed |',
    '',
    '---',
    '',
    '## Summary of Required Actions',
    '',
    '1. **MIGRATION REQUIRED**: Add `metadata JSONB` column to `chairman_decisions` with GIN indexes',
    '2. **NO MIGRATION**: eva_orchestration_events schema is sufficient',
    '3. **CODE NOTE**: Use `eva_orchestration_events` (not `eva_event_log` from PRD)',
    '4. **CODE NOTE**: DFE engine trigger types differ from PRD trigger types - adapter must map',
    '5. **NO RLS CHANGES**: Existing policies are sufficient',
    '6. **NO INDEX CHANGES**: Beyond the new metadata GIN indexes in the migration',
  ].join('\n');

  const criticalIssues = [
    'chairman_decisions table is MISSING the metadata JSONB column referenced by PRD (FR-1, FR-4, TR-2). Migration required to add metadata column before implementation can store DFE context or mitigation actions.',
    'PRD references table eva_event_log which does NOT EXIST. Actual table is eva_orchestration_events with different event_type values (dfe_triggered/escalation vs dfe.escalation).',
    'DFE trigger types in PRD (financial_threshold, safety_concern, legal_risk, reputation_risk, resource_constraint, strategic_misalignment) do NOT match actual DFE engine types (cost_threshold, new_tech_vendor, strategic_pivot, low_score, novel_pattern, constraint_drift). DFEContextAdapter must handle mapping.',
  ];

  const warnings = [
    'chairman_decisions table currently has 0 rows. Testing must use INSERT fixtures or seed data.',
    'eva_orchestration_events table currently has 0 rows. DFE integration code to write events does not yet exist.',
    'event_data JSONB schema for DFE events is not enforced by CHECK constraint. Recommend runtime validation in DFEContextAdapter with zod.',
    'Pattern PAT-DATA-REDUND-001 is relevant: if DFE context is stored in BOTH metadata JSONB and eva_orchestration_events.event_data, ensure single source of truth or clear read pattern.',
  ];

  const recommendations = [
    'Execute migration to add metadata JSONB column to chairman_decisions before starting UI implementation.',
    'Document canonical event_data JSONB schema for dfe_triggered events in migration file comments.',
    'Implement DFEContextAdapter with explicit trigger type mapping (engine types to presentation labels) and version-tolerant parsing.',
    'Add integration tests that INSERT realistic DFE events into eva_orchestration_events and verify EscalationPanel rendering.',
    'Consider adding a CHECK constraint or validation trigger on chairman_decisions.metadata to enforce dfe_context schema structure.',
    'Update PRD to reference correct table name (eva_orchestration_events) and correct trigger types from DFE engine, or document the intentional abstraction layer.',
  ];

  const metadata = {
    phase: 'PLAN_PRD',
    orchestrated: true,
    informed_by_design: true,
    tables_analyzed: ['eva_orchestration_events', 'chairman_decisions', 'ventures', 'issue_patterns'],
    code_analyzed: ['lib/eva/decision-filter-engine.js'],
    migration_required: true,
    migration_scope: 'ALTER TABLE chairman_decisions ADD COLUMN metadata JSONB + GIN indexes',
    rls_changes_required: false,
    index_changes_required: true,
    index_scope: '2 GIN indexes on chairman_decisions.metadata subkeys',
    trigger_type_mismatch_documented: true,
    table_name_mismatch_documented: true,
    prd_discrepancies_found: 3,
    existing_schema_sufficient_for: ['eva_orchestration_events', 'issue_patterns', 'ventures'],
    schema_gaps_found_in: ['chairman_decisions (missing metadata column)'],
  };

  const summaryText = 'DATABASE analysis identified 3 critical findings: (1) chairman_decisions missing metadata JSONB column required by PRD - migration needed, (2) PRD references non-existent eva_event_log table (actual: eva_orchestration_events), (3) DFE trigger types in PRD do not match engine code (6 vs 6, completely different sets). One migration required: ADD COLUMN metadata JSONB + 2 GIN indexes to chairman_decisions. No RLS or structural changes needed for eva_orchestration_events. Existing indexes sufficient for all query patterns. Analysis informed by DESIGN context (EscalationPanel, DFEContextAdapter architecture).';

  const { data, error } = await sb
    .from('sub_agent_execution_results')
    .insert({
      sd_id: sdId,
      sub_agent_code: 'DATABASE',
      sub_agent_name: 'Principal Database Architect',
      verdict: 'PASS',
      confidence: 92,
      critical_issues: criticalIssues,
      warnings: warnings,
      recommendations: recommendations,
      detailed_analysis: detailedAnalysis,
      execution_time: 45,
      metadata: metadata,
      summary: summaryText,
      source: 'sub_agent_executor',
      validation_mode: 'prospective',
    })
    .select('id, verdict, confidence, created_at')
    .single();

  if (error) {
    console.error('INSERT ERROR:', error.message);
    console.error('Details:', JSON.stringify(error, null, 2));
    process.exit(1);
  }

  console.log('SUCCESS: DATABASE analysis stored');
  console.log('Record ID:', data.id);
  console.log('Verdict:', data.verdict);
  console.log('Confidence:', data.confidence);
  console.log('Created:', data.created_at);
}

main().catch(err => {
  console.error('Fatal:', err);
  process.exit(1);
});
