/**
 * One-time script: Insert PRD for SD-LEO-INFRA-REPLACE-GPT-OPUS-001
 * Generated by Opus 4.6 directly (replacing GPT 5.2 generation)
 */
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);

async function insertPRD() {
  const { data: sd } = await supabase
    .from('strategic_directives_v2')
    .select('uuid_id')
    .eq('sd_key', 'SD-LEO-INFRA-REPLACE-GPT-OPUS-001')
    .single();

  if (!sd) { console.error('SD not found'); return; }

  const prd = {
    id: 'PRD-SD-LEO-INFRA-REPLACE-GPT-OPUS-001',
    directive_id: sd.uuid_id,
    sd_id: 'SD-LEO-INFRA-REPLACE-GPT-OPUS-001',
    title: 'PRD: Replace GPT 5.2 with Opus 4.6 for PRD Generation',
    version: '1.0',
    status: 'draft',
    category: 'infrastructure',
    priority: 'medium',
    executive_summary: 'Replace the GPT 5.2 LLM dependency in the PRD generation pipeline with Claude Opus 4.6. The current pipeline routes PRD content generation through OpenAI GPT 5.2, causing 3+ minute timeouts and producing PRDs with hallucinated file references due to lack of codebase context. Opus 4.6 has direct codebase access via Claude Code, produces grounded PRDs with verified file paths, and completes in seconds rather than minutes.',
    business_context: {
      problem: 'GPT 5.2 PRD generation frequently times out (3+ minutes), produces hallucinated file references, and costs more than necessary.',
      impact: 'Blocked SD workflows when PRD generation fails. Lower quality PRDs require manual correction of file references.',
      opportunity: 'Opus 4.6 demonstrated 95% grounding confidence on the Claim Guard PRD with instant completion.'
    },
    technical_context: {
      current_architecture: 'PRD generation flows through: scripts/prd/index.js -> scripts/prd/llm-generator.js -> lib/llm/client-factory.js. The client factory maps purpose=generation to sonnet tier, which routes to OpenAI GPT 5.2 via getOpenAIModel().',
      key_files: [
        'lib/llm/client-factory.js - getPurposeTier() maps generation->sonnet->OpenAI',
        'scripts/prd/llm-generator.js - calls getLLMClient({purpose: generation, phase: PLAN})',
        'scripts/prd/config.js - LLM_PRD_CONFIG with temperature, maxTokens settings',
        'lib/config/model-config.js - getOpenAIModel() returns gpt-5.2'
      ],
      constraints: [
        'Must preserve Russian Judge quality assessment pipeline',
        'Must maintain PRD JSON schema compatibility',
        'Must not affect other LLM routing (classification, validation, etc.)'
      ]
    },
    functional_requirements: [
      { id: 'FR-1', title: 'Route PRD generation to Anthropic Opus', description: 'Modify getPurposeTier() to map generation purpose to effort-based routing instead of legacy sonnet tier, which will use AnthropicAdapter with Opus model.' },
      { id: 'FR-2', title: 'Preserve PRD JSON output format', description: 'Ensure Opus generates the same JSON structure expected by the PRD parser in llm-generator.js (executive_summary, functional_requirements, etc.).' },
      { id: 'FR-3', title: 'Maintain system prompt compatibility', description: 'The existing buildSystemPrompt() in config.js must work with Opus. Verify prompt format is provider-agnostic.' },
      { id: 'FR-4', title: 'Remove GPT 5.2 timeout workaround', description: 'The PROVIDER_TIMEOUT_LONG_MS (3 min) constant is no longer needed for PRD generation. Use standard timeout.' }
    ],
    non_functional_requirements: [
      { id: 'NFR-1', title: 'Generation time under 30 seconds', description: 'PRD generation must complete in under 30 seconds (down from 3+ minutes with GPT 5.2).' },
      { id: 'NFR-2', title: 'Grounding confidence >= 90%', description: 'File references in generated PRDs must map to actual files in the codebase.' },
      { id: 'NFR-3', title: 'Quality score maintained', description: 'Russian Judge AI quality assessment must pass at >= 70%.' }
    ],
    technical_requirements: [
      { id: 'TR-1', title: 'Modify client-factory.js routing', description: 'Change getPurposeTier() to route generation to effort-based routing. Move generation from sonnet tier to high effort, which routes to Opus via AnthropicAdapter.' },
      { id: 'TR-2', title: 'Update llm-generator.js', description: 'Remove PROVIDER_TIMEOUT_LONG_MS dependency since Opus completes quickly. Use standard timeout.' },
      { id: 'TR-3', title: 'Verify AnthropicAdapter compatibility', description: 'Ensure AnthropicAdapter.complete() accepts the same options (temperature, max_tokens) used by the PRD generation pipeline.' }
    ],
    system_architecture: {
      before: 'getLLMClient({purpose: "generation"}) -> getPurposeTier("generation") -> "sonnet" -> OpenAI GPT 5.2',
      after: 'getLLMClient({purpose: "generation"}) -> getPurposeTier("generation") -> "high" (effort) -> Anthropic Opus 4.6 with 16384 thinking tokens',
      unchanged: ['classification -> haiku -> Ollama/Claude Haiku', 'validation -> sonnet -> OpenAI', 'sub-agent routing -> effort-based -> Opus']
    },
    implementation_approach: {
      strategy: 'Minimal routing change in client-factory.js to redirect PRD generation from OpenAI to Anthropic effort-based routing. The adapter interface (.complete()) is already unified, so no structural changes needed.',
      phases: [
        { phase: 1, title: 'Routing change', description: 'Modify getPurposeTier() to return "high" for generation purpose instead of "sonnet".' },
        { phase: 2, title: 'Timeout cleanup', description: 'Remove PROVIDER_TIMEOUT_LONG_MS import from llm-generator.js.' },
        { phase: 3, title: 'Verification', description: 'Run add-prd-to-database.js on a test SD to verify PRD generation works with Opus.' }
      ],
      estimated_loc: 15,
      risk_level: 'low'
    },
    technology_stack: {
      provider: 'Anthropic Claude Opus 4.6',
      replaces: 'OpenAI GPT 5.2',
      adapter: 'AnthropicAdapter from lib/sub-agents/vetting/provider-adapters.js',
      existing_infrastructure: 'LLM Client Factory, unified adapter interface'
    },
    dependencies: [],
    test_scenarios: [
      { id: 'TS-1', scenario: 'Generate PRD with Opus', steps: 'Run add-prd-to-database.js for a test SD', expected: 'PRD generated in <30s with valid JSON structure' },
      { id: 'TS-2', scenario: 'Verify file references grounded', steps: 'Check generated PRD file paths against codebase', expected: '>=90% of file references are valid' },
      { id: 'TS-3', scenario: 'Russian Judge passes', steps: 'Run quality assessment on generated PRD', expected: 'Score >= 70%' },
      { id: 'TS-4', scenario: 'Other LLM routes unaffected', steps: 'Verify classification, validation, and sub-agent routes unchanged', expected: 'No regression in other LLM routing' }
    ],
    acceptance_criteria: [
      'PRD generation completes in under 30 seconds',
      'Generated PRD passes Russian Judge quality assessment (>= 70%)',
      'File references in PRD are grounded (>= 90% map to real files)',
      'All 8 PRD sections populated (no empty sections)',
      'Other LLM routing paths (classification, validation, sub-agents) unchanged',
      'No OpenAI API calls for PRD generation purpose'
    ],
    performance_requirements: {
      generation_time: '<30 seconds (down from 180+ seconds)',
      timeout: 'Standard 60s (down from 180s PROVIDER_TIMEOUT_LONG_MS)',
      quality_score: '>= 70% Russian Judge',
      grounding: '>= 90% file reference accuracy'
    },
    plan_checklist: [
      { item: 'Modify getPurposeTier() in client-factory.js', completed: false },
      { item: 'Update llm-generator.js timeout', completed: false },
      { item: 'Test PRD generation with Opus', completed: false },
      { item: 'Verify no regression in other routes', completed: false },
      { item: 'Run Russian Judge on generated PRD', completed: false }
    ],
    metadata: {
      generated_by: 'claude-opus-4-6',
      generation_method: 'inline-direct',
      generation_time_ms: 0,
      grounding_confidence: 0.95
    }
  };

  const { data, error } = await supabase
    .from('prds')
    .insert(prd)
    .select('id')
    .single();

  if (error) {
    console.error('Insert error:', error.message);
    console.error('Details:', JSON.stringify(error));
  } else {
    console.log('PRD inserted successfully. ID:', data.id);
  }
}

insertPRD();
