/**
 * File Generators for CLAUDE.md Generator
 * Generates content for each CLAUDE file (Router, Core, Lead, Plan, Exec)
 */

import {
  formatSection,
  getMetadata,
  generateAgentSection,
  generateSubAgentSection,
  generateHandoffTemplates,
  generateValidationRules,
  generateSchemaConstraintsSection,
  generateProcessScriptsSection
} from './section-formatters.js';

// ARCHITECTURE DECISION (2026-01-24): Keywords come from code, not database
import { generateKeywordQuickReference } from './keyword-extractor.js';

import {
  generateHotPatternsSection,
  generateRecentLessonsSection,
  generateGateHealthSection,
  generateProposalsSection,
  generateAutonomousDirectivesSection
} from './operational-sections.js';

/**
 * Get sections by file mapping
 * @param {Array} sections - All sections
 * @param {string} fileKey - File key from mapping
 * @param {Object} fileMapping - Section to file mapping
 * @returns {Array} Filtered sections
 */
function getSectionsByMapping(sections, fileKey, fileMapping) {
  const mappedTypes = fileMapping[fileKey]?.sections || [];
  return sections.filter(s => mappedTypes.includes(s.section_type));
}

/**
 * Get the RCA Issue Resolution Mandate section (appears at top and bottom of all files)
 * @param {Array} sections - All sections
 * @returns {string} RCA mandate content or empty string if not found
 */
function getRCAMandate(sections) {
  const rcaSection = sections.find(s => s.section_type === 'rca_issue_resolution_mandate');
  return rcaSection?.content || '';
}

/**
 * Generate CLAUDE.md router file
 * @param {Object} data - All data from database
 * @param {Object} fileMapping - Section to file mapping
 * @returns {string} Generated markdown content
 */
function generateRouter(data, _fileMapping) {
  const { protocol } = data;
  const sections = protocol.sections;
  const { today, time } = getMetadata(protocol);

  const fileWarning = sections.find(s => s.section_type === 'file_warning');
  const smartRouter = sections.find(s => s.section_type === 'smart_router');
  const sessionPrologue = sections.find(s => s.section_type === 'session_prologue');
  const migrationProtocol = sections.find(s => s.section_type === 'migration_execution_protocol_main');
  const autoProceedMode = sections.find(s => s.section_type === 'auto_proceed_mode');
  const orchestratorChaining = sections.find(s => s.section_type === 'orchestrator_chaining');
  const sdContinuationTruthTable = sections.find(s => s.section_type === 'sd_continuation_truth_table');
  const sessionInit = sections.find(s => s.section_type === 'session_init');
  const workItemRouting = sections.find(s => s.section_type === 'work_item_routing');
  const skillIntentDetection = sections.find(s => s.section_type === 'skill_intent_detection');
  const commonCommands = sections.find(s => s.section_type === 'common_commands');
  const teamsProtocol = sections.find(s => s.section_type === 'teams_protocol');

  // ARCHITECTURE DECISION (2026-01-24): Keywords from code file, not database
  const triggerReference = generateKeywordQuickReference();

  // RCA Mandate appears at top and bottom of all files
  const rcaMandate = getRCAMandate(sections);

  return `# CLAUDE.md - LEO Protocol Context Router

${rcaMandate}

${fileWarning ? fileWarning.content : 'DO NOT EDIT THIS FILE DIRECTLY - Generated from database'}

${sessionPrologue ? formatSection(sessionPrologue) : ''}

${migrationProtocol ? formatSection(migrationProtocol) : ''}

${autoProceedMode ? formatSection(autoProceedMode) : ''}

${orchestratorChaining ? formatSection(orchestratorChaining) : ''}

${sdContinuationTruthTable ? formatSection(sdContinuationTruthTable) : ''}

${sessionInit ? formatSection(sessionInit) : ''}

${workItemRouting ? formatSection(workItemRouting) : ''}

${skillIntentDetection ? formatSection(skillIntentDetection) : ''}

${commonCommands ? commonCommands.content : ''}

${teamsProtocol ? formatSection(teamsProtocol) : ''}

## DYNAMICALLY GENERATED FROM DATABASE
**Last Generated**: ${today} ${time}
**Source**: Supabase Database (not files)
**Auto-Update**: Run \`node scripts/generate-claude-md-from-db.js\` anytime

## CURRENT LEO PROTOCOL VERSION: ${protocol.version}

**CRITICAL**: This is the ACTIVE version from database
**ID**: ${protocol.id}
**Status**: ${protocol.status.toUpperCase()}
**Title**: ${protocol.title}

${smartRouter ? smartRouter.content : '## Context Router\n\n**Load Strategy**: Read CLAUDE_CORE.md first, then phase-specific files as needed.'}

${triggerReference}

---

*Router generated from database: ${today}*
*Protocol Version: ${protocol.version}*
*Part of LEO Protocol router architecture*

${rcaMandate}
`;
}

/**
 * Generate CLAUDE_CORE.md file
 * @param {Object} data - All data from database
 * @param {Object} fileMapping - Section to file mapping
 * @returns {string} Generated markdown content
 */
function generateCore(data, fileMapping) {
  const { protocol, agents, subAgents, hotPatterns, recentRetrospectives, gateHealth, pendingProposals } = data;
  const sections = protocol.sections;
  const { today, time } = getMetadata(protocol);

  const coreSections = getSectionsByMapping(sections, 'CLAUDE_CORE.md', fileMapping);
  const coreContent = coreSections.map(s => formatSection(s)).join('\n\n');

  const subAgentSection = generateSubAgentSection(subAgents);
  const hotPatternsSection = generateHotPatternsSection(hotPatterns);
  const recentLessonsSection = generateRecentLessonsSection(recentRetrospectives);
  const gateHealthSection = generateGateHealthSection(gateHealth);
  const proposalsSection = generateProposalsSection(pendingProposals);

  // RCA Mandate appears at top and bottom of all files
  const rcaMandate = getRCAMandate(sections);

  return `# CLAUDE_CORE.md - LEO Protocol Core Context

${rcaMandate}

**Generated**: ${today} ${time}
**Protocol**: LEO ${protocol.version}
**Purpose**: Essential workflow context for all sessions (15-20k chars)

---

${coreContent}

${proposalsSection}

${hotPatternsSection}

${gateHealthSection}

${recentLessonsSection}

## Agent Responsibilities

${generateAgentSection(agents)}

## Progress Calculation

\`\`\`
Total = ${agents.map(a => `${a.agent_code}: ${a.total_percentage}%`).join(' + ')} = 100%
\`\`\`

${subAgentSection}

---

*Generated from database: ${today}*
*Protocol Version: ${protocol.version}*
*Includes: Proposals (${pendingProposals?.length || 0}) + Hot Patterns (${hotPatterns?.length || 0}) + Lessons (${recentRetrospectives?.length || 0})*
*Load this file first in all sessions*

${rcaMandate}
`;
}

/**
 * Generate CLAUDE_LEAD.md file
 * @param {Object} data - All data from database
 * @param {Object} fileMapping - Section to file mapping
 * @returns {string} Generated markdown content
 */
function generateLead(data, fileMapping) {
  const { protocol, autonomousDirectives } = data;
  const sections = protocol.sections;
  const { today, time } = getMetadata(protocol);

  const leadSections = getSectionsByMapping(sections, 'CLAUDE_LEAD.md', fileMapping);
  const leadContent = leadSections.map(s => formatSection(s)).join('\n\n');

  const directivesSection = generateAutonomousDirectivesSection(autonomousDirectives, 'LEAD');

  // RCA Mandate appears at top and bottom of all files
  const rcaMandate = getRCAMandate(sections);

  return `# CLAUDE_LEAD.md - LEAD Phase Operations

${rcaMandate}

**Generated**: ${today} ${time}
**Protocol**: LEO ${protocol.version}
**Purpose**: LEAD agent operations and strategic validation (25-30k chars)

---

${directivesSection}

${leadContent}

---

*Generated from database: ${today}*
*Protocol Version: ${protocol.version}*
*Load when: User mentions LEAD, approval, strategic validation, or over-engineering*

${rcaMandate}
`;
}

/**
 * Generate CLAUDE_PLAN.md file
 * @param {Object} data - All data from database
 * @param {Object} fileMapping - Section to file mapping
 * @returns {string} Generated markdown content
 */
function generatePlan(data, fileMapping) {
  const { protocol, handoffTemplates, validationRules, autonomousDirectives } = data;
  const sections = protocol.sections;
  const { today, time } = getMetadata(protocol);

  const planSections = getSectionsByMapping(sections, 'CLAUDE_PLAN.md', fileMapping);
  const planContent = planSections.map(s => formatSection(s)).join('\n\n');

  const directivesSection = generateAutonomousDirectivesSection(autonomousDirectives, 'PLAN');

  // RCA Mandate appears at top and bottom of all files
  const rcaMandate = getRCAMandate(sections);

  return `# CLAUDE_PLAN.md - PLAN Phase Operations

${rcaMandate}

**Generated**: ${today} ${time}
**Protocol**: LEO ${protocol.version}
**Purpose**: PLAN agent operations, PRD creation, validation gates (30-35k chars)

---

${directivesSection}

${planContent}

## Handoff Templates

${generateHandoffTemplates(handoffTemplates)}

## Validation Rules

${generateValidationRules(validationRules)}

---

*Generated from database: ${today}*
*Protocol Version: ${protocol.version}*
*Load when: User mentions PLAN, PRD, validation, or testing strategy*

${rcaMandate}
`;
}

/**
 * Generate CLAUDE_EXEC.md file
 * @param {Object} data - All data from database
 * @param {Object} fileMapping - Section to file mapping
 * @returns {string} Generated markdown content
 */
function generateExec(data, fileMapping) {
  const { protocol, schemaConstraints, processScripts, autonomousDirectives } = data;
  const sections = protocol.sections;
  const { today, time } = getMetadata(protocol);

  const execSections = getSectionsByMapping(sections, 'CLAUDE_EXEC.md', fileMapping);
  const execContent = execSections.map(s => formatSection(s)).join('\n\n');

  const constraintsSection = generateSchemaConstraintsSection(schemaConstraints);
  const scriptsSection = generateProcessScriptsSection(processScripts);
  const directivesSection = generateAutonomousDirectivesSection(autonomousDirectives, 'EXEC');

  // RCA Mandate appears at top and bottom of all files
  const rcaMandate = getRCAMandate(sections);

  return `# CLAUDE_EXEC.md - EXEC Phase Operations

${rcaMandate}

**Generated**: ${today} ${time}
**Protocol**: LEO ${protocol.version}
**Purpose**: EXEC agent implementation requirements and testing (20-25k chars)

---

${directivesSection}

${execContent}

${constraintsSection}

${scriptsSection}

---

*Generated from database: ${today}*
*Protocol Version: ${protocol.version}*
*Load when: User mentions EXEC, implementation, coding, or testing*

${rcaMandate}
`;
}

export {
  getSectionsByMapping,
  generateRouter,
  generateCore,
  generateLead,
  generatePlan,
  generateExec
};
