#!/usr/bin/env node
/**
 * Insert User Stories for SD-UI-PARITY-001
 * IDEATION Stages 1-6 UI Component Backfill
 *
 * Generated by STORIES sub-agent following v2.0.0 guidelines:
 * - INVEST criteria validated
 * - Given-When-Then acceptance criteria format
 * - Rich implementation context
 * - Architecture references included
 *
 * 4 Phases, 25 Components, ~150 hours estimated
 */

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

const SD_ID = 'SD-UI-PARITY-001';

// ============================================================================
// USER STORIES DEFINITION
// ============================================================================

const userStories = [
  // ============================================================================
  // PHASE 1: FOUNDATION COMPONENTS (6 components, ~25 hours)
  // ============================================================================
  {
    story_key: 'SD-UI-PARITY-001:US-001',
    title: 'ScoreBar Component for Visual Score Display',
    user_role: 'stakeholder',
    user_want: 'see scores displayed as visual progress bars with threshold indicators',
    user_benefit: 'quickly understand how a score compares to pass/fail thresholds without reading numbers',
    story_points: 3,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-001-1',
        scenario: 'Happy path - score above threshold',
        given: 'A score value of 75 and a threshold of 60',
        when: 'ScoreBar component renders',
        then: 'Bar fills to 75% with green color and threshold marker visible at 60%'
      },
      {
        id: 'AC-001-2',
        scenario: 'Warning path - score near threshold',
        given: 'A score value of 62 and a threshold of 60',
        when: 'ScoreBar component renders',
        then: 'Bar fills to 62% with amber/yellow color indicating marginal pass'
      },
      {
        id: 'AC-001-3',
        scenario: 'Error path - score below threshold',
        given: 'A score value of 45 and a threshold of 60',
        when: 'ScoreBar component renders',
        then: 'Bar fills to 45% with red color and threshold marker clearly shows gap'
      },
      {
        id: 'AC-001-4',
        scenario: 'Edge case - zero score',
        given: 'A score value of 0',
        when: 'ScoreBar component renders',
        then: 'Empty bar displays with appropriate styling, no console errors'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/ScoreBar.tsx',
      'Unit tests with >80% coverage',
      'Storybook story created',
      'Responsive design verified',
      'Accessibility: ARIA labels for screen readers'
    ],
    technical_notes: 'Use Shadcn/UI Progress component as base. Add threshold marker overlay.',
    implementation_approach: 'Extend Progress component with threshold prop and color logic based on value vs threshold comparison.',
    implementation_context: 'Foundation component used across all IDEATION stages. Must be highly reusable with configurable threshold, colors, and labels.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/progress.tsx - base Progress component',
      'ehg/src/components/ideation/scores/ - existing score components',
      'Recharts for advanced visualization if needed'
    ]),
    example_code_patterns: JSON.stringify([
      {
        pattern: 'Threshold color logic',
        code: `const getColor = (value, threshold) => {
  if (value >= threshold + 10) return 'bg-green-500';
  if (value >= threshold) return 'bg-amber-500';
  return 'bg-red-500';
};`
      }
    ]),
    testing_scenarios: JSON.stringify([
      { id: 'TS-001-1', scenario: 'Score 100/100', expected: 'Full green bar' },
      { id: 'TS-001-2', scenario: 'Score 0/100', expected: 'Empty bar, no errors' },
      { id: 'TS-001-3', scenario: 'Threshold edge', expected: 'Correct color transition' }
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-002',
    title: 'DecisionBadge Component for GO/NO_GO/REVISE Display',
    user_role: 'stakeholder',
    user_want: 'see gate decisions displayed as prominent color-coded badges',
    user_benefit: 'immediately understand the outcome of each stage gate without reading detailed text',
    story_points: 2,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-002-1',
        scenario: 'GO decision display',
        given: 'A gate decision of "GO"',
        when: 'DecisionBadge component renders',
        then: 'Green badge displays with "GO" text and checkmark icon'
      },
      {
        id: 'AC-002-2',
        scenario: 'NO_GO decision display',
        given: 'A gate decision of "NO_GO"',
        when: 'DecisionBadge component renders',
        then: 'Red badge displays with "NO GO" text and X icon'
      },
      {
        id: 'AC-002-3',
        scenario: 'REVISE decision display',
        given: 'A gate decision of "REVISE"',
        when: 'DecisionBadge component renders',
        then: 'Amber badge displays with "REVISE" text and warning icon'
      },
      {
        id: 'AC-002-4',
        scenario: 'Unknown decision handling',
        given: 'An unexpected decision value',
        when: 'DecisionBadge component renders',
        then: 'Gray badge displays with original text, no crash'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/DecisionBadge.tsx',
      'Unit tests with >80% coverage',
      'All 3 decision types visually distinct',
      'Accessible with ARIA labels'
    ],
    technical_notes: 'Use Shadcn/UI Badge component. Map decision enum to color variants.',
    implementation_approach: 'Wrapper around Badge with decision-to-variant mapping and icon selection.',
    implementation_context: 'Critical component for gate visibility. Used in every stage output view.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/badge.tsx - base Badge component',
      'lucide-react for icons (Check, X, AlertTriangle)'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-003',
    title: 'ConfidenceRing Component for Circular Confidence Display',
    user_role: 'stakeholder',
    user_want: 'see confidence levels displayed as circular progress indicators',
    user_benefit: 'visually gauge AI confidence at a glance without reading percentages',
    story_points: 3,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-003-1',
        scenario: 'High confidence display',
        given: 'A confidence value of 95',
        when: 'ConfidenceRing component renders',
        then: 'Circular ring fills to 95% with green stroke, percentage shown in center'
      },
      {
        id: 'AC-003-2',
        scenario: 'Medium confidence display',
        given: 'A confidence value of 65',
        when: 'ConfidenceRing component renders',
        then: 'Circular ring fills to 65% with amber stroke'
      },
      {
        id: 'AC-003-3',
        scenario: 'Low confidence display',
        given: 'A confidence value of 35',
        when: 'ConfidenceRing component renders',
        then: 'Circular ring fills to 35% with red stroke'
      },
      {
        id: 'AC-003-4',
        scenario: 'Animation on mount',
        given: 'Component first renders',
        when: 'ConfidenceRing mounts',
        then: 'Ring animates from 0 to target value smoothly'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/ConfidenceRing.tsx',
      'Uses SVG for crisp rendering at any size',
      'Configurable size prop',
      'Animation smooth (60fps)'
    ],
    technical_notes: 'Use SVG circle with stroke-dasharray for arc rendering. Consider Recharts RadialBarChart as alternative.',
    implementation_approach: 'SVG-based circular progress with CSS transitions for animation.',
    implementation_context: 'Used to display confidence scores across all stages. Should match design system colors.',
    architecture_references: JSON.stringify([
      'Recharts RadialBarChart as alternative',
      'SVG stroke-dasharray technique for arcs'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-004',
    title: 'AlertList Component for Red Flags and Warnings',
    user_role: 'stakeholder',
    user_want: 'see all red flags and warnings in a prominent, scannable list',
    user_benefit: 'quickly identify critical issues that need attention before proceeding',
    story_points: 3,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-004-1',
        scenario: 'Display red flags prominently',
        given: 'A list of 3 red flags',
        when: 'AlertList component renders',
        then: 'All 3 flags display with red styling and warning icons'
      },
      {
        id: 'AC-004-2',
        scenario: 'Empty state handling',
        given: 'An empty array of alerts',
        when: 'AlertList component renders',
        then: 'Shows "No alerts" message with muted styling'
      },
      {
        id: 'AC-004-3',
        scenario: 'Severity differentiation',
        given: 'Alerts with different severity levels',
        when: 'AlertList component renders',
        then: 'Critical alerts display red, warnings display amber'
      },
      {
        id: 'AC-004-4',
        scenario: 'Expandable details',
        given: 'An alert with extended details',
        when: 'User clicks on alert',
        then: 'Details section expands to show full context'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/AlertList.tsx',
      'Supports severity levels (critical, warning, info)',
      'Expandable/collapsible items',
      'Keyboard accessible'
    ],
    technical_notes: 'Use Shadcn/UI Alert component with Collapsible for details.',
    implementation_approach: 'Map array of alerts to styled Alert components with optional Collapsible wrapper.',
    implementation_context: 'Critical for surfacing blockers. Used in all stage outputs to show red_flags field.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/alert.tsx',
      'ehg/src/components/ui/collapsible.tsx'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-005',
    title: 'FindingsList Component for Structured Findings Display',
    user_role: 'stakeholder',
    user_want: 'see analysis findings in a structured, categorized list',
    user_benefit: 'understand the key insights from each stage analysis in an organized format',
    story_points: 3,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-005-1',
        scenario: 'Display categorized findings',
        given: 'Findings grouped by category (market, technical, financial)',
        when: 'FindingsList component renders',
        then: 'Each category shows as collapsible section with count badge'
      },
      {
        id: 'AC-005-2',
        scenario: 'Individual finding display',
        given: 'A finding with title, description, and evidence',
        when: 'Finding item renders',
        then: 'Title is prominent, description below, evidence linkable'
      },
      {
        id: 'AC-005-3',
        scenario: 'Empty category handling',
        given: 'A category with no findings',
        when: 'FindingsList component renders',
        then: 'Category is hidden or shows "No findings" state'
      },
      {
        id: 'AC-005-4',
        scenario: 'Search/filter findings',
        given: 'A list of 20+ findings',
        when: 'User types in search box',
        then: 'Findings are filtered by title/description match'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/FindingsList.tsx',
      'Supports categorization',
      'Optional search/filter',
      'Responsive layout'
    ],
    technical_notes: 'Use Accordion for categories. Consider virtualization for large lists.',
    implementation_approach: 'Accordion-based category grouping with optional search input.',
    implementation_context: 'Core component for displaying analysis results. Most stages have structured findings.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/accordion.tsx',
      'ehg/src/components/ui/input.tsx for search'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-006',
    title: 'StageOutputCard Component for Unified Stage Display',
    user_role: 'stakeholder',
    user_want: 'see each stage output in a consistent card format with key metrics',
    user_benefit: 'have a predictable layout for reviewing any stage without learning new interfaces',
    story_points: 5,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-006-1',
        scenario: 'Standard card layout',
        given: 'Stage output data for any stage (1-6)',
        when: 'StageOutputCard component renders',
        then: 'Card shows: stage name, decision badge, confidence ring, key metrics'
      },
      {
        id: 'AC-006-2',
        scenario: 'Consistent header across stages',
        given: 'Different stage types',
        when: 'StageOutputCard renders for each',
        then: 'Header layout is identical, content varies by stage'
      },
      {
        id: 'AC-006-3',
        scenario: 'Expandable content sections',
        given: 'Stage output with multiple sections',
        when: 'User clicks section header',
        then: 'Section expands to show full content'
      },
      {
        id: 'AC-006-4',
        scenario: 'Loading state',
        given: 'Stage data is loading',
        when: 'StageOutputCard renders',
        then: 'Skeleton loader displays with same layout shape'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/StageOutputCard.tsx',
      'Composes DecisionBadge, ConfidenceRing, ScoreBar',
      'Consistent across all 6 stages',
      'Loading skeleton included'
    ],
    technical_notes: 'Master composition component. Uses all foundation components.',
    implementation_approach: 'Card component that composes DecisionBadge, ConfidenceRing, ScoreBar with stage-specific content slots.',
    implementation_context: 'THE core component for UI parity. Every stage viewer will use this as base.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/card.tsx',
      'All US-UIP-001 through US-UIP-005 components'
    ])
  },

  // ============================================================================
  // PHASE 2: CRITICAL STAGE COMPONENTS (6 components, ~40 hours)
  // ============================================================================
  {
    story_key: 'SD-UI-PARITY-001:US-007',
    title: 'GateDecisionBanner Component for Prominent Gate Results',
    user_role: 'stakeholder',
    user_want: 'see stage gate decisions displayed as full-width prominent banners',
    user_benefit: 'never miss a critical gate decision when reviewing stage outputs',
    story_points: 3,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-007-1',
        scenario: 'GO gate banner',
        given: 'A GO gate decision with confidence 95',
        when: 'GateDecisionBanner component renders',
        then: 'Full-width green banner with "PROCEED TO NEXT STAGE" message'
      },
      {
        id: 'AC-007-2',
        scenario: 'NO_GO gate banner',
        given: 'A NO_GO gate decision with reasons',
        when: 'GateDecisionBanner component renders',
        then: 'Full-width red banner with blockers listed prominently'
      },
      {
        id: 'AC-007-3',
        scenario: 'REVISE gate banner',
        given: 'A REVISE gate decision with revision notes',
        when: 'GateDecisionBanner component renders',
        then: 'Full-width amber banner with required revisions listed'
      },
      {
        id: 'AC-007-4',
        scenario: 'Next steps guidance',
        given: 'Any gate decision',
        when: 'GateDecisionBanner component renders',
        then: 'Banner includes recommended next actions'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/GateDecisionBanner.tsx',
      'Full-width, cannot be missed',
      'Shows blockers/revisions when applicable',
      'Accessible with proper contrast'
    ],
    technical_notes: 'Use Alert component with destructive/warning/default variants.',
    implementation_approach: 'Full-width Alert with enhanced styling and content slots for reasons/blockers.',
    implementation_context: 'Placed at top of each stage output view. Must be highly visible.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/alert.tsx',
      'US-UIP-002 DecisionBadge for consistency'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-008',
    title: 'FinalRecommendation Component for Stage Synthesis',
    user_role: 'stakeholder',
    user_want: 'see a clear summary of the final recommendation from each stage',
    user_benefit: 'understand the bottom-line conclusion without reading all details',
    story_points: 3,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-008-1',
        scenario: 'Display recommendation summary',
        given: 'Stage output with final_recommendation field',
        when: 'FinalRecommendation component renders',
        then: 'Summary displays in prominent card with key points bulleted'
      },
      {
        id: 'AC-008-2',
        scenario: 'Show confidence context',
        given: 'Recommendation with confidence score',
        when: 'FinalRecommendation component renders',
        then: 'ConfidenceRing shows alongside recommendation text'
      },
      {
        id: 'AC-008-3',
        scenario: 'Link to supporting evidence',
        given: 'Recommendation with evidence references',
        when: 'User clicks evidence link',
        then: 'Scrolls to or opens relevant findings section'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/FinalRecommendation.tsx',
      'Composes ConfidenceRing',
      'Links to evidence sections',
      'Prominent visual hierarchy'
    ],
    technical_notes: 'Use Card with highlighted styling. Include anchor links to evidence.',
    implementation_approach: 'Styled Card with recommendation text, bullet points, and linked evidence.',
    implementation_context: 'Synthesis component for stage conclusions. Every stage has final_recommendation.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/card.tsx',
      'US-UIP-003 ConfidenceRing'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-009',
    title: 'BlockerChecklist Component for Gate Blockers',
    user_role: 'stakeholder',
    user_want: 'see all gate blockers in a checklist format with resolution status',
    user_benefit: 'track which critical issues need resolution before proceeding',
    story_points: 3,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-009-1',
        scenario: 'Display blockers as checklist',
        given: 'List of 3 gate blockers',
        when: 'BlockerChecklist component renders',
        then: 'Each blocker shows as unchecked item with description'
      },
      {
        id: 'AC-009-2',
        scenario: 'Show blocker severity',
        given: 'Blockers with different severity levels',
        when: 'BlockerChecklist component renders',
        then: 'Critical blockers show red indicator, warnings show amber'
      },
      {
        id: 'AC-009-3',
        scenario: 'Resolution guidance',
        given: 'A blocker with mitigation_steps',
        when: 'User expands blocker',
        then: 'Mitigation steps display as sub-checklist'
      },
      {
        id: 'AC-009-4',
        scenario: 'All blockers resolved state',
        given: 'All blockers marked resolved',
        when: 'BlockerChecklist component renders',
        then: 'Shows success state with "All blockers resolved" message'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/BlockerChecklist.tsx',
      'Checklist format with expandable items',
      'Severity indicators',
      'Resolution tracking'
    ],
    technical_notes: 'Use Checkbox components in list. Collapsible for mitigation steps.',
    implementation_approach: 'Checklist with severity badges and expandable mitigation guidance.',
    implementation_context: 'Critical for NO_GO decisions. Must clearly show what needs fixing.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/checkbox.tsx',
      'ehg/src/components/ui/collapsible.tsx'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-010',
    title: 'PerspectivePanel Component for Multi-Perspective Analysis',
    user_role: 'stakeholder',
    user_want: 'see different analytical perspectives displayed in organized panels',
    user_benefit: 'understand how different viewpoints (market, technical, financial) align or conflict',
    story_points: 5,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-010-1',
        scenario: 'Display multiple perspectives',
        given: 'Analysis with market, technical, and financial perspectives',
        when: 'PerspectivePanel component renders',
        then: 'Three tabbed or columned panels show each perspective'
      },
      {
        id: 'AC-010-2',
        scenario: 'Highlight perspective conflicts',
        given: 'Technical perspective conflicts with market perspective',
        when: 'PerspectivePanel component renders',
        then: 'Conflict indicator shows between panels with explanation'
      },
      {
        id: 'AC-010-3',
        scenario: 'Perspective summary scores',
        given: 'Each perspective has a summary score',
        when: 'PerspectivePanel component renders',
        then: 'ScoreBar shows at top of each perspective panel'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/PerspectivePanel.tsx',
      'Tabs or columns layout',
      'Conflict detection visual',
      'Uses ScoreBar component'
    ],
    technical_notes: 'Use Tabs component. Consider side-by-side comparison view.',
    implementation_approach: 'Tabbed interface with optional comparison mode showing multiple perspectives simultaneously.',
    implementation_context: 'Stage 2 (Opportunity Analysis) heavily uses multiple perspectives.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/tabs.tsx',
      'US-UIP-001 ScoreBar'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-011',
    title: 'RiskRankingList Component for Ordered Risk Display',
    user_role: 'stakeholder',
    user_want: 'see risks ranked by severity/impact in an ordered list',
    user_benefit: 'focus attention on highest-priority risks first',
    story_points: 3,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-011-1',
        scenario: 'Display risks in ranked order',
        given: 'List of 5 risks with different severity scores',
        when: 'RiskRankingList component renders',
        then: 'Risks display ordered by severity, highest first'
      },
      {
        id: 'AC-011-2',
        scenario: 'Show risk severity indicator',
        given: 'Risk with severity "critical"',
        when: 'Risk item renders',
        then: 'Red severity badge and rank number display'
      },
      {
        id: 'AC-011-3',
        scenario: 'Expandable risk details',
        given: 'Risk with mitigation strategies',
        when: 'User expands risk item',
        then: 'Full description and mitigation options display'
      },
      {
        id: 'AC-011-4',
        scenario: 'Risk category grouping option',
        given: 'User toggles "Group by category"',
        when: 'Toggle is enabled',
        then: 'Risks group by category (technical, market, financial) within ranking'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/RiskRankingList.tsx',
      'Ordered by severity',
      'Expandable items',
      'Optional category grouping'
    ],
    technical_notes: 'Use numbered list with Accordion. Sort by severity score.',
    implementation_approach: 'Ordered list with severity badges, expandable details, and grouping toggle.',
    implementation_context: 'Stage 5 (Risk Assessment) primary component. Used wherever risks are displayed.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/accordion.tsx',
      'US-UIP-004 AlertList for styling patterns'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-012',
    title: 'StageOutputViewer Master Component',
    user_role: 'stakeholder',
    user_want: 'view any IDEATION stage output in a unified, consistent interface',
    user_benefit: 'review all stage outputs with a single, learnable interface pattern',
    story_points: 8,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-012-1',
        scenario: 'Stage 1 output display',
        given: 'Venture Concept (Stage 1) output data',
        when: 'StageOutputViewer renders with stageId=1',
        then: 'Shows Problem Statement, Target Market, Value Proposition sections'
      },
      {
        id: 'AC-012-2',
        scenario: 'Stage 2 output display',
        given: 'Opportunity Analysis (Stage 2) output data',
        when: 'StageOutputViewer renders with stageId=2',
        then: 'Shows Market Analysis, Competitive Landscape, Opportunity Score sections'
      },
      {
        id: 'AC-012-3',
        scenario: 'Stage 6 output display',
        given: 'Decision Gate (Stage 6) output data',
        when: 'StageOutputViewer renders with stageId=6',
        then: 'Shows Final Decision, Summary Dashboard, Next Steps sections'
      },
      {
        id: 'AC-012-4',
        scenario: 'Cross-stage navigation',
        given: 'User is viewing Stage 3 output',
        when: 'User clicks "Next Stage" or stage tab',
        then: 'View transitions to selected stage output'
      },
      {
        id: 'AC-012-5',
        scenario: 'Error state handling',
        given: 'Stage output fails to load',
        when: 'StageOutputViewer renders',
        then: 'Error message displays with retry button'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/StageOutputViewer.tsx',
      'Handles all 6 stages',
      'Uses StageOutputCard as base',
      'Stage-specific content renderers',
      'Cross-stage navigation',
      'Error and loading states'
    ],
    technical_notes: 'Master component that orchestrates stage-specific sub-components.',
    implementation_approach: 'Router-like pattern: detect stage type, render appropriate sub-components.',
    implementation_context: 'THE primary deliverable for UI parity. Must support all 6 stages.',
    architecture_references: JSON.stringify([
      'US-UIP-006 StageOutputCard as base',
      'All Phase 1 and Phase 2 components',
      'ehg/src/hooks/useIdeationStage.ts for data fetching'
    ])
  },

  // ============================================================================
  // PHASE 3: STAGE-SPECIFIC ENHANCEMENTS (8 components, ~50 hours)
  // ============================================================================
  {
    story_key: 'SD-UI-PARITY-001:US-013',
    title: 'Stage 1 Venture Concept Viewer',
    user_role: 'stakeholder',
    user_want: 'see Stage 1 (Venture Concept) outputs with problem/solution visualization',
    user_benefit: 'understand the initial venture concept with clear problem-solution mapping',
    story_points: 5,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-013-1',
        scenario: 'Problem statement display',
        given: 'Stage 1 output with problem_statement',
        when: 'Viewer renders',
        then: 'Problem displayed prominently with pain points highlighted'
      },
      {
        id: 'AC-013-2',
        scenario: 'Solution overview display',
        given: 'Stage 1 output with proposed_solution',
        when: 'Viewer renders',
        then: 'Solution shows with key differentiators listed'
      },
      {
        id: 'AC-013-3',
        scenario: 'Target market summary',
        given: 'Stage 1 output with target_market',
        when: 'Viewer renders',
        then: 'Market segments display with size indicators'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/stages/Stage1Viewer.tsx',
      'Problem/solution visual mapping',
      'Target market visualization',
      'Integrated with StageOutputViewer'
    ],
    technical_notes: 'Focus on problem-solution fit visualization.',
    implementation_approach: 'Specialized content renderer for Stage 1 data fields.',
    implementation_context: 'First stage output - sets expectations for all other stages.',
    architecture_references: JSON.stringify([
      'Stage 1 contract schema',
      'US-UIP-012 StageOutputViewer integration'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-014',
    title: 'Stage 2 Opportunity Analysis Viewer',
    user_role: 'stakeholder',
    user_want: 'see Stage 2 (Opportunity Analysis) with market sizing and competitive analysis',
    user_benefit: 'evaluate market opportunity with data-driven visualizations',
    story_points: 5,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-014-1',
        scenario: 'Market size visualization',
        given: 'Stage 2 output with TAM, SAM, SOM data',
        when: 'Viewer renders',
        then: 'Nested circles or funnel chart shows market sizing'
      },
      {
        id: 'AC-014-2',
        scenario: 'Competitive landscape display',
        given: 'Stage 2 output with competitors array',
        when: 'Viewer renders',
        then: 'Competitor cards show with positioning matrix'
      },
      {
        id: 'AC-014-3',
        scenario: 'Opportunity score breakdown',
        given: 'Stage 2 output with sub-scores',
        when: 'Viewer renders',
        then: 'Radar or bar chart shows score components'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/stages/Stage2Viewer.tsx',
      'Market sizing chart (TAM/SAM/SOM)',
      'Competitor analysis cards',
      'Opportunity score visualization'
    ],
    technical_notes: 'Use Recharts for market sizing funnel and radar charts.',
    implementation_approach: 'Data visualization heavy - TAM/SAM/SOM, competitor matrix, score radar.',
    implementation_context: 'Heavy data visualization stage. Charts are critical.',
    architecture_references: JSON.stringify([
      'Recharts BarChart, RadarChart',
      'US-UIP-010 PerspectivePanel'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-015',
    title: 'Stage 3 Technical Feasibility Viewer',
    user_role: 'stakeholder',
    user_want: 'see Stage 3 (Technical Feasibility) with architecture and complexity analysis',
    user_benefit: 'understand technical requirements and implementation challenges',
    story_points: 5,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-015-1',
        scenario: 'Architecture overview display',
        given: 'Stage 3 output with architecture_components',
        when: 'Viewer renders',
        then: 'Component diagram or list shows system architecture'
      },
      {
        id: 'AC-015-2',
        scenario: 'Complexity indicators',
        given: 'Stage 3 output with complexity_scores',
        when: 'Viewer renders',
        then: 'Complexity displayed per domain (frontend, backend, infra)'
      },
      {
        id: 'AC-015-3',
        scenario: 'Technology stack display',
        given: 'Stage 3 output with recommended_stack',
        when: 'Viewer renders',
        then: 'Tech stack shows as categorized badges'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/stages/Stage3Viewer.tsx',
      'Architecture component visualization',
      'Complexity scores by domain',
      'Tech stack badges'
    ],
    technical_notes: 'Consider simple architecture diagram or component tree.',
    implementation_approach: 'Architecture visualization, complexity scores, tech stack list.',
    implementation_context: 'Technical stakeholders need clear architecture visibility.',
    architecture_references: JSON.stringify([
      'US-UIP-001 ScoreBar for complexity',
      'Badge component for tech stack'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-016',
    title: 'Stage 4 Business Model Viewer',
    user_role: 'stakeholder',
    user_want: 'see Stage 4 (Business Model) with revenue and financial projections',
    user_benefit: 'evaluate business viability with clear financial visualizations',
    story_points: 5,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-016-1',
        scenario: 'Revenue model display',
        given: 'Stage 4 output with revenue_streams',
        when: 'Viewer renders',
        then: 'Revenue streams show as pie chart or breakdown list'
      },
      {
        id: 'AC-016-2',
        scenario: 'Financial projections chart',
        given: 'Stage 4 output with 3-year projections',
        when: 'Viewer renders',
        then: 'Line chart shows revenue/cost projections over time'
      },
      {
        id: 'AC-016-3',
        scenario: 'Unit economics display',
        given: 'Stage 4 output with CAC, LTV, margins',
        when: 'Viewer renders',
        then: 'Key metrics display as prominently styled KPI cards'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/stages/Stage4Viewer.tsx',
      'Revenue breakdown chart',
      'Financial projections line chart',
      'Unit economics KPI cards'
    ],
    technical_notes: 'Use Recharts PieChart, LineChart. Format currency values.',
    implementation_approach: 'Financial charts - pie for revenue mix, line for projections, cards for KPIs.',
    implementation_context: 'Finance stakeholders need clear projections and metrics.',
    architecture_references: JSON.stringify([
      'Recharts PieChart, LineChart',
      'ehg/src/lib/format.ts for currency formatting'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-017',
    title: 'Stage 5 Risk Assessment Viewer',
    user_role: 'stakeholder',
    user_want: 'see Stage 5 (Risk Assessment) with risk matrix and mitigation strategies',
    user_benefit: 'understand all risks and their mitigation plans in one view',
    story_points: 5,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-017-1',
        scenario: 'Risk matrix display',
        given: 'Stage 5 output with risks array',
        when: 'Viewer renders',
        then: 'Risk matrix shows risks plotted by likelihood x impact'
      },
      {
        id: 'AC-017-2',
        scenario: 'Risk ranking list',
        given: 'Stage 5 output with ranked risks',
        when: 'Viewer renders',
        then: 'RiskRankingList shows risks in priority order'
      },
      {
        id: 'AC-017-3',
        scenario: 'Mitigation strategies display',
        given: 'Each risk has mitigation strategies',
        when: 'User expands risk item',
        then: 'Mitigation strategies show with owner and timeline'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/stages/Stage5Viewer.tsx',
      'Risk matrix visualization (likelihood x impact)',
      'Uses RiskRankingList component',
      'Mitigation strategy details'
    ],
    technical_notes: 'Risk matrix as scatter plot. Use RiskRankingList.',
    implementation_approach: 'Risk matrix (scatter), ranked list (RiskRankingList), mitigation accordion.',
    implementation_context: 'Critical for NO_GO decisions. Risk visibility is essential.',
    architecture_references: JSON.stringify([
      'US-UIP-011 RiskRankingList',
      'Recharts ScatterChart for risk matrix'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-018',
    title: 'Stage 6 Decision Gate Viewer',
    user_role: 'stakeholder',
    user_want: 'see Stage 6 (Decision Gate) with final recommendation and summary dashboard',
    user_benefit: 'make the final GO/NO_GO decision with all information synthesized',
    story_points: 5,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-018-1',
        scenario: 'Final decision banner',
        given: 'Stage 6 output with final_decision',
        when: 'Viewer renders',
        then: 'GateDecisionBanner shows prominently at top'
      },
      {
        id: 'AC-018-2',
        scenario: 'Summary dashboard',
        given: 'Stage 6 output with all stage scores',
        when: 'Viewer renders',
        then: 'Dashboard shows all 5 previous stage scores in grid'
      },
      {
        id: 'AC-018-3',
        scenario: 'Blockers summary',
        given: 'Stage 6 output with aggregated blockers',
        when: 'Viewer renders',
        then: 'BlockerChecklist shows all unresolved blockers'
      },
      {
        id: 'AC-018-4',
        scenario: 'Next steps guidance',
        given: 'Final decision is GO',
        when: 'Viewer renders',
        then: 'Next steps section shows Stage 7 readiness checklist'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/stages/Stage6Viewer.tsx',
      'Uses GateDecisionBanner',
      'Summary dashboard with all stage scores',
      'BlockerChecklist integration',
      'Next steps guidance'
    ],
    technical_notes: 'Synthesis view - pulls together all previous stage data.',
    implementation_approach: 'Dashboard layout with GateDecisionBanner, score grid, BlockerChecklist, next steps.',
    implementation_context: 'THE most critical stage for stakeholder decisions.',
    architecture_references: JSON.stringify([
      'US-UIP-007 GateDecisionBanner',
      'US-UIP-009 BlockerChecklist',
      'All stage score data'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-019',
    title: 'Cross-Stage Score Comparison View',
    user_role: 'stakeholder',
    user_want: 'compare scores and metrics across all 6 stages in one view',
    user_benefit: 'identify trends and patterns across the full ideation pipeline',
    story_points: 5,
    priority: 'medium',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-019-1',
        scenario: 'Score trend chart',
        given: 'Scores from all 6 stages',
        when: 'Comparison view renders',
        then: 'Line chart shows score progression across stages'
      },
      {
        id: 'AC-019-2',
        scenario: 'Stage-by-stage comparison table',
        given: 'Key metrics from all stages',
        when: 'Comparison view renders',
        then: 'Table shows metrics in columns by stage'
      },
      {
        id: 'AC-019-3',
        scenario: 'Highlight anomalies',
        given: 'One stage has significantly lower score',
        when: 'Comparison view renders',
        then: 'Anomalous stage is highlighted with warning indicator'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/CrossStageComparison.tsx',
      'Score trend line chart',
      'Comparison table',
      'Anomaly detection highlighting'
    ],
    technical_notes: 'Use Recharts LineChart. Highlight outliers with conditional styling.',
    implementation_approach: 'Line chart for trends, table for detailed comparison, anomaly highlighting.',
    implementation_context: 'Executive summary view for quick full-pipeline assessment.',
    architecture_references: JSON.stringify([
      'Recharts LineChart',
      'ehg/src/components/ui/table.tsx'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-020',
    title: 'Stage Navigation Sidebar',
    user_role: 'stakeholder',
    user_want: 'navigate between stages using a persistent sidebar with status indicators',
    user_benefit: 'always know where I am in the pipeline and quickly jump to any stage',
    story_points: 3,
    priority: 'medium',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-020-1',
        scenario: 'Display all 6 stages',
        given: 'Venture with all stages completed',
        when: 'Sidebar renders',
        then: 'All 6 stages show with names and completion status'
      },
      {
        id: 'AC-020-2',
        scenario: 'Stage status indicators',
        given: 'Stage 3 has NO_GO decision',
        when: 'Sidebar renders',
        then: 'Stage 3 shows red indicator, subsequent stages grayed out'
      },
      {
        id: 'AC-020-3',
        scenario: 'Current stage highlight',
        given: 'User is viewing Stage 4',
        when: 'Sidebar renders',
        then: 'Stage 4 is visually highlighted as current'
      },
      {
        id: 'AC-020-4',
        scenario: 'Click to navigate',
        given: 'User clicks Stage 2 in sidebar',
        when: 'Click event fires',
        then: 'View transitions to Stage 2 output'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/StageNavigation.tsx',
      'Shows all 6 stages',
      'Status indicators per stage',
      'Click navigation works',
      'Current stage highlighted'
    ],
    technical_notes: 'Vertical list with status badges. Use DecisionBadge for status.',
    implementation_approach: 'Vertical navigation list with status badges and click handlers.',
    implementation_context: 'Persistent navigation for all stage viewers.',
    architecture_references: JSON.stringify([
      'US-UIP-002 DecisionBadge for status',
      'React Router or state management for navigation'
    ])
  },

  // ============================================================================
  // PHASE 4: POLISH & INTEGRATION (5 components, ~35 hours)
  // ============================================================================
  {
    story_key: 'SD-UI-PARITY-001:US-021',
    title: 'Evidence Reference Links',
    user_role: 'stakeholder',
    user_want: 'click on evidence citations to see source details',
    user_benefit: 'verify claims and understand the basis for conclusions',
    story_points: 3,
    priority: 'medium',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-021-1',
        scenario: 'Display citation links',
        given: 'Finding with source_reference',
        when: 'Finding renders',
        then: 'Clickable citation link appears next to claim'
      },
      {
        id: 'AC-021-2',
        scenario: 'Citation popover',
        given: 'User hovers over citation',
        when: 'Hover event fires',
        then: 'Popover shows source details (title, URL, date)'
      },
      {
        id: 'AC-021-3',
        scenario: 'Open source link',
        given: 'User clicks citation with external URL',
        when: 'Click event fires',
        then: 'External link opens in new tab'
      }
    ],
    definition_of_done: [
      'Component created at ehg/src/components/ideation/ui/EvidenceLink.tsx',
      'Clickable citation links',
      'Hover popover with details',
      'External links open safely'
    ],
    technical_notes: 'Use HoverCard component. rel="noopener noreferrer" for external links.',
    implementation_approach: 'Inline links with HoverCard for previews.',
    implementation_context: 'Adds credibility and traceability to all findings.',
    architecture_references: JSON.stringify([
      'ehg/src/components/ui/hover-card.tsx',
      'Link with target="_blank"'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-022',
    title: 'Export Stage Output to PDF',
    user_role: 'stakeholder',
    user_want: 'export any stage output to PDF for offline review or sharing',
    user_benefit: 'share stage outputs with stakeholders who do not have system access',
    story_points: 5,
    priority: 'low',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-022-1',
        scenario: 'Export button visible',
        given: 'User is viewing any stage output',
        when: 'Viewer renders',
        then: 'Export to PDF button is visible in toolbar'
      },
      {
        id: 'AC-022-2',
        scenario: 'Generate PDF',
        given: 'User clicks Export to PDF',
        when: 'Export triggers',
        then: 'PDF generates with current stage content and charts'
      },
      {
        id: 'AC-022-3',
        scenario: 'PDF includes visuals',
        given: 'Stage has charts and graphs',
        when: 'PDF generates',
        then: 'All charts render correctly in PDF'
      }
    ],
    definition_of_done: [
      'Export function at ehg/src/lib/exportPdf.ts',
      'Works for all 6 stages',
      'Charts render correctly',
      'Reasonable file size'
    ],
    technical_notes: 'Use react-to-pdf or html2canvas + jsPDF.',
    implementation_approach: 'Client-side PDF generation with chart rendering.',
    implementation_context: 'Nice-to-have for offline sharing. Lower priority.',
    architecture_references: JSON.stringify([
      'react-to-pdf library',
      'html2canvas for chart capture'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-023',
    title: 'Responsive Layout for Stage Viewers',
    user_role: 'stakeholder',
    user_want: 'view stage outputs on tablet and mobile devices',
    user_benefit: 'review stage outputs during meetings without needing laptop',
    story_points: 5,
    priority: 'medium',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-023-1',
        scenario: 'Tablet layout',
        given: 'User views on 768px width tablet',
        when: 'Stage viewer renders',
        then: 'Layout adapts with sidebar collapsible, charts resize'
      },
      {
        id: 'AC-023-2',
        scenario: 'Mobile layout',
        given: 'User views on 375px width phone',
        when: 'Stage viewer renders',
        then: 'Single column layout, bottom navigation, touch-friendly'
      },
      {
        id: 'AC-023-3',
        scenario: 'Charts remain readable',
        given: 'User views chart on mobile',
        when: 'Chart renders',
        then: 'Chart is readable with appropriate minimum size or scrollable'
      }
    ],
    definition_of_done: [
      'All stage viewers responsive',
      'Breakpoints: 640px (mobile), 768px (tablet), 1024px (desktop)',
      'Touch-friendly on mobile',
      'Charts scale appropriately'
    ],
    technical_notes: 'Use Tailwind responsive classes. Consider ResponsiveContainer for Recharts.',
    implementation_approach: 'Tailwind responsive utilities, collapsible sidebar, chart ResponsiveContainer.',
    implementation_context: 'Desktop-first but mobile-accessible is the goal.',
    architecture_references: JSON.stringify([
      'Tailwind CSS responsive prefixes',
      'Recharts ResponsiveContainer'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-024',
    title: 'Accessibility Audit and Fixes',
    user_role: 'user with disabilities',
    user_want: 'use stage viewers with screen readers and keyboard navigation',
    user_benefit: 'access all stage information regardless of ability',
    story_points: 5,
    priority: 'high',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-024-1',
        scenario: 'Screen reader compatibility',
        given: 'User navigates with screen reader',
        when: 'Stage viewer renders',
        then: 'All interactive elements have proper ARIA labels'
      },
      {
        id: 'AC-024-2',
        scenario: 'Keyboard navigation',
        given: 'User navigates with keyboard only',
        when: 'User tabs through page',
        then: 'All interactive elements are reachable and operable'
      },
      {
        id: 'AC-024-3',
        scenario: 'Color contrast',
        given: 'WCAG 2.1 AA requirements',
        when: 'Stage viewer renders',
        then: 'All text meets 4.5:1 contrast ratio minimum'
      },
      {
        id: 'AC-024-4',
        scenario: 'Chart accessibility',
        given: 'User cannot see charts',
        when: 'Charts render',
        then: 'Alternative text or data table available for charts'
      }
    ],
    definition_of_done: [
      'WCAG 2.1 AA compliance verified',
      'axe-core audit passes',
      'Keyboard navigation tested',
      'Screen reader tested with NVDA or VoiceOver'
    ],
    technical_notes: 'Use axe-core for automated testing. Manual testing with NVDA/VoiceOver.',
    implementation_approach: 'Audit all components, add ARIA labels, ensure keyboard focus management.',
    implementation_context: 'Required for enterprise compliance. High priority.',
    architecture_references: JSON.stringify([
      '@axe-core/react for automated testing',
      'WCAG 2.1 guidelines'
    ])
  },

  {
    story_key: 'SD-UI-PARITY-001:US-025',
    title: 'E2E Tests for All Stage Viewers',
    user_role: 'developer',
    user_want: 'automated E2E tests verifying all stage viewer functionality',
    user_benefit: 'catch regressions before they reach stakeholders',
    story_points: 8,
    priority: 'critical',
    status: 'draft',
    acceptance_criteria: [
      {
        id: 'AC-025-1',
        scenario: 'Stage 1-6 render tests',
        given: 'E2E test suite runs',
        when: 'Tests execute for each stage',
        then: 'All 6 stage viewers render without errors'
      },
      {
        id: 'AC-025-2',
        scenario: 'Navigation tests',
        given: 'E2E test navigates between stages',
        when: 'Navigation clicks execute',
        then: 'Stage transitions work correctly'
      },
      {
        id: 'AC-025-3',
        scenario: 'Component interaction tests',
        given: 'E2E test interacts with expandable sections',
        when: 'Click events fire',
        then: 'Sections expand/collapse correctly'
      },
      {
        id: 'AC-025-4',
        scenario: 'Data display verification',
        given: 'E2E test with known test data',
        when: 'Stage viewer renders',
        then: 'Expected data values are visible in rendered output'
      }
    ],
    definition_of_done: [
      'E2E tests at ehg/tests/e2e/ideation-ui-parity.spec.ts',
      'Coverage for all 6 stages',
      'Navigation tests',
      'Component interaction tests',
      'Passing in CI/CD pipeline'
    ],
    technical_notes: 'Use Playwright. Follow US-XXX naming convention for mapping.',
    implementation_approach: 'Playwright tests for each stage, navigation, and key interactions.',
    implementation_context: 'MANDATORY for SD completion per LEO Protocol.',
    architecture_references: JSON.stringify([
      'ehg/tests/e2e/ - existing E2E tests',
      'Playwright test patterns',
      'US-UIP-XXX naming for test mapping'
    ])
  }
];

// ============================================================================
// INSERT FUNCTION
// ============================================================================

async function insertUserStories() {
  console.log('='.repeat(70));
  console.log('STORIES Sub-Agent: User Story Generation for SD-UI-PARITY-001');
  console.log('='.repeat(70));
  console.log('');
  console.log('SD: SD-UI-PARITY-001 - IDEATION Stages 1-6 UI Component Backfill');
  console.log('Total Stories: 25');
  console.log('Total Story Points: ' + userStories.reduce((sum, s) => sum + s.story_points, 0));
  console.log('');

  // Check if stories already exist
  const { data: existing, error: checkError } = await supabase
    .from('user_stories')
    .select('story_key')
    .eq('sd_id', SD_ID);

  if (checkError) {
    console.error('Error checking existing stories:', checkError.message);
    process.exit(1);
  }

  if (existing && existing.length > 0) {
    console.log(`WARNING: ${existing.length} stories already exist for ${SD_ID}`);
    console.log('Existing stories:', existing.map(s => s.story_key).join(', '));
    console.log('');
    console.log('To replace, first delete existing stories:');
    console.log(`  DELETE FROM user_stories WHERE sd_id = '${SD_ID}';`);
    console.log('');

    const readline = await import('readline');
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    const answer = await new Promise(resolve => {
      rl.question('Delete existing stories and insert new ones? (yes/no): ', resolve);
    });
    rl.close();

    if (answer.toLowerCase() === 'yes') {
      const { error: deleteError } = await supabase
        .from('user_stories')
        .delete()
        .eq('sd_id', SD_ID);

      if (deleteError) {
        console.error('Error deleting existing stories:', deleteError.message);
        process.exit(1);
      }
      console.log('Deleted existing stories.');
    } else {
      console.log('Aborting. No changes made.');
      process.exit(0);
    }
  }

  // Insert stories
  console.log('Inserting user stories...');
  console.log('');

  let successCount = 0;
  let errorCount = 0;

  for (const story of userStories) {
    const insertData = {
      sd_id: SD_ID,
      prd_id: null, // No PRD yet
      story_key: story.story_key,
      title: story.title,
      user_role: story.user_role,
      user_want: story.user_want,
      user_benefit: story.user_benefit,
      story_points: story.story_points,
      priority: story.priority,
      status: story.status,
      acceptance_criteria: story.acceptance_criteria,
      definition_of_done: story.definition_of_done,
      technical_notes: story.technical_notes,
      implementation_approach: story.implementation_approach,
      implementation_context: story.implementation_context,
      architecture_references: story.architecture_references,
      example_code_patterns: story.example_code_patterns || null,
      testing_scenarios: story.testing_scenarios || null,
      created_by: 'STORIES',
      validation_status: 'pending'
    };

    const { error } = await supabase
      .from('user_stories')
      .insert(insertData);

    if (error) {
      console.error(`  ERROR: ${story.story_key} - ${error.message}`);
      errorCount++;
    } else {
      console.log(`  OK: ${story.story_key} - ${story.title.substring(0, 50)}...`);
      successCount++;
    }
  }

  console.log('');
  console.log('='.repeat(70));
  console.log('SUMMARY');
  console.log('='.repeat(70));
  console.log(`Inserted: ${successCount} stories`);
  console.log(`Errors: ${errorCount} stories`);
  console.log('');

  if (successCount > 0) {
    // Print phase breakdown
    console.log('Phase Breakdown:');
    console.log('  Phase 1 (Foundation): US-UIP-001 to US-UIP-006 (6 stories, ~25 hours)');
    console.log('  Phase 2 (Critical):   US-UIP-007 to US-UIP-012 (6 stories, ~40 hours)');
    console.log('  Phase 3 (Stage-Specific): US-UIP-013 to US-UIP-020 (8 stories, ~50 hours)');
    console.log('  Phase 4 (Polish):     US-UIP-021 to US-UIP-025 (5 stories, ~35 hours)');
    console.log('');
    console.log('Priority Breakdown:');
    const critical = userStories.filter(s => s.priority === 'critical').length;
    const high = userStories.filter(s => s.priority === 'high').length;
    const medium = userStories.filter(s => s.priority === 'medium').length;
    const low = userStories.filter(s => s.priority === 'low').length;
    console.log(`  Critical: ${critical} stories`);
    console.log(`  High: ${high} stories`);
    console.log(`  Medium: ${medium} stories`);
    console.log(`  Low: ${low} stories`);
    console.log('');
    console.log('Next Steps:');
    console.log('  1. Create PRD for SD-UI-PARITY-001');
    console.log('  2. Link user stories to PRD');
    console.log('  3. Begin EXEC phase with Phase 1 (Foundation) stories');
  }
}

// ============================================================================
// RUN
// ============================================================================

insertUserStories().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
