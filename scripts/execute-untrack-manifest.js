#!/usr/bin/env node

/**
 * Execute Untrack Manifest
 *
 * Reads untrack-manifest.json and removes files from git tracking.
 * Dry-run by default - use --force to actually untrack.
 *
 * Usage:
 *   npm run untrack:execute              # Dry run (preview)
 *   npm run untrack:execute -- --force   # Actually untrack files
 *
 * Requires: untrack-manifest.json (generated by generate-untrack-manifest.js)
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.join(__dirname, '..');

const DRY_RUN = !process.argv.includes('--force');
const VERBOSE = process.argv.includes('--verbose');

// ============================================================================
// MAIN
// ============================================================================

function main() {
  console.log('='.repeat(60));
  console.log('EXECUTE UNTRACK MANIFEST');
  console.log('='.repeat(60));
  console.log(`Mode: ${DRY_RUN ? 'DRY RUN (use --force to execute)' : 'FORCE MODE'}`);
  console.log('');

  // Read manifest
  const manifestPath = path.join(PROJECT_ROOT, 'untrack-manifest.json');
  if (!fs.existsSync(manifestPath)) {
    console.error('ERROR: untrack-manifest.json not found');
    console.error('Run: npm run untrack:manifest');
    process.exit(1);
  }

  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  const files = manifest.files_to_untrack || [];

  console.log(`Files in manifest: ${files.length}`);
  console.log('');

  if (files.length === 0) {
    console.log('No files to untrack.');
    return;
  }

  // Stats
  let untracked = 0;
  let skipped = 0;
  let errors = 0;

  // Process each file
  for (const file of files) {
    const filePath = file.path;

    // Verify file is still tracked
    try {
      execSync(`git ls-files --error-unmatch "${filePath}"`, {
        cwd: PROJECT_ROOT,
        stdio: 'pipe'
      });
    } catch {
      if (VERBOSE) {
        console.log(`SKIP (not tracked): ${filePath}`);
      }
      skipped++;
      continue;
    }

    if (DRY_RUN) {
      console.log(`[DRY-RUN] Would untrack: ${filePath} (${file.reason})`);
      untracked++;
    } else {
      try {
        execSync(`git rm --cached "${filePath}"`, {
          cwd: PROJECT_ROOT,
          stdio: 'pipe'
        });
        console.log(`UNTRACKED: ${filePath}`);
        untracked++;
      } catch (error) {
        console.error(`ERROR: ${filePath} - ${error.message}`);
        errors++;
      }
    }
  }

  // Summary
  console.log('');
  console.log('-'.repeat(60));
  console.log('SUMMARY');
  console.log('-'.repeat(60));
  console.log(`${DRY_RUN ? 'Would untrack' : 'Untracked'}: ${untracked}`);
  console.log(`Skipped (already untracked): ${skipped}`);
  if (errors > 0) console.log(`Errors: ${errors}`);

  if (!DRY_RUN && untracked > 0) {
    console.log('');
    console.log('Files have been untracked from git.');
    console.log('');
    console.log('Next steps:');
    console.log('  1. Review: git status');
    console.log('  2. Commit: git commit -m "chore: Untrack temp files from git tracking"');
    console.log('');
  } else if (DRY_RUN && untracked > 0) {
    console.log('');
    console.log('Run with --force to actually untrack these files:');
    console.log('  npm run untrack:execute -- --force');
    console.log('');
  }

  console.log('='.repeat(60));
}

main();
