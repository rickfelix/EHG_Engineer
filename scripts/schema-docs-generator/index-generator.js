/**
 * Schema Documentation Generator - Index Generator
 * Generates the README index document
 */

import { categorizeTables } from './overview-generator.js';

/**
 * Generate the README index document
 * @param {Array} tables - Array of table info
 * @param {Object} context - Generator context
 * @returns {string} Markdown content
 */
export function generateIndex(tables, context) {
  const { appName, appDescription, appPath, appPurpose, projectId, generatedAt } = context;

  let md = '# Database Schema Documentation\n\n';
  md += `**Application**: ${appName} - ${appDescription}\n`;
  md += `**Database**: ${projectId}\n`;
  md += `**Repository**: ${appPath}\n`;
  md += `**Purpose**: ${appPurpose}\n`;
  md += `**Generated**: ${generatedAt}\n`;
  md += `**Tables**: ${tables.length}\n\n`;
  md += `This directory contains comprehensive, auto-generated documentation for all tables in the **${appName}** Supabase database.\n\n`;
  md += `⚠️ **CRITICAL**: This schema is for **${appName}** database. Implementations go in ${appPath}\n\n`;
  md += '---\n\n';

  md += '## Quick Start\n\n';
  md += '- **[Database Schema Overview](database-schema-overview.md)** - Quick reference for all tables (15-20KB)\n';
  md += '- **[Detailed Table Docs](tables/)** - Individual files for each table (2-5KB each)\n\n';
  md += '---\n\n';

  md += `## All Tables (${tables.length})\n\n`;

  const categories = categorizeTables(tables);

  for (const [category, categoryTables] of Object.entries(categories)) {
    md += `### ${category}\n\n`;

    for (const table of categoryTables) {
      md += `- [${table.table_name}](tables/${table.table_name}.md)\n`;
    }

    md += '\n';
  }

  md += '---\n\n';
  md += '## Regenerating Documentation\n\n';
  md += '```bash\n';
  md += '# Generate all documentation\n';
  md += 'npm run schema:docs\n\n';
  md += '# Generate single table\n';
  md += 'npm run schema:docs:table users\n\n';
  md += '# Debug mode\n';
  md += 'npm run schema:docs --verbose\n';
  md += '```\n\n';
  md += 'Documentation is automatically regenerated:\n';
  md += '- After every successful migration (post-migration hook)\n';
  md += '- Weekly via CI/CD (GitHub Actions)\n';
  md += '- Manually via npm scripts\n\n';
  md += '---\n\n';
  md += '*Auto-generated by: `scripts/generate-schema-docs-from-db.js`*\n';

  return md;
}
