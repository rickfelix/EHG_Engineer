/**
 * generate-playground-config.cjs
 * Reads Supabase credentials from .env and writes playground.config.js
 * for the LEO Visual Playground to auto-connect without URL params.
 *
 * Usage:
 *   node scripts/generate-playground-config.cjs          # generate config
 *   node scripts/generate-playground-config.cjs --open   # generate + open browser
 */
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const ROOT = path.resolve(__dirname, '..');
const ENV_PATH = path.join(ROOT, '.env');
const OUT_PATH = path.join(ROOT, 'playground.config.js');
const HTML_FILE = path.join(ROOT, 'leo-visual-playground.html');

// Parse .env manually (no dotenv dependency needed)
function parseEnv(filePath) {
  if (!fs.existsSync(filePath)) return {};
  const vars = {};
  for (const line of fs.readFileSync(filePath, 'utf8').split('\n')) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    const eq = trimmed.indexOf('=');
    if (eq === -1) continue;
    vars[trimmed.slice(0, eq).trim()] = trimmed.slice(eq + 1).trim();
  }
  return vars;
}

const env = parseEnv(ENV_PATH);

const url = env.NEXT_PUBLIC_SUPABASE_URL || env.SUPABASE_URL || '';
const key = env.NEXT_PUBLIC_SUPABASE_ANON_KEY || env.SUPABASE_ANON_KEY || '';

if (!url || !key) {
  console.error('ERROR: Missing Supabase credentials in .env');
  console.error('Required: NEXT_PUBLIC_SUPABASE_URL + NEXT_PUBLIC_SUPABASE_ANON_KEY (or SUPABASE_URL + SUPABASE_ANON_KEY)');
  process.exit(1);
}

// Safety: refuse to write the service role key
const serviceKey = env.SUPABASE_SERVICE_ROLE_KEY || '';
if (serviceKey && key === serviceKey) {
  console.error('ERROR: Refusing to write the service role key to a browser-accessible file.');
  console.error('Use the anon key (SUPABASE_ANON_KEY) instead.');
  process.exit(1);
}

const content = `// Auto-generated by: npm run playground:config
// DO NOT COMMIT — this file is gitignored
window.__PLAYGROUND_CONFIG = {
  SUPABASE_URL: ${JSON.stringify(url)},
  SUPABASE_KEY: ${JSON.stringify(key)}
};
`;

fs.writeFileSync(OUT_PATH, content, 'utf8');
console.log('✓ playground.config.js written');

if (process.argv.includes('--open')) {
  const fileUrl = 'file:///' + HTML_FILE.replace(/\\/g, '/');
  console.log('Opening:', fileUrl);
  try {
    if (process.platform === 'win32') execSync(`start "" "${fileUrl}"`, { shell: true });
    else if (process.platform === 'darwin') execSync(`open "${fileUrl}"`);
    else execSync(`xdg-open "${fileUrl}"`);
  } catch { console.error('Could not open browser automatically. Open manually:', fileUrl); }
}
