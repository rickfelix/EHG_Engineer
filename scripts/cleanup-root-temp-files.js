#!/usr/bin/env node

/**
 * Root Temp File Cleaner
 *
 * Safely removes accumulated temp files from project root.
 * Part of LEO Protocol workflow hygiene.
 *
 * Usage:
 *   npm run leo:cleanup:root           # Dry run (default)
 *   npm run leo:cleanup:root:force     # Actually delete
 *
 * Safety features:
 * - Whitelist of known legitimate root files
 * - Dry-run mode by default
 * - Detailed logging
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.join(__dirname, '..');

// Configuration
const CONFIG = {
  dryRun: !process.argv.includes('--force'),
  verbose: process.argv.includes('--verbose'),

  // Whitelisted root-level files (never delete)
  whitelist: [
    // Config files (pattern-based)
    /\.config\.(js|mjs|cjs)$/,
    /^tsconfig.*\.json$/,
    // Specific config files
    '.claude-code-config.json',
    'leo-protocol-config.json',
    'dashboard-config.json',
    // Essential files
    'package.json',
    'package-lock.json',
    '.gitignore',
    '.env.example',
    '.nvmrc',
    '.node-version',
    // Documentation
    'README.md',
    'CLAUDE.md',
    'CLAUDE_CORE.md',
    'CLAUDE_LEAD.md',
    'CLAUDE_PLAN.md',
    'CLAUDE_EXEC.md',
    'LICENSE',
    'CONTRIBUTING.md',
    // Tracked utility scripts
    'fix-all-modules.js',
    'fix-module-system.js',
    'fix-shebangs.js',
    'audit_rls.js',
    // Manifest files (generated by untrack tools)
    'untrack-manifest.json'
  ],

  // Temp file patterns to clean (comprehensive)
  tempPatterns: [
    // LEO workflow artifacts
    { pattern: /_APPLIED\.md$/, description: 'Applied markers' },
    { pattern: /-quality-report\.md$/, description: 'Quality reports' },
    { pattern: /-stories-summary\.json$/, description: 'Story summaries' },
    { pattern: /^credential-scan-results\.json$/, description: 'Scan results' },
    { pattern: /^SD-.*-README\.md$/, description: 'SD READMEs' },
    { pattern: /^SD-.*-database-analysis\.md$/, description: 'DB analysis' },

    // One-off scripts at root
    { pattern: /\.mjs$/, description: 'One-off .mjs script' },
    { pattern: /\.cjs$/, description: 'One-off .cjs script' },

    // Report and artifact JSONs
    { pattern: /-report.*\.json$/, description: 'Report JSON' },
    { pattern: /^handoff-.*\.json$/, description: 'Handoff artifact' },
    { pattern: /^compliance-.*\.json$/, description: 'Compliance file' },
    { pattern: /^cost-.*\.json$/, description: 'Cost file' },
    { pattern: /^directive-.*\.json$/, description: 'Directive file' },
    { pattern: /^documentation-.*\.json$/, description: 'Doc file' },
    { pattern: /^security-.*\.json$/, description: 'Security file' },
    { pattern: /^verification-.*\.json$/, description: 'Verification file' },
    { pattern: /-progress\.json$/, description: 'Progress file' },
    { pattern: /-metrics\.json$/, description: 'Metrics file' },

    // Screenshots
    { pattern: /\.png$/, description: 'Screenshot' },

    // One-off JS scripts (specific prefixes)
    { pattern: /^analyze-.*\.js$/, description: 'Analysis script' },
    { pattern: /^cancel-.*\.js$/, description: 'Cancel script' },
    { pattern: /^capture-.*\.js$/, description: 'Capture script' },
    { pattern: /^check-.*\.js$/, description: 'Check script' },
    { pattern: /^complete-.*\.js$/, description: 'Complete script' },
    { pattern: /^create-.*\.js$/, description: 'Creation script' },
    { pattern: /^debug-.*\.js$/, description: 'Debug script' },
    { pattern: /^demo-.*\.js$/, description: 'Demo script' },
    { pattern: /^enhance-.*\.js$/, description: 'Enhance script' },
    { pattern: /^fetch-.*\.js$/, description: 'Fetch script' },
    { pattern: /^find-.*\.js$/, description: 'Find script' },
    { pattern: /^generate-.*\.js$/, description: 'Generate script' },
    { pattern: /^get-.*\.js$/, description: 'Get script' },
    { pattern: /^implement-.*\.js$/, description: 'Implement script' },
    { pattern: /^lead-.*\.js$/, description: 'Lead script' },
    { pattern: /^map-.*\.js$/, description: 'Map script' },
    { pattern: /^prepare-.*\.js$/, description: 'Prepare script' },
    { pattern: /^query-.*\.js$/, description: 'Query script' },
    { pattern: /^reconstruct-.*\.js$/, description: 'Reconstruct script' },
    { pattern: /^reject-.*\.js$/, description: 'Reject script' },
    { pattern: /^rollback-.*\.js$/, description: 'Rollback script' },
    { pattern: /^run-.*\.js$/, description: 'Run script' },
    { pattern: /^store-.*\.js$/, description: 'Store script' },
    { pattern: /^sync-.*\.js$/, description: 'Sync script' },
    { pattern: /^temp-.*\.js$/, description: 'Temp script' },
    { pattern: /^test-.*\.js$/, description: 'Test script' },
    { pattern: /^toggle-.*\.js$/, description: 'Toggle script' },
    { pattern: /^update-.*\.js$/, description: 'Update script' },
    { pattern: /^verify-.*\.js$/, description: 'Verify script' }
  ]
};

// Statistics
const stats = {
  scanned: 0,
  matched: 0,
  deleted: 0,
  byType: {}
};

function isWhitelisted(filename) {
  for (const entry of CONFIG.whitelist) {
    if (typeof entry === 'string' && filename === entry) return true;
    if (entry instanceof RegExp && entry.test(filename)) return true;
  }
  return false;
}

function isTempFile(filename) {
  // Never delete whitelisted files
  if (isWhitelisted(filename)) {
    return null;
  }

  // Check against temp patterns
  for (const { pattern, description } of CONFIG.tempPatterns) {
    if (pattern.test(filename)) {
      return { description };
    }
  }

  return null;
}

function scanAndClean() {
  console.log('='.repeat(60));
  console.log('LEO Root Temp File Cleaner');
  console.log('='.repeat(60));
  console.log(`Mode: ${CONFIG.dryRun ? 'DRY-RUN (use --force to delete)' : 'FORCE DELETE'}`);
  console.log(`Project root: ${PROJECT_ROOT}`);
  console.log('');

  // Read root directory
  const entries = fs.readdirSync(PROJECT_ROOT, { withFileTypes: true });

  for (const entry of entries) {
    // Only check files, not directories
    if (!entry.isFile()) continue;

    stats.scanned++;
    const filePath = path.join(PROJECT_ROOT, entry.name);
    const tempInfo = isTempFile(entry.name);

    if (!tempInfo) continue;

    stats.matched++;
    stats.byType[tempInfo.description] = (stats.byType[tempInfo.description] || 0) + 1;

    if (CONFIG.dryRun) {
      console.log(`  [DRY-RUN] Would delete: ${entry.name} (${tempInfo.description})`);
    } else {
      try {
        fs.unlinkSync(filePath);
        console.log(`  DELETED: ${entry.name}`);
        stats.deleted++;
      } catch (err) {
        console.error(`  ERROR: ${entry.name} - ${err.message}`);
      }
    }
  }

  // Also check temp directories
  const tempDirs = ['sub-agents', 'validation'];
  for (const dirName of tempDirs) {
    const dirPath = path.join(PROJECT_ROOT, dirName);
    if (fs.existsSync(dirPath) && fs.statSync(dirPath).isDirectory()) {
      stats.matched++;
      if (CONFIG.dryRun) {
        console.log(`  [DRY-RUN] Would delete directory: ${dirName}/`);
      } else {
        try {
          fs.rmSync(dirPath, { recursive: true });
          console.log(`  DELETED: ${dirName}/`);
          stats.deleted++;
        } catch (err) {
          console.error(`  ERROR: ${dirName}/ - ${err.message}`);
        }
      }
    }
  }

  // Summary
  console.log('');
  console.log('-'.repeat(60));
  console.log('Summary');
  console.log('-'.repeat(60));
  console.log(`Files scanned:    ${stats.scanned}`);
  console.log(`Temp files found: ${stats.matched}`);
  console.log(`Deleted:          ${stats.deleted}`);
  console.log('');

  if (Object.keys(stats.byType).length > 0) {
    console.log('By type:');
    for (const [type, count] of Object.entries(stats.byType)) {
      console.log(`  ${type}: ${count}`);
    }
  }

  if (CONFIG.dryRun && stats.matched > 0) {
    console.log('');
    console.log('Run with --force to actually delete these files.');
  }

  console.log('='.repeat(60));
}

scanAndClean();
