# Handoff In - Resume from Account Switch

Pull latest changes, restore session context from a previous `/handoff-out`, sync memory, and display a full context briefing.

## Instructions

Execute ALL steps below in order. This is a fully automated sequence - do not ask for confirmation between steps.

### Step 1: Pull Latest Changes

```bash
git pull
```

If there are local uncommitted changes that conflict, stash them first:
```bash
git stash
git pull
git stash pop
```

### Step 2: Read Handoff State

Read the file `.claude/handoff-state.json` using the Read tool.

If the file doesn't exist or is empty, display:
```
============================================================
  HANDOFF IN - No Handoff State Found
============================================================

  No .claude/handoff-state.json found.
  The other account may not have run /handoff-out,
  or the push hasn't been pulled yet.

  Starting fresh. Run 'npm run sd:next' to see the SD queue.
============================================================
```
Then stop.

### Step 3: Sync Shared Memory

Read `.claude/shared-memory/MEMORY.md` if it exists.

Compare it with the local auto-memory at:
`C:\Users\rickf\.claude\projects\C--Users-rickf-Projects--EHG-EHG-Engineer\memory\MEMORY.md`

**If on the same machine (same OS user)**: Memory is already shared via the filesystem. Display:
```
Memory: Shared automatically (same machine)
```

**If shared-memory has content not in local memory** (different machine scenario):
1. Read both files
2. Identify sections in shared-memory that are missing from local memory
3. Append the missing sections to the local auto-memory file
4. Display what was synced:
```
Memory: Synced N new sections from shared-memory
  - <section name 1>
  - <section name 2>
```

**If both are identical or shared-memory doesn't exist**:
```
Memory: Up to date (no sync needed)
```

### Step 4: Query Current Database State

Get the latest SD and session state from the database (may have changed since handoff):

```bash
node -e "
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');
const sb = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);

(async () => {
  // Get is_working_on SD
  const { data: workingOn } = await sb.from('strategic_directives_v2')
    .select('sd_key, title, sd_type, status, current_phase')
    .eq('is_working_on', true)
    .limit(1)
    .single();

  // Get any stale sessions that need cleanup
  const { data: staleSessions } = await sb.from('v_active_sessions')
    .select('session_id, sd_id, heartbeat_age_human, computed_status')
    .in('computed_status', ['stale', 'active']);

  console.log(JSON.stringify({
    working_on: workingOn,
    sessions: staleSessions || []
  }, null, 2));
})();
"
```

### Step 5: Display Context Briefing

Using the handoff state file AND current database state, display:

```
============================================================
  HANDOFF IN - Context Restored
============================================================

  Handoff From:  <outgoing_account> at <timestamp>
  Time Elapsed:  <time since handoff>

------------------------------------------------------------
  GIT STATE
------------------------------------------------------------
  Branch:        <branch>
  Recent Commits:
    <commit 1>
    <commit 2>
    <commit 3>

------------------------------------------------------------
  ACTIVE WORK
------------------------------------------------------------
  SD:            <sd_key> - <title>
  Type:          <sd_type>
  Phase:         <phase>
  Status:        <status>

------------------------------------------------------------
  SESSION CONTEXT
------------------------------------------------------------
  AUTO-PROCEED:  <on/off>
  Last Phase:    <last handoff/phase>
  Working Files: <file list>

------------------------------------------------------------
  HANDOFF NOTES
------------------------------------------------------------
  <user-provided notes from the outgoing session>

  Auto-Summary:
  <auto-generated summary from outgoing session>

------------------------------------------------------------
  MEMORY SYNC
------------------------------------------------------------
  <memory sync status from Step 3>

------------------------------------------------------------
  STALE SESSIONS
------------------------------------------------------------
  <list any stale sessions that may need cleanup, or "None">

============================================================
  RECOMMENDED NEXT STEPS
============================================================
```

### Step 6: Recommend Next Steps

Based on the handoff state, suggest the appropriate action:

**If an SD is active and in EXEC phase:**
```
  1. Continue implementation: The previous session was in EXEC phase
     Load context: Read CLAUDE_EXEC.md then resume coding
  2. Check progress: npm run sd:status
```

**If an SD is active and in LEAD phase:**
```
  1. Continue LEAD review: Read CLAUDE_LEAD.md
  2. Check SD details: npm run sd:status
```

**If an SD just completed (LEAD-FINAL-APPROVAL done):**
```
  1. Run post-completion: /document -> /ship -> /learn
  2. Next SD: npm run sd:next
```

**If no active SD:**
```
  1. See SD queue: npm run sd:next
  2. Check recent completions: npm run sd:status
```

**If there are stale sessions:**
```
  NOTE: Found stale session(s). These will auto-release after 5 minutes.
  To force release: node -e "require('dotenv').config(); ..."
```

### Step 7: Clean Up Stale Sessions (If Needed)

If the database query found stale sessions from the previous account, release them:

```bash
node -e "
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');
const sb = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);

(async () => {
  const { data: stale } = await sb.from('v_active_sessions')
    .select('session_id')
    .eq('computed_status', 'stale');

  if (stale && stale.length > 0) {
    for (const s of stale) {
      await sb.from('claude_sessions')
        .update({ status: 'completed', completed_at: new Date().toISOString() })
        .eq('session_id', s.session_id);
      console.log('Released stale session:', s.session_id);
    }
  } else {
    console.log('No stale sessions to clean up');
  }
})();
"
```

## Notes

- If the database is unreachable, the handoff still works using git state alone
- Stale session cleanup is safe - sessions with no heartbeat for >5 minutes are abandoned
- The handoff-state.json is consumed but not deleted (useful for reference)
- This command loads CLAUDE.md context automatically (it's in the system prompt)

## Related

- **Guide**: [Multi-Account Handoff Guide](../../docs/guides/multi-account-handoff.md)
- **Outgoing**: `/handoff-out` to prepare handoff from the current account
- **SD Queue**: `npm run sd:next` to see available work
