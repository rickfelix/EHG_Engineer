#!/bin/sh
# ============================================================================
# Pre-Push Hook: Work Tracking Enforcement
# ============================================================================
#
# ALL pushes to main MUST be tracked as either:
#   1. Strategic Directive (SD-*) - For substantial work (>50 LOC)
#   2. Quick-Fix (QF-*) - For small fixes (‚â§50 LOC)
#
# This ensures:
#   - All work is tracked in the database
#   - Lessons learned are captured
#   - Quality gates are enforced
#   - Progress metrics are accurate
#
# Branch naming:
#   - SD: feat/SD-XXX-*, fix/SD-XXX-*, etc.
#   - QF: quick-fix/QF-YYYYMMDD-NNN or QF-YYYYMMDD-NNN
#
# Emergency bypass (logged): EMERGENCY_PUSH="reason" git push
# ============================================================================

# Get the remote name and URL
remote="$1"
url="$2"

# ============================================================================
# DOCMON: Strunkian Writing Rules for Documentation
# ============================================================================
if [ "$SKIP_DOCMON" != "1" ]; then
  echo ""
  echo "üìù Running DOCMON (Strunkian documentation validation)..."
  echo ""

  node scripts/docmon.js
  DOCMON_EXIT=$?

  if [ $DOCMON_EXIT -eq 1 ]; then
    echo ""
    echo "‚ùå Push blocked: Documentation contains blacklisted words"
    echo ""
    echo "Fix the violations above, then try again."
    echo "Skip with: SKIP_DOCMON=1 git push"
    echo ""
    exit 1
  fi

  echo ""
fi

# Check for emergency bypass (with required reason)
if [ -n "$EMERGENCY_PUSH" ]; then
  echo ""
  echo "‚ö†Ô∏è  EMERGENCY PUSH - Bypassing work tracking requirement"
  echo "   Reason: $EMERGENCY_PUSH"
  echo ""

  # Log the emergency bypass
  if [ -f ".env" ]; then
    export $(grep -E '^(SUPABASE_URL|SUPABASE_SERVICE_ROLE_KEY|NEXT_PUBLIC_SUPABASE_URL)=' .env | xargs 2>/dev/null)
    if [ -z "$SUPABASE_URL" ] && [ -n "$NEXT_PUBLIC_SUPABASE_URL" ]; then
      export SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL"
    fi
  fi

  # Log to database if possible
  if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    COMMIT=$(git rev-parse HEAD)
    node -e "
      const { createClient } = require('@supabase/supabase-js');
      const supabase = createClient('$SUPABASE_URL', '$SUPABASE_SERVICE_ROLE_KEY');
      supabase.from('audit_log').insert({
        action: 'EMERGENCY_PUSH',
        details: {
          branch: '$BRANCH',
          commit: '$COMMIT',
          reason: '$EMERGENCY_PUSH',
          timestamp: new Date().toISOString()
        }
      }).then(() => process.exit(0)).catch(() => process.exit(0));
    " 2>/dev/null || true
  fi

  echo "‚ö†Ô∏è  Emergency bypass logged. Please create SD/QF retroactively."
  echo ""
  exit 0
fi

# Legacy bypass (deprecated - shows warning)
if [ "$SKIP_SD_CHECK" = "1" ]; then
  echo ""
  echo "‚ö†Ô∏è  DEPRECATED: SKIP_SD_CHECK=1 is no longer supported"
  echo ""
  echo "All work must be tracked. Use one of:"
  echo "  1. Create SD: npm run sd:create"
  echo "  2. Create QF: node scripts/create-quick-fix.js --interactive"
  echo "  3. Emergency: EMERGENCY_PUSH=\"critical hotfix for X\" git push"
  echo ""
  exit 1
fi

# Only check when pushing to main
while read local_ref local_sha remote_ref remote_sha
do
  # Skip if not pushing to main
  case "$remote_ref" in
    *refs/heads/main*) ;;
    *) continue ;;
  esac

  echo ""
  echo "üîç Pushing to main - verifying work tracking..."
  echo ""

  # Get current branch name
  BRANCH=$(git rev-parse --abbrev-ref HEAD)

  # Extract SD ID from branch name
  SD_ID=$(echo "$BRANCH" | grep -oE 'SD-[A-Z0-9-]+' | head -1 || echo "")

  # Extract QF ID from branch name
  QF_ID=$(echo "$BRANCH" | grep -oE 'QF-[0-9]+-[0-9]+' | head -1 || echo "")

  # Load environment variables
  if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
    if [ -f ".env" ]; then
      export $(grep -E '^(SUPABASE_URL|SUPABASE_SERVICE_ROLE_KEY|NEXT_PUBLIC_SUPABASE_URL)=' .env | xargs 2>/dev/null)
      if [ -z "$SUPABASE_URL" ] && [ -n "$NEXT_PUBLIC_SUPABASE_URL" ]; then
        export SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL"
      fi
    fi
  fi

  # ========================================================================
  # CASE 1: Strategic Directive (SD-*)
  # ========================================================================
  if [ -n "$SD_ID" ]; then
    echo "   Type: Strategic Directive"
    echo "   SD ID: $SD_ID"
    echo "   Branch: $BRANCH"
    echo ""

    if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
      echo "‚ö†Ô∏è  Cannot verify SD completion - missing environment variables"
      echo "   GitHub Action will verify on PR"
      continue
    fi

    # Run SD verification
    node scripts/verify-sd-completion.js "$SD_ID"

    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå Push blocked: SD completion check failed"
      echo ""
      echo "To complete the SD:"
      echo "  1. npm run handoff exec-to-plan"
      echo "  2. Verify retrospective was created"
      echo "  3. Try push again"
      echo ""
      exit 1
    fi

    echo ""
    echo "‚úÖ SD completion verified - push allowed"
    echo ""
    continue
  fi

  # ========================================================================
  # CASE 2: Quick-Fix (QF-*)
  # ========================================================================
  if [ -n "$QF_ID" ]; then
    echo "   Type: Quick-Fix"
    echo "   QF ID: $QF_ID"
    echo "   Branch: $BRANCH"
    echo ""

    if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
      echo "‚ö†Ô∏è  Cannot verify QF completion - missing environment variables"
      echo "   GitHub Action will verify on PR"
      continue
    fi

    # Run QF verification
    node scripts/verify-qf-completion.js "$QF_ID"

    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå Push blocked: Quick-Fix completion check failed"
      echo ""
      echo "To complete the Quick-Fix:"
      echo "  1. node scripts/complete-quick-fix.js $QF_ID --pr-url <PR_URL>"
      echo "  2. Ensure tests pass and UAT verified"
      echo "  3. Try push again"
      echo ""
      exit 1
    fi

    echo ""
    echo "‚úÖ Quick-Fix completion verified - push allowed"
    echo ""
    continue
  fi

  # ========================================================================
  # CASE 3: No tracking - Interactive wizard (TTY) or block (non-TTY)
  # ========================================================================

  # Check if EHG_ALLOW_MAIN_PUSH is set (for automation)
  if [ "$EHG_ALLOW_MAIN_PUSH" = "1" ]; then
    echo "‚ö†Ô∏è  EHG_ALLOW_MAIN_PUSH=1 - allowing untracked push"
    continue
  fi

  # Detect interactive vs non-interactive
  if [ -t 0 ] && [ -t 1 ] && [ "$CI" != "true" ]; then
    # ====== INTERACTIVE MODE: Show wizard ======
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "  UNTRACKED WORK DETECTED"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    echo "  Branch: $BRANCH"
    echo "  No SD or QF tracking found for this push."
    echo ""
    echo "  Choose an option:"
    echo ""
    echo "  1) Create Quick-Fix worktree   (small fix, ‚â§50 LOC)"
    echo "  2) Create SD worktree          (substantial work, >50 LOC)"
    echo "  3) EMERGENCY_PUSH              (requires confirmation phrase)"
    echo "  4) Cancel                       (abort push)"
    echo ""
    printf "  Choice [1-4]: "
    read WIZARD_CHOICE

    case "$WIZARD_CHOICE" in
      1)
        # Generate QF ID and create worktree
        QF_AUTO_ID="QF-$(date +%Y%m%d-%H%M%S)"
        echo ""
        echo "  Creating Quick-Fix worktree: $QF_AUTO_ID"
        echo ""
        node -e "
          const { createWorkTypeWorktree } = await import('./lib/worktree-manager.js');
          const result = createWorkTypeWorktree({ workType: 'QF', workKey: '$QF_AUTO_ID' });
          if (result.mode === 'worktree') {
            console.log('WORKTREE_PATH=' + result.path);
            console.log('WORKTREE_BRANCH=' + result.branch);
          } else {
            console.log('WORKTREE_FAILED=1');
            console.log('WORKTREE_REASON=' + result.reason);
          }
        " 2>/dev/null || echo "WORKTREE_FAILED=1"
        echo ""
        echo "  To push from the worktree:"
        echo "    cd <worktree-path>"
        echo "    git add . && git commit -m \"fix: description\""
        echo "    git push -u origin qf/$QF_AUTO_ID"
        echo ""
        exit 1
        ;;
      2)
        echo ""
        echo "  Create an SD using:"
        echo "    /leo create"
        echo "  Then work in the automatically created worktree."
        echo ""
        exit 1
        ;;
      3)
        echo ""
        printf "  Type EMERGENCY_PUSH to confirm: "
        read CONFIRM
        if [ "$CONFIRM" = "EMERGENCY_PUSH" ]; then
          # Log the emergency
          EMERG_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          EMERG_COMMIT=$(git rev-parse --short HEAD)
          echo "{\"event\":\"emergency_push\",\"branch\":\"$EMERG_BRANCH\",\"commit\":\"$EMERG_COMMIT\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"emergencyPush\":true}" >&2
          echo ""
          echo "  ‚ö†Ô∏è  Emergency push confirmed. Please create SD/QF retroactively."
          echo ""
          continue
        else
          echo ""
          echo "  ‚ùå Confirmation failed. Push aborted."
          echo ""
          exit 1
        fi
        ;;
      *)
        echo ""
        echo "  Push cancelled."
        echo ""
        exit 1
        ;;
    esac
  else
    # ====== NON-INTERACTIVE MODE: Deterministic failure ======
    echo "‚ùå Push blocked: No work tracking found (non-interactive)"
    echo ""
    echo "   Branch: $BRANCH"
    echo ""
    echo "This push was blocked because no SD or QF tracking was detected."
    echo "In non-interactive mode (CI or no TTY), set one of:"
    echo ""
    echo "  EHG_CONCURRENT_OVERRIDE=1   - Override concurrent session check"
    echo "  EHG_ALLOW_MAIN_PUSH=1       - Allow untracked pushes"
    echo "  EMERGENCY_PUSH=\"reason\"      - Emergency bypass with logging"
    echo ""
    echo "Or create proper tracking:"
    echo "  SD: node scripts/leo-create-sd.js LEO fix \"description\""
    echo "  QF: node scripts/create-quick-fix.js --title \"description\" --type bug"
    echo ""
    exit 1
  fi

done

exit 0
