#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run smoke tests before commit
echo "Running smoke tests before commit..."
npm run test:smoke

# Check exit code
if [ $? -ne 0 ]; then
  echo "‚ùå Smoke tests failed. Commit aborted."
  echo "Run 'npm run test:smoke' to see details."
  exit 1
fi

echo "‚úÖ Smoke tests passed."

# ============================================================================
# PRD Schema Validation
# ============================================================================

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any PRD scripts are being committed
PRD_SCRIPTS=$(echo "$STAGED_FILES" | grep -E "scripts/(create-prd|add-prd|generate-prd|update-prd|insert-prd|populate-prd)" || true)

if [ ! -z "$PRD_SCRIPTS" ]; then
  echo ""
  echo "üîç Detected PRD script changes. Running schema validation..."
  echo ""

  # Run validation on changed scripts
  for script in $PRD_SCRIPTS; do
    if [ -f "$script" ]; then
      echo "Validating: $script"

      # Check if script uses deprecated fields
      DEPRECATED_FIELDS=$(grep -E "strategic_directive_id:|prd_id:|user_stories:|ui_components:|success_metrics:|risks_and_mitigations:|technical_architecture:|problem_statement:" "$script" | grep -v "// FIX:" | grep -v "\/\/" || true)

      if [ ! -z "$DEPRECATED_FIELDS" ]; then
        echo ""
        echo "‚ùå PRD Schema Validation Failed: $script"
        echo ""
        echo "Found deprecated/invalid fields:"
        echo "$DEPRECATED_FIELDS"
        echo ""
        echo "üí° Fix suggestions:"
        echo "   - strategic_directive_id ‚Üí sd_uuid"
        echo "   - prd_id ‚Üí id"
        echo "   - user_stories ‚Üí (use separate table)"
        echo "   - ui_components ‚Üí metadata.ui_components"
        echo "   - success_metrics ‚Üí metadata.success_metrics"
        echo "   - risks_and_mitigations ‚Üí risks"
        echo "   - technical_architecture ‚Üí system_architecture"
        echo "   - problem_statement ‚Üí business_context"
        echo ""
        echo "üìö See docs/PRD_SCRIPTS_AUDIT_SUMMARY.md for field mapping guide"
        echo "üîß Run 'npm run prd:audit:fix $script' to auto-fix common issues"
        echo ""
        exit 1
      fi

      # Check if script fetches sd_uuid
      if grep -q "product_requirements_v2" "$script"; then
        if ! grep -q "sd_uuid" "$script" && ! grep -q "uuid_id" "$script"; then
          echo ""
          echo "‚ö†Ô∏è  Warning: $script may be missing sd_uuid population"
          echo "   Make sure you fetch uuid_id from strategic_directives_v2"
          echo "   See templates/prd-script-template.js for correct pattern"
          echo ""
        fi
      fi

      echo "‚úÖ $script passed validation"
    fi
  done

  echo ""
  echo "‚úÖ All PRD scripts validated successfully!"
fi

echo ""
echo "‚úÖ Pre-commit checks passed. Proceeding with commit."
