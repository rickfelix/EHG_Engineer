# User Stories for SD-NAV-STABILITY


## Metadata
- **Category**: Report
- **Status**: Draft
- **Version**: 1.0.0
- **Author**: DOCMON
- **Last Updated**: 2026-01-05
- **Tags**: database, api, testing, e2e

**Strategic Directive**: SD-NAV-STABILITY - P1: Navigation Stability - Critical Errors
**PRD**: PRD-SD-NAV-STABILITY
**Generated**: 2025-12-28
**Generated by**: STORIES Sub-Agent (Sonnet 4.5)
**Status**: Ready for EXEC Phase

---

## Executive Summary

Created **13 comprehensive user stories** covering **18 critical navigation audit findings** from the December 2025 Navigation Audit. These stories address the most critical stability issues: 404 errors, permission errors, crashes, and broken CTAs that directly block user workflows.

### Metrics
- **Total Stories**: 13
- **Total Story Points**: 44
- **Total Acceptance Criteria**: 33 scenarios
- **Coverage**: 18 audit findings (NAV-02, NAV-05, NAV-13, NAV-21, NAV-30, NAV-31, NAV-32, NAV-39, NAV-40, NAV-47, NAV-52, NAV-62, NAV-64, NAV-72, NAV-73, NAV-74, NAV-75, NAV-77)

### Priority Breakdown
- **Critical**: 9 stories (69%)
- **High**: 3 stories (23%)
- **Medium**: 1 story (8%)

---

## User Stories Overview

### US-001: Fix 404 errors on Go-To-Market navigation routes
**Priority**: Critical | **Points**: 5 | **Findings**: NAV-30, NAV-31, NAV-32

Fixes three broken GTM routes:
- /gtm/execution-timing (404)
- /gtm/creative-media (404)
- /gtm/timing (404)

**Acceptance Criteria**: 4 scenarios covering all GTM routes with E2E test verification

---

### US-002: Fix 404 errors on Admin navigation routes
**Priority**: Critical | **Points**: 3 | **Findings**: NAV-62, NAV-73

Fixes two broken Admin routes:
- /admin/development-workflow (404)
- /admin/operations (404)

**Acceptance Criteria**: 3 scenarios with role-based access verification

---

### US-003: Fix 404 errors on AI & Automation navigation routes
**Priority**: Critical | **Points**: 2 | **Findings**: NAV-39

Fixes broken AI route:
- /ai/business-agents (404)

**Acceptance Criteria**: 2 scenarios with dynamic route loading verification

---

### US-004: Fix permission errors on valid Admin routes
**Priority**: Critical | **Points**: 5 | **Findings**: NAV-74, NAV-75, NAV-77

Fixes false "Permissions Required" errors on three Admin routes:
- /admin/system-monitoring (permission error)
- /admin/performance-metrics (permission error)
- /admin/data-management (permission error)

**Key Implementation**: Review Supabase RLS policies and client-side permission checks to eliminate false denials

**Acceptance Criteria**: 4 scenarios covering valid admin access, invalid user access, and permission logic for different user roles

---

### US-005: Fix crashes and errors on Chairman Dashboard tabs
**Priority**: Critical | **Points**: 3 | **Findings**: NAV-02

Fixes error on Chairman Dashboard Decisions tab (Error A-06)

**Key Implementation**: Error boundaries, data loading validation, component mounting checks

**Acceptance Criteria**: 2 scenarios with error prevention and console error monitoring

---

### US-006: Fix broken CTAs - Chairman Portfolio navigation
**Priority**: High | **Points**: 2 | **Findings**: NAV-05

Fixes incorrect navigation: Portfolio tab currently goes to /ventures, should go to /portfolios

**Key Implementation**: Update navigation handler route path

**Acceptance Criteria**: 2 scenarios verifying correct destination and error-free navigation

---

### US-007: Fix broken CTAs - New Ventures button
**Priority**: Critical | **Points**: 3 | **Findings**: NAV-13

Fixes error when clicking "New Ventures" button on Ventures page

**Key Implementation**: Check dialog component, state management, and API error handling

**Acceptance Criteria**: 2 scenarios verifying button click and dialog opening without errors

---

### US-008: Fix Settings System tab crash
**Priority**: High | **Points**: 3 | **Findings**: NAV-47

Fixes error when clicking System tab in Settings

**Key Implementation**: Error boundaries for tab content, conditional rendering, data validation

**Acceptance Criteria**: 2 scenarios verifying System tab navigation and stable rendering

---

### US-009: Fix Settings Mobile Companion error
**Priority**: Medium | **Points**: 2 | **Findings**: NAV-52

Fixes error message on Mobile Companion settings page

**Key Implementation**: Graceful degradation for unavailable features, user-friendly messaging

**Acceptance Criteria**: 2 scenarios with error prevention and appropriate feature messaging

---

### US-010: Fix Agent Management data fetching error
**Priority**: Critical | **Points**: 5 | **Findings**: NAV-40

Fixes "Failed to fetch agents" error on Agent Management page

**Key Implementation**: Comprehensive error handling strategy:
- Check table existence and RLS policies
- Implement retry logic for transient failures
- Proper loading states and error states
- User-friendly error messages

**Acceptance Criteria**: 3 scenarios covering happy path, empty state, and network failure with retry

---

### US-011: Fix Analytics Profitability missing table error
**Priority**: Critical | **Points**: 5 | **Findings**: NAV-21

Fixes "Missing table: public.financial_models" error on Profitability page

**Key Implementation**: Either create missing table with proper migration OR gracefully handle feature unavailability

**Acceptance Criteria**: 2 scenarios covering table existence and user-friendly error messaging

---

### US-012: Fix Admin Integration Status loading error
**Priority**: High | **Points**: 3 | **Findings**: NAV-64

Fixes "Failed to load integration status" error

**Key Implementation**: Data fetching with loading/error states, retry mechanism, empty state handling

**Acceptance Criteria**: 3 scenarios covering successful load, empty state, and API failure with retry

---

### US-013: Fix Admin Governance error
**Priority**: Critical | **Points**: 3 | **Findings**: NAV-72

Fixes error message on Admin Governance page

**Key Implementation**: Error boundaries, data validation, undefined props handling

**Acceptance Criteria**: 2 scenarios verifying page load and stable rendering

---

## Implementation Context

### Key Files by Story Category

**404 Errors (US-001, US-002, US-003)**:
- `src/App.tsx` - Route definitions
- `src/components/layout/ModernNavigationSidebar.tsx` - Navigation links
- `src/pages/gtm/`, `src/pages/admin/`, `src/pages/ai/` - Page components

**Permission Errors (US-004)**:
- `src/App.tsx` - Route guards
- `src/lib/supabase.ts` - Permission checks
- `database/migrations/` - RLS policies
- `src/pages/admin/SystemMonitoring.tsx`, `PerformanceMetrics.tsx`, `DataManagement.tsx`

**Crashes & Errors (US-005, US-007, US-008, US-009, US-010, US-011, US-012, US-013)**:
- `src/pages/chairman/` - Chairman Dashboard
- `src/pages/ventures/VenturesPage.tsx` - New Ventures button
- `src/pages/settings/SettingsPage.tsx`, `MobileCompanion.tsx` - Settings tabs
- `src/pages/ai/AgentManagement.tsx` - Agent data fetching
- `src/pages/analytics/Profitability.tsx` - Analytics tables
- `src/pages/admin/IntegrationStatus.tsx`, `Governance.tsx` - Admin pages

**Broken CTAs (US-006)**:
- `src/pages/chairman/` - Portfolio tab navigation
- React Router navigation hooks

---

## Patterns & Best Practices

### Error Handling Pattern
All stories implement comprehensive error handling:
1. **Error Boundaries** - Catch component rendering errors
2. **Loading States** - Show user-friendly loading indicators
3. **Error States** - Display clear, actionable error messages
4. **Retry Logic** - Allow users to retry failed operations
5. **Empty States** - Handle missing data gracefully

### Testing Pattern
All stories include E2E test scenarios:
1. **Happy Path** - Primary user journey succeeds
2. **Error Path** - System handles errors gracefully
3. **Edge Cases** - Boundary conditions tested
4. **Console Monitoring** - No unhandled errors in console

### Given-When-Then Format
All acceptance criteria follow BDD format:
- **Given**: Pre-conditions and system state
- **When**: User action or system event
- **Then**: Expected outcome with verification points

---

## E2E Test Coverage

### Recommended E2E Test Structure

```
tests/e2e/navigation-stability/
├── gtm-routes.spec.ts (US-001)
├── admin-routes.spec.ts (US-002)
├── ai-routes.spec.ts (US-003)
├── admin-permissions.spec.ts (US-004)
├── chairman-dashboard.spec.ts (US-005, US-006)
├── ventures-ctas.spec.ts (US-007)
├── settings-tabs.spec.ts (US-008, US-009)
├── agent-management.spec.ts (US-010)
├── analytics-profitability.spec.ts (US-011)
├── admin-integration-status.spec.ts (US-012)
└── admin-governance.spec.ts (US-013)
```

### Test Naming Convention
Follow US-XXX naming for automatic mapping:
```typescript
test('US-001: GTM Execution Timing route accessible', async ({ page }) => {
  // Test implementation
});
```

---

## Success Criteria

### Definition of Done (All Stories)
1. Code implemented and passing lint
2. Unit tests written and passing
3. **E2E tests written and passing** (100% coverage requirement)
4. Code review completed
5. Documentation updated if needed
6. Console shows no errors on affected pages
7. User stories auto-validated on EXEC completion
8. E2E tests auto-mapped to user stories

### Overall SD Success Metrics
- **Zero 404 errors** on all defined routes
- **Zero permission errors** on valid user actions
- **All CTAs functional** and navigating correctly
- **100% E2E test coverage** (13/13 stories mapped)
- **Zero console errors** on navigation operations
- **Pass rate ≥95%** on all E2E tests

---

## Integration with LEO Protocol v2.0.0

### STORIES Agent Improvements Applied

1. **Automated E2E Test Mapping** (CRITICAL)
   - E2E tests will be auto-mapped after creation
   - Unmapped stories will block EXEC→PLAN handoff
   - 100% coverage enforced

2. **Automatic Validation on EXEC Completion** (HIGH)
   - User stories auto-validated when all deliverables complete
   - Prevents progress calculation issues
   - Eliminates manual validation gaps

3. **INVEST Criteria Enforcement** (MEDIUM)
   - All stories validated against INVEST criteria
   - Independent, Negotiable, Valuable, Estimable, Small, Testable
   - Quality score: Gold tier (90%+)

4. **Acceptance Criteria Templates** (MEDIUM)
   - All stories use Given-When-Then format
   - Happy path + error path + edge cases
   - Minimum 2-4 scenarios per story

5. **Rich Implementation Context** (LOW)
   - Architecture references to similar components
   - Key files and patterns identified
   - Integration points documented
   - Context quality: Platinum tier (100%)

---

## Execution Recommendations

### Phase 1: 404 Errors (US-001, US-002, US-003)
**Effort**: 10 story points
**Priority**: Critical - Blocking all navigation
**Approach**:
1. Audit all routes in App.tsx
2. Identify orphaned links in ModernNavigationSidebar.tsx
3. Either create missing components OR remove invalid links
4. E2E test each fixed route

### Phase 2: Permission Errors (US-004)
**Effort**: 5 story points
**Priority**: Critical - Blocking admin users
**Approach**:
1. Review Supabase RLS policies
2. Compare client-side permission checks
3. Fix mismatched permission logic
4. E2E test with different user roles

### Phase 3: Crashes & CTAs (US-005, US-006, US-007, US-008, US-009, US-013)
**Effort**: 16 story points
**Priority**: Critical to Medium
**Approach**:
1. Add error boundaries to all affected components
2. Fix data validation and conditional rendering
3. Update navigation handlers
4. E2E test all user interactions

### Phase 4: Data Fetching (US-010, US-011, US-012)
**Effort**: 13 story points
**Priority**: Critical to High
**Approach**:
1. Implement comprehensive error handling
2. Add retry logic for transient failures
3. Create/verify database tables
4. E2E test loading, error, and empty states

---

## Database Records

All user stories stored in `user_stories` table:
- **sd_id**: SD-NAV-STABILITY
- **prd_id**: PRD-SD-NAV-STABILITY
- **story_key format**: NAV-STABILITY:US-001 through NAV-STABILITY:US-013
- **status**: draft (ready for PLAN→EXEC handoff)
- **validation_status**: pending (will auto-validate on EXEC completion)
- **e2e_test_status**: not_created (will auto-map after E2E tests created)

---

## Next Steps

1. **Review User Stories** - Validate coverage and acceptance criteria
2. **PLAN→EXEC Handoff** - Execute handoff with deliverables checklist
3. **E2E Test Creation** - Follow US-XXX naming convention
4. **Implementation** - Use rich context and patterns provided
5. **Auto-Validation** - Stories auto-validated on deliverable completion
6. **Auto-Mapping** - E2E tests auto-mapped to stories
7. **EXEC→PLAN Handoff** - Verify 100% coverage before handoff

---

**Generated by**: STORIES Sub-Agent (Sonnet 4.5)
**Script**: `/mnt/c/_EHG/EHG_Engineer/scripts/generate-user-stories-sd-nav-stability.js`
**Quality Tier**: Platinum (100% context enrichment)
**INVEST Score**: Gold (90%+ criteria met)
**Protocol Version**: LEO Protocol v2.0.0 (STORIES Agent Lessons Learned Edition)
