# User Stories Summary: SD-FOUNDATION-V3-001


## Metadata
- **Category**: Report
- **Status**: Draft
- **Version**: 1.0.0
- **Author**: DOCMON
- **Last Updated**: 2025-12-22
- **Tags**: database, api, testing, e2e

**Strategic Directive**: Data Integrity & Schema Remediation
**Total Stories**: 4
**Total Story Points**: 16
**Created**: 2025-12-17
**Generated By**: STORIES Agent (Sonnet 4.5)

## Executive Summary

This infrastructure SD focuses on database remediation, specifically the deprecation and removal of the `uuid_id` column from `strategic_directives_v2` table. The SD ensures safe removal through comprehensive auditing, FK integrity verification, standardized ID display, and reversible migration scripts.

## Functional Requirements Mapping

| FR | Description | User Stories |
|----|-------------|--------------|
| FR-1 | Audit uuid_id column usage across codebase | US-001 |
| FR-2 | Verify FK referential integrity | US-002 |
| FR-3 | Standardize ID display in scripts | US-003 |
| FR-4 | Create uuid_id removal migration | US-004 |

## User Stories Overview

### US-001: Audit uuid_id column usage across codebase (3 points)
**Priority**: Critical | **Type**: Audit & Documentation

**User Story**:
> As a Database Administrator, I want to search all scripts and API endpoints for uuid_id references, document findings, and create removal checklist, so that all uuid_id references are identified and categorized before removal, preventing runtime errors and data integrity issues.

**Key Deliverables**:
- Audit script: `scripts/audit-uuid-id-usage.js`
- Audit report: `docs/validation/uuid-id-audit-report.md`
- Categorization: removable, needs_migration, external_dependency
- Removal checklist with prioritized tasks

**Acceptance Criteria** (5 scenarios):
1. Comprehensive codebase scan (all .js, .ts, .sql files)
2. Categorization - Removable references
3. Categorization - Needs migration
4. Validation - No new uuid_id references
5. Audit report generation

**Testing**:
- Unit tests for audit script and categorization logic
- Path: TBD (audit tool, not E2E testable)

---

### US-002: Verify FK referential integrity for sd_id columns (5 points)
**Priority**: Critical | **Type**: Database Validation

**User Story**:
> As a Database Administrator, I want to confirm all sd_id FK columns in product_requirements_v2, retrospectives, sd_phase_handoffs correctly reference strategic_directives_v2.id, so that no orphaned records exist and all FK relationships are valid, preventing data corruption and query failures.

**Key Deliverables**:
- Verification script: `scripts/verify-fk-integrity-sd-id.js`
- FK integrity report: `docs/validation/SD-FOUNDATION-V3-001-fk-integrity-report.md`
- 100% FK match rate verification
- Test `get_progress_breakdown()` function

**Acceptance Criteria** (5 scenarios):
1. Happy path - 100% FK integrity verified
2. FK integrity check for product_requirements_v2
3. FK integrity check for sd_phase_handoffs
4. get_progress_breakdown() returns correct prd_exists
5. Error path - Orphaned records detected

**Testing**:
- Integration tests for FK integrity checks
- Function testing for get_progress_breakdown()
- Path: `tests/integration/database/US-002-fk-integrity.spec.ts`

---

### US-003: Standardize ID display format in scripts and terminal output (3 points)
**Priority**: High | **Type**: Developer Experience

**User Story**:
> As a Developer, I want all console.log and display patterns to use consistent ID format (prefer legacy_id || id), so that terminal output shows SD-XXX format instead of UUIDs, improving developer experience and reducing confusion.

**Key Deliverables**:
- Display helper: `lib/utils/displaySDId.js`
- Updated handoff executors (LeadToPlan, PlanToExec)
- Updated scripts for consistent ID display
- Pattern documentation: `docs/patterns/sd-id-display-pattern.md`

**Acceptance Criteria** (4 scenarios):
1. Happy path - Consistent ID display in handoff executors
2. Display logic - Prefer legacy_id over UUID
3. Validation - No mixed UUID/VARCHAR display
4. Error messages - Human-readable SD references

**Testing**:
- Unit tests for displaySDId() helper
- Integration tests for handoff executors
- Path: `tests/unit/lib/utils/US-003-display-sd-id.spec.ts`

---

### US-004: Create uuid_id column removal migration with rollback (5 points)
**Priority**: Medium | **Type**: Database Migration

**User Story**:
> As a Database Administrator, I want to create migration to drop uuid_id column AFTER verifying no external dependencies, so that database schema is clean without deprecated columns, reducing confusion and preventing accidental use of uuid_id.

**Key Deliverables**:
- Migration: `database/migrations/YYYYMMDD_remove_uuid_id_column.sql`
- Rollback: `database/migrations/YYYYMMDD_remove_uuid_id_column_rollback.sql`
- Pre-migration validation: `scripts/pre-migration-uuid-id-removal.js`
- Documentation: `docs/database/uuid-id-removal-migration.md`

**Acceptance Criteria** (5 scenarios):
1. Migration creation - Drop uuid_id column
2. Pre-migration validation
3. Migration execution - Column dropped
4. Rollback script - Restore uuid_id column
5. Documentation - External system notification

**Dependencies**: US-001 (audit), US-002 (FK verification)

**Testing**:
- Integration tests for migration and rollback
- Unit tests for pre-migration validation
- Path: `tests/integration/database/US-004-uuid-id-removal.spec.ts`

---

## Implementation Plan

### Phase 1: Audit & Verification (Critical - 8 points)
**Goal**: Identify all uuid_id usage and verify FK integrity

1. **US-001**: Audit uuid_id column usage (3 points)
   - Create audit script with ripgrep
   - Categorize findings (removable, needs_migration, external)
   - Generate audit report
   - Create removal checklist

2. **US-002**: Verify FK referential integrity (5 points)
   - Create verification script
   - Check all FK tables (product_requirements_v2, sd_phase_handoffs, retrospectives, user_stories)
   - Test get_progress_breakdown()
   - Generate integrity report

**Deliverable**: Audit report + FK integrity report confirming 100% integrity

---

### Phase 2: Developer Experience (High - 3 points)
**Goal**: Standardize ID display for human-readable output

3. **US-003**: Standardize ID display format (3 points)
   - Create displaySDId() utility function
   - Update handoff executors (LeadToPlan, PlanToExec)
   - Audit scripts for raw UUID display
   - Update error messages
   - Document pattern

**Deliverable**: Consistent SD-XXX format across all terminal output

---

### Phase 3: Migration Creation (Medium - 5 points)
**Goal**: Create safe, reversible migration to remove uuid_id

4. **US-004**: Create uuid_id removal migration (5 points)
   - Create migration SQL (DROP COLUMN)
   - Create rollback SQL (ADD COLUMN)
   - Create pre-migration validation script
   - Document external dependencies
   - Test on staging database

**Deliverable**: Migration scripts (NOT applied to production) with rollback plan

---

## INVEST Criteria Validation

All user stories follow INVEST principles:

### Independent
- US-001 (audit) and US-002 (FK verification) can be done in parallel
- US-003 (ID display) is independent of other stories
- US-004 (migration) depends on US-001 and US-002 completion but is otherwise independent

### Negotiable
- Story points are estimates (can be adjusted based on findings)
- US-003 is optional enhancement (migration can proceed without it)
- US-004 migration timing is negotiable (awaiting approval)

### Valuable
- Each story delivers business value:
  - US-001: Prevents breaking changes by identifying all dependencies
  - US-002: Ensures data integrity before schema changes
  - US-003: Improves developer experience
  - US-004: Completes deprecation process, cleans schema

### Estimable
- Clear acceptance criteria (4-5 per story)
- Story points assigned (3-5 range)
- Total: 16 points (~1 sprint for infrastructure work)

### Small
- All stories ≤5 points
- Each story can be completed in 1-2 days
- No story requires splitting

### Testable
- Every story has Given-When-Then acceptance criteria
- Test types specified (unit, integration)
- Test paths defined
- Definition of done includes test criteria

---

## Technical Architecture

### New Files Created

1. **scripts/audit-uuid-id-usage.js** (US-001)
   - Codebase scanning with ripgrep
   - Usage categorization logic
   - Report generation

2. **scripts/verify-fk-integrity-sd-id.js** (US-002)
   - FK integrity verification
   - Orphaned record detection
   - Progress breakdown testing

3. **lib/utils/displaySDId.js** (US-003)
   - displaySDId() helper function
   - displaySD() helper function
   - Fallback logic for legacy records

4. **database/migrations/YYYYMMDD_remove_uuid_id_column.sql** (US-004)
   - DROP COLUMN statement
   - Pre-migration safety checks
   - Documentation comments

5. **database/migrations/YYYYMMDD_remove_uuid_id_column_rollback.sql** (US-004)
   - ADD COLUMN statement
   - Rollback logging
   - DEPRECATED marking

6. **scripts/pre-migration-uuid-id-removal.js** (US-004)
   - Pre-migration validation checks
   - Audit report verification
   - FK integrity verification

### Modified Files

1. **scripts/modules/handoff/executors/LeadToPlanExecutor.js** (US-003)
   - Import displaySDId()
   - Update console.log statements

2. **scripts/modules/handoff/executors/PlanToExecExecutor.js** (US-003)
   - Import displaySDId()
   - Update console.log statements

3. **Various scripts in scripts/** (US-003)
   - Update to use displaySDId()
   - Consistent error messages

### Database Tables Affected

1. **strategic_directives_v2** (US-004)
   - uuid_id column to be dropped
   - Uses id (VARCHAR) and legacy_id (VARCHAR) columns

2. **product_requirements_v2** (US-002)
   - FK integrity verification: sd_id → strategic_directives_v2.id

3. **sd_phase_handoffs** (US-002)
   - FK integrity verification: sd_id → strategic_directives_v2.id

4. **retrospectives** (US-002)
   - FK integrity verification: sd_id → strategic_directives_v2.id

5. **user_stories** (US-002)
   - FK integrity verification: sd_id → strategic_directives_v2.id

---

## Acceptance Criteria Summary

**Total Acceptance Criteria**: 19 scenarios across 4 stories

### Coverage Breakdown

| Category | Scenarios | Stories |
|----------|-----------|---------|
| Happy Path | 4 | All |
| Audit & Categorization | 4 | US-001 |
| FK Integrity | 4 | US-002 |
| Display Standardization | 3 | US-003 |
| Migration & Rollback | 4 | US-004 |

### Given-When-Then Format

All acceptance criteria follow Given-When-Then format:
- **Given**: Preconditions and context
- **When**: Action or trigger
- **Then**: Expected outcome (measurable)

Example (US-002, AC-002-1):
```
Given: Database contains product_requirements_v2, retrospectives, sd_phase_handoffs tables with sd_id FK columns
When: Verification script runs JOIN queries to check FK integrity
Then: All sd_id values in child tables match existing id values in strategic_directives_v2
      AND match rate is 100% AND no orphaned records found
```

---

## Dependencies

### Prerequisites (Must Complete Before)
- None (this is a foundational infrastructure SD)

### Database Schema Requirements
- strategic_directives_v2 table with id (VARCHAR), legacy_id (VARCHAR), uuid_id (UUID)
- FK relationships: product_requirements_v2.sd_id, sd_phase_handoffs.sd_id, retrospectives.sd_id, user_stories.sd_id
- All FK columns reference strategic_directives_v2.id (not uuid_id)

### External Dependencies
- Supabase client (`lib/supabase.ts`)
- Ripgrep (rg) for codebase scanning (US-001)
- PostgreSQL migration tools (US-004)

### Story Dependencies
- US-004 depends on US-001 (audit complete)
- US-004 depends on US-002 (FK integrity verified)
- US-001, US-002, US-003 are independent

---

## Success Metrics

### Code Metrics
- **New Code**: ~600-800 lines (scripts + migrations + tests)
- **Modified Code**: ~100-150 lines (handoff executors, scripts)
- **Deleted Code**: 0 (uuid_id column dropped, but no code deleted yet)
- **Test Coverage**: >80% for new scripts

### Functional Metrics
- **Audit Coverage**: 100% of codebase scanned
- **FK Integrity**: 100% referential integrity
- **Display Consistency**: 0 raw UUID displays in terminal output
- **Migration Reversibility**: Rollback script tested and documented

### Quality Metrics
- **INVEST Score**: 100% (all criteria met)
- **AC Coverage**: 19 scenarios tested
- **Documentation**: Audit report, FK report, migration docs, pattern docs
- **Safety**: Pre-migration validation, rollback plan, no automatic application

---

## Risk Mitigation

### Risk 1: External Systems May Depend on uuid_id
**Mitigation**: Audit identifies external dependencies (US-001, AC-001-3)

**Approach**:
1. Categorize findings as "external_dependency"
2. Document external systems in migration docs
3. Notify external teams before migration
4. Postpone migration if critical dependencies found

### Risk 2: FK Migration May Have Missed Records
**Mitigation**: Comprehensive FK integrity verification (US-002)

**Approach**:
1. Check all FK tables (product_requirements_v2, sd_phase_handoffs, retrospectives, user_stories)
2. Report any orphaned records with remediation suggestions
3. Block migration if integrity < 100%
4. Test get_progress_breakdown() to ensure queries work

### Risk 3: Migration May Break Production
**Mitigation**: Pre-migration validation + rollback script (US-004)

**Approach**:
1. Pre-migration validation checks all prerequisites
2. Require manual approval before applying migration
3. Test migration on staging database first
4. Create database backup before applying
5. Rollback script ready if issues arise

### Risk 4: Developer Confusion with ID Formats
**Mitigation**: Standardize ID display (US-003)

**Approach**:
1. Create displaySDId() utility for consistent display
2. Update all scripts to use utility
3. Document pattern for future development
4. Prefer legacy_id (SD-XXX) over UUID/VARCHAR id

---

## Next Steps

1. **Begin Implementation** (Now)
   ```bash
   # Phase 1: Audit & Verification
   node scripts/add-user-stories-sd-foundation-v3-001.js  # Done
   npm run test:stories -- SD-FOUNDATION-V3-001
   ```

2. **Start with US-001 (Audit)**
   - Create audit script: `scripts/audit-uuid-id-usage.js`
   - Run codebase scan with ripgrep
   - Generate audit report

3. **Parallel: US-002 (FK Verification)**
   - Create verification script: `scripts/verify-fk-integrity-sd-id.js`
   - Run FK integrity checks
   - Test get_progress_breakdown()
   - Generate integrity report

4. **Then: US-003 (ID Display)**
   - Create displaySDId() utility
   - Update handoff executors
   - Audit and fix scripts

5. **Finally: US-004 (Migration)**
   - Review US-001 and US-002 reports
   - Create migration and rollback scripts
   - Create pre-migration validation
   - Document external dependencies
   - Test on staging
   - Await approval for production

---

## Version History

- **v1.0** (2025-12-17): Initial user stories generated by STORIES Agent
  - 4 user stories covering all functional requirements
  - 16 story points total
  - INVEST criteria validated
  - 19 acceptance criteria scenarios
  - 3-phase implementation plan

---

**Generated by**: STORIES Agent (Sonnet 4.5)
**Model**: claude-sonnet-4-5-20250929
**SD**: SD-FOUNDATION-V3-001 (Data Integrity & Schema Remediation)
**Status**: Ready for EXEC phase
**Stories in Database**: 4 stories (SD-FOUNDATION-V3-001:US-001 through US-004)
