# User Stories Summary: SD-VISION-V2-011

**Strategic Directive**: Vision V2: EVA Backend Intelligence
**Total Stories**: 7
**Total Story Points**: 32
**Created**: 2025-12-16
**Generated By**: STORIES Agent v2.0.0

## Executive Summary

This SD migrates insight generation from frontend heuristics to backend intelligence. Currently, `generateProactiveInsight` is a frontend function that generates mock insights. The EVA (Executive Virtual Assistant) should provide real intelligence based on actual venture data, agent messages, and portfolio analysis.

## Functional Requirements Mapping

| FR | Description | User Stories |
|----|-------------|--------------|
| FR-1 | Create EVA Insight Service (evaInsightService.ts) | US-001, US-002 |
| FR-2 | Create Chairman Insights API Endpoint | US-003 |
| FR-3 | Replace Frontend Heuristics | US-004 |
| FR-4 | Multi-Agent Insight Aggregation | US-005, US-006 |
| FR-5 | EVA Event Bus Integration | US-007 |

## User Stories Overview

### Phase 1: Backend Foundation (Critical)

#### US-001: Create EVA Insight Service foundation (5 points)
**Priority**: Critical | **Type**: Backend Service

**User Story**:
> As a System, I want a backend service that aggregates insights from multiple data sources (ventures, agents, budgets, decisions), so that EVA can generate intelligent insights based on real data instead of frontend heuristics.

**Key Deliverables**:
- File: `src/services/evaInsightService.ts`
- Class: `EVAInsightService`
- Methods: `getVentureData()`, `getAgentActivity()`, `getBudgetWarnings()`, `getRecentDecisions()`
- Supabase client integration with RLS filtering
- TypeScript interfaces for all data sources

**Acceptance Criteria** (5 scenarios):
1. Service initialization with data source connections
2. Venture data queries with RLS filtering
3. Agent activity queries (last 24 hours)
4. Budget warning queries from EVATokenBudgetManager
5. Error handling for database failures

**Testing**:
- Unit tests for each data source method
- Integration tests with real database
- Path: `tests/integration/services/US-001-eva-insight-service.spec.ts`

---

#### US-002: Implement insight generation algorithms (8 points)
**Priority**: Critical | **Type**: Business Logic

**User Story**:
> As a System, I want to generate actionable insights from aggregated data with intelligent prioritization, so that Chairman receives relevant, prioritized insights instead of random suggestions.

**Key Deliverables**:
- Method: `EVAInsightService.generateInsights()`
- Insight types: budget_warning, stale_venture, agent_bottleneck, decision_pending, all_clear
- Prioritization algorithm (severity 50%, recency 30%, impact 20%)
- TypeScript interface: `InsightResult`

**Acceptance Criteria** (6 scenarios):
1. Budget warning insights (≥85% utilization)
2. Stale venture insights (no activity 7+ days)
3. Agent bottleneck insights (5+ ventures per agent)
4. Decision pending insights (>48 hours)
5. Insight prioritization (top 5 returned)
6. All-clear insight (when no issues)

**Insight Types**:
- **budget_warning**: Venture approaching/exceeding token budget
- **stale_venture**: No agent activity in 7+ days
- **agent_bottleneck**: Single agent overloaded with ventures
- **decision_pending**: Decision awaiting approval >48 hours
- **all_clear**: Portfolio healthy, no action needed

**Testing**:
- Unit tests for each insight type
- Integration test for full pipeline
- Path: `tests/integration/services/US-002-insight-generation.spec.ts`

---

#### US-003: Create Chairman Insights API endpoint (3 points)
**Priority**: Critical | **Type**: API Development

**User Story**:
> As a Frontend Developer, I want a RESTful API endpoint to fetch EVA-generated insights for the Chairman dashboard, so that frontend can display real backend intelligence instead of mock data.

**Key Deliverables**:
- File: `pages/api/v2/chairman/insights.ts`
- Endpoint: `GET /api/v2/chairman/insights`
- Authentication middleware
- Response format: `{ success: boolean, data: InsightResult[], metadata }`

**Acceptance Criteria** (5 scenarios):
1. Authenticated request returns top 5 insights (200 status)
2. Unauthenticated request rejected (401 status)
3. RLS enforcement (chairman-specific data only)
4. No insights available (returns all_clear insight)
5. Service error handling (500 status, logged)

**API Response**:
```json
{
  "success": true,
  "data": [
    {
      "id": "budget-v123",
      "type": "budget_warning",
      "severity": "critical",
      "title": "Budget Exceeded",
      "message": "Venture \"AI Research\" has exceeded token budget (105%)",
      "actionItems": [
        "Review venture budget allocation",
        "Consider pausing non-critical operations"
      ],
      "relatedVentureIds": ["v123"],
      "priority": 95,
      "createdAt": "2025-12-16T10:30:00Z"
    }
  ],
  "metadata": {
    "count": 1,
    "generatedAt": "2025-12-16T10:30:05Z"
  }
}
```

**Testing**:
- Unit tests for endpoint handlers
- E2E test for authenticated flow
- Path: `tests/e2e/api/chairman/US-003-insights-endpoint.spec.ts`

---

### Phase 2: Frontend Integration (High Priority)

#### US-004: Replace frontend mock with API call (3 points)
**Priority**: High | **Type**: Frontend Refactoring

**User Story**:
> As a Chairman, I want to see real backend-generated insights instead of frontend mock data, so that I receive accurate, actionable recommendations based on actual portfolio state.

**Key Deliverables**:
- Remove `generateProactiveInsight` function (frontend mock)
- Create hook: `useChairmanInsights()`
- API integration with `/api/v2/chairman/insights`
- Loading/error states

**Acceptance Criteria** (5 scenarios):
1. Locate and remove frontend mock function
2. Replace with API call (typed as `InsightResult[]`)
3. Dashboard displays real insights
4. Loading state during API request
5. Error state with retry option

**Implementation**:
```typescript
// New hook: src/hooks/useChairmanInsights.ts
export function useChairmanInsights() {
  const [insights, setInsights] = useState<InsightResult[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Fetch from API, handle errors
  // ...

  return { insights, loading, error, refetch };
}
```

**Testing**:
- E2E test for dashboard with real insights
- Verify no mock data in production build
- Path: `tests/e2e/chairman/US-004-real-insights-display.spec.ts`

---

#### US-005: Add multi-agent message aggregation (5 points)
**Priority**: High | **Type**: Backend Intelligence

**User Story**:
> As a System, I want to aggregate messages and status updates from LEAD, PLAN, and EXEC agents to generate insights, so that insights reflect real agent activity and collaboration patterns.

**Key Deliverables**:
- Method: `EVAInsightService.getAgentMessages()`
- Agent message aggregation by type (LEAD/PLAN/EXEC)
- Collaboration pattern detection
- Insights: agent_collaboration, agent_blocked, approval_delay

**Acceptance Criteria** (4 scenarios):
1. Agent message aggregation from registry
2. Healthy collaboration insight (all agents active)
3. Agent blocked insight (>24 hours)
4. LEAD approval delay insight (>48 hours)

**Agent Insights**:
- **agent_collaboration**: All agents (LEAD/PLAN/EXEC) actively working
- **agent_blocked**: Agent stuck with status="blocked" >24 hours
- **approval_delay**: PLAN completed but LEAD approval pending >48 hours

**Testing**:
- Integration test with agent_registry
- Unit tests for collaboration patterns
- Path: `tests/integration/services/US-005-agent-insights.spec.ts`

---

#### US-006: Implement decision tracking insights (3 points)
**Priority**: Medium | **Type**: Governance Intelligence

**User Story**:
> As a Chairman, I want to see insights about pending decisions, decision velocity, and decision impact, so that I can identify decision bottlenecks and track governance effectiveness.

**Key Deliverables**:
- Method: `EVAInsightService.getDecisionData()`
- Decision age calculation (hours pending)
- Decision velocity calculation (decisions/week)
- Insights: decision_pending, low_decision_velocity, high_impact_decision

**Acceptance Criteria** (3 scenarios):
1. Pending decision insight (>48 hours)
2. Low decision velocity insight (<2/week)
3. High-impact decision prioritization

**Decision Metrics**:
- **Pending Age**: Time since decision created (hours)
- **Velocity**: Decisions made in last 7 days / 7
- **Impact Priority**: High-impact decisions prioritized above others

**Testing**:
- Unit tests for decision insights
- Integration test with venture_decisions table
- Path: `tests/integration/services/US-006-decision-insights.spec.ts`

---

### Phase 3: Real-time Enhancement (Optional)

#### US-007: Integrate with event bus (5 points)
**Priority**: Medium | **Type**: Real-time Architecture

**User Story**:
> As a System, I want EVA insights automatically updated when relevant events occur (budget warnings, agent status changes, new decisions), so that Chairman sees real-time insights without manual refresh.

**Key Deliverables**:
- Event bus subscriptions in `EVAInsightService`
- Event handlers: budget_warning, agent_status_changed, decision_created
- Publish `INSIGHT_UPDATED` event
- Debouncing (5-second delay)

**Acceptance Criteria** (4 scenarios):
1. Subscribe to EVA_ALERT events on initialization
2. Budget warning triggers insight refresh
3. Agent status change triggers refresh
4. Frontend receives INSIGHT_UPDATED events

**Event Flow**:
```
Budget Warning → EVA_ALERT event
                 ↓
       EVAInsightService (debounced)
                 ↓
       Regenerate insights
                 ↓
       INSIGHT_UPDATED event
                 ↓
       Frontend update (no refresh)
```

**Testing**:
- Unit tests for event handlers
- Integration test for event flow
- Path: `tests/integration/services/US-007-event-integration.spec.ts`

---

## Implementation Plan

### Phase 1: Backend Foundation (Critical - 16 points)
**Goal**: Create intelligent backend service and API

1. **US-001**: Create EVA Insight Service (5 points)
   - Create `src/services/evaInsightService.ts`
   - Implement data source methods
   - Write unit tests

2. **US-002**: Implement insight algorithms (8 points)
   - Add `generateInsights()` method
   - Implement 5+ insight types
   - Add prioritization logic
   - Write comprehensive tests

3. **US-003**: Create API endpoint (3 points)
   - Create `pages/api/v2/chairman/insights.ts`
   - Add authentication
   - Integrate with service
   - Write API tests

**Deliverable**: Working backend service generating real insights via API

---

### Phase 2: Frontend Integration (High - 11 points)
**Goal**: Replace frontend mocks with backend intelligence

4. **US-005**: Multi-agent insights (5 points)
   - Add agent message aggregation
   - Implement collaboration detection
   - Test with agent_registry

5. **US-006**: Decision insights (3 points)
   - Add decision tracking
   - Calculate velocity metrics
   - Test with venture_decisions

6. **US-004**: Replace frontend mock (3 points)
   - Create `useChairmanInsights()` hook
   - Remove `generateProactiveInsight()`
   - Update dashboard component
   - E2E test real data flow

**Deliverable**: Chairman dashboard showing real backend insights

---

### Phase 3: Real-time Enhancement (Optional - 5 points)
**Goal**: Add real-time updates via event bus

7. **US-007**: Event bus integration (5 points)
   - Subscribe to events
   - Implement handlers
   - Add debouncing
   - Test event flow

**Deliverable**: Real-time insight updates without refresh

---

## INVEST Criteria Validation

All user stories follow INVEST principles:

### Independent
- Each story can be developed independently
- Clear boundaries between stories
- Phase 1 (US-001, US-002, US-003) can be done in parallel
- Phase 2 depends on Phase 1 completion
- Phase 3 is optional enhancement

### Negotiable
- Story points are estimates (can be adjusted)
- Insight types can be prioritized (start with budget warnings)
- Event bus integration (US-007) is optional
- Decision velocity threshold is configurable

### Valuable
- Each story delivers business value:
  - US-001: Foundation for real data
  - US-002: Intelligent insights
  - US-003: API for frontend
  - US-004: User-visible improvement
  - US-005: Agent intelligence
  - US-006: Governance insights
  - US-007: Real-time updates

### Estimable
- Clear acceptance criteria (4-6 per story)
- Story points assigned (3-8 range)
- Total: 32 points (~2-3 sprints)

### Small
- All stories ≤8 points
- Most stories 3-5 points
- Largest story (US-002) can be split if needed

### Testable
- Every story has Given-When-Then acceptance criteria
- E2E test paths defined
- Test types specified (unit, integration, e2e)
- Test priorities assigned (P0, P1, P2)

---

## Technical Architecture

### New Files Created

1. **src/services/evaInsightService.ts** (US-001, US-002)
   - EVAInsightService class
   - Data source methods
   - Insight generation algorithms
   - Prioritization logic

2. **pages/api/v2/chairman/insights.ts** (US-003)
   - GET endpoint handler
   - Authentication middleware
   - EVAInsightService integration

3. **src/hooks/useChairmanInsights.ts** (US-004)
   - React hook for API calls
   - Loading/error states
   - Auto-refresh logic

### Modified Files

1. **src/hooks/useChairmanDashboardData.ts** (US-004)
   - Remove `generateProactiveInsight()`
   - Replace with `useChairmanInsights()` hook

2. **Dashboard Component** (US-004)
   - Update to use real insights
   - Add loading/error UI

### Database Tables Used

1. **ventures** - Venture status, stage, last_updated
2. **agent_registry** - Agent activity, status, messages
3. **venture_budget_warnings** - Budget alerts from EVATokenBudgetManager
4. **venture_decisions** - Decision tracking, approval status
5. **venture_token_budgets** - Budget allocations
6. **venture_budget_transactions** - Token usage ledger

---

## Acceptance Criteria Summary

**Total Acceptance Criteria**: 30 scenarios across 7 stories

### Coverage Breakdown

| Category | Scenarios | Stories |
|----------|-----------|---------|
| Happy Path | 10 | All |
| Error Handling | 6 | US-001, US-003, US-004 |
| Edge Cases | 5 | US-002, US-006 |
| Security (RLS/Auth) | 3 | US-003 |
| Real-time | 3 | US-007 |
| Performance | 3 | US-001, US-002 |

### Given-When-Then Format

All acceptance criteria follow Given-When-Then format:
- **Given**: Preconditions and context
- **When**: Action or trigger
- **Then**: Expected outcome (measurable)

Example:
```
Given: Venture has budget_utilization >= 85%
When: generateInsights() is called
Then: Insight generated with type: "budget_warning", severity: "high",
      message includes venture name and utilization percentage,
      actionItems include "Review budget allocation"
```

---

## Dependencies

### Prerequisites (Must Complete Before)
- **SD-VISION-V2-009**: Unified decision data (decision tracking)
- **SD-VISION-V2-010**: Real metrics (token budgets, financial data)

### Database Schema Requirements
- `ventures` table with chairman_id, status, stage
- `agent_registry` table with agent activity
- `venture_budget_warnings` table (from EVATokenBudgetManager)
- `venture_decisions` table with status, impact_level
- RLS policies configured for chairman_id filtering

### External Dependencies
- Supabase client (`lib/supabase.ts`)
- EVATokenBudgetManager (for budget warnings)
- Next.js API routes (pages/api/)
- Event bus (optional for US-007)

---

## Success Metrics

### Code Metrics
- **New Code**: ~800-1000 lines (service + API + tests)
- **Modified Code**: ~50-100 lines (frontend refactoring)
- **Deleted Code**: ~100-150 lines (remove mocks)
- **Test Coverage**: >80% for new service code

### Functional Metrics
- **Insight Types**: 5+ implemented (budget, stale, bottleneck, decision, all_clear)
- **Response Time**: API <2s for insight generation
- **Accuracy**: 100% real data (0% mock/hardcoded)
- **Coverage**: Top 5 insights prioritized and returned

### Quality Metrics
- **INVEST Score**: 100% (all criteria met)
- **AC Coverage**: 30 scenarios tested
- **E2E Tests**: 7 test files created
- **Documentation**: All insight types documented

---

## Risk Mitigation

### Risk 1: EVA Backend Services May Need Refactoring
**Mitigation**: Incremental migration, keep frontend fallback

**Approach**:
1. Create new service without touching existing code
2. Add API endpoint alongside existing endpoints
3. Test thoroughly before frontend integration
4. Keep `generateProactiveInsight()` as fallback until US-004 complete

### Risk 2: Real Insights May Be Less Polished Than Mocks
**Mitigation**: Template system for consistent formatting

**Approach**:
1. Define message templates for each insight type
2. Use string interpolation for dynamic data
3. Review sample outputs before deployment
4. A/B test with Chairman for feedback

### Risk 3: Performance Degradation
**Mitigation**: Caching, query optimization, debouncing

**Approach**:
1. Cache insights for 5 minutes (configurable)
2. Optimize database queries (indexes, RPC functions)
3. Debounce event-driven regeneration (5s delay)
4. Monitor API response times

---

## Next Steps

1. **Validate Stories** (Now)
   ```bash
   npm run stories:validate
   ```

2. **Create PRD** (PLAN Phase)
   ```bash
   npm run prd:create SD-VISION-V2-011
   ```

3. **Begin Implementation** (EXEC Phase)
   - Start with US-001 (EVA Insight Service foundation)
   - Then US-002 (insight generation algorithms)
   - Then US-003 (API endpoint)

4. **Run Quality Checks**
   ```bash
   npm run test:unit
   npm run test:integration
   npm run test:e2e
   ```

---

## Version History

- **v1.0** (2025-12-16): Initial user stories generated by STORIES Agent v2.0.0
  - 7 user stories covering all functional requirements
  - 32 story points total
  - INVEST criteria validated
  - 30 acceptance criteria scenarios
  - 3-phase implementation plan

---

**Generated by**: STORIES Agent v2.0.0 (Lessons Learned Edition)
**Model**: Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
**SD**: SD-VISION-V2-011 (Vision V2: EVA Backend Intelligence)
**Status**: Ready for PLAN phase
