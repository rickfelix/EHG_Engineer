# LEO Protocol v4.3.3 - Auto-Proceed Enhancement

**Version**: 4.3.3
**Date**: 2026-01-22
**Type**: Protocol Enhancement
**Status**: Active

## Overview

LEO Protocol v4.3.3 introduces **auto-proceed mode** as the default workflow behavior, eliminating manual confirmation checkpoints during Strategic Directive execution.

## Problem Statement

Previous behavior required user confirmation at multiple points:
- After SD completion: "What's next?" prompts
- Implicit stopping points between phases
- Unclear about when to proceed automatically

This created workflow friction and reduced autonomous execution efficiency.

## Solution

### Auto-Proceed Mode (Default)

**Enabled by default** for all Strategic Directive workflows:

| Action | Previous Behavior | New Behavior (v4.3.3+) |
|--------|------------------|----------------------|
| Phase transitions | Implicit stops | **Automatic progression** |
| Post-completion | Ask "what's next?" | **Auto-execute sequence** |
| Next SD | Manual selection | **Auto-show queue** |

### Session Preferences (v4.3.3.1+)

**NEW**: Auto-proceed can now be configured per-session:

| Component | Behavior |
|-----------|----------|
| **Default Setting** | Auto-proceed ON (recommended) |
| **Session Initialization** | At session start, Claude asks if user wants to disable |
| **Storage** | Preference stored in `claude_sessions.metadata.auto_proceed` |
| **Runtime Check** | Commands check session preference before auto-proceeding |
| **Override** | Run `/leo init` anytime to change preference |

#### Session Preference Architecture

```javascript
// Session metadata structure
{
  session_id: 'session_1769205775472_9sou6djf',
  status: 'active',
  metadata: {
    auto_proceed: true  // Default: ON
  }
}
```

#### Commands Respecting Session Preference

| Command | When auto_proceed=true | When auto_proceed=false |
|---------|----------------------|------------------------|
| `/leo complete` | Auto-runs document→ship→learn→next | Asks before each step |
| `/document` | Auto-proceeds to next command | Asks user what's next |
| `/ship` | Auto-proceeds to /learn | Asks if user wants /learn |
| Phase transitions | Automatic handoff execution | Asks before executing |

### Stop Conditions (Explicit)

Auto-proceed **only stops** for (regardless of preference):
1. **Blocking errors** - Merge conflicts, critical failures
2. **Test failures** - After 2 retry attempts
3. **Security/Data-loss** - Critical scenarios requiring human judgment

## Implementation

### Strategic Directive: SD-LEO-ORCH-AUTO-PROCEED-INTELLIGENCE-001

This enhancement was implemented as a full orchestrator SD with **15 infrastructure children**, each targeting a specific intelligence capability.

#### Orchestrator Architecture

| Child | Title | Implementation | PR |
|-------|-------|---------------|-----|
| **A** | SD-Type-Aware Post-Completion Sequences | `lib/utils/post-completion-requirements.js` | Merged |
| **B** | AskUserQuestion AUTO-PROCEED Awareness | Modified AskUserQuestion handling | Merged |
| **C** | Learn Loop Prevention | Loop detection in `/learn` | Merged |
| **D** | Dependency Chain Integration | Child SD dependency validation | Merged |
| **E** | Orchestrator Child Completion Flow | `lib/utils/orchestrator-child-completion.js` | Merged |
| **F** | Stop Hook Post-Completion Validation | Enhanced `stop-subagent-enforcement.js` | Merged |
| **G** | Database-First PreToolUse Enforcer | `scripts/hooks/database-first-enforcer.js` | Merged |
| **H** | Type-Aware SD Completion Validation | Added `validateCompletionForType()` | Merged |
| **I** | Handoff Enforcement PreToolUse Hook | `scripts/hooks/handoff-enforcement.js` | Merged |
| **J** | Type-Aware Bias Detection | Added `detectBiasesForType()` | Merged |
| **K** | Enhanced Session Verification | Session state validation | Merged |
| **L** | Phase State Machine Enforcement | `scripts/hooks/phase-state-enforcement.js` | Merged |
| **M** | Timezone Normalization Fix | UTC timestamp handling | Merged |
| **N** | leo-continuous.js Integration | Post-completion sequence | Merged |
| **O** | Task Tool Database Recording | Sub-agent execution tracking | Merged |

### Core Enhancements

#### 1. Type-Aware Validation (`lib/utils/sd-type-validation.js`)

Different SD types now have different requirements:

```javascript
// Feature SDs require full validation
{
  requiresUATExecution: true,
  requiresE2ETests: true,
  requiresHumanVerifiableOutcome: true,
  requiresLLMUXValidation: true
}

// Infrastructure SDs have minimal requirements
{
  requiresUATExecution: false,
  requiresE2ETests: false,
  skipCodeValidation: true
}
```

#### 2. PreToolUse Hooks (Prevention)

**Database-First Enforcer** (`scripts/hooks/database-first-enforcer.js`):
- Blocks Edit/Write tools if PRD missing for code-requiring SDs
- Allows test files, docs, config without PRD
- Exit code 2 triggers Claude to create PRD first

**Handoff Enforcement** (`scripts/hooks/handoff-enforcement.js`):
- Blocks git commit/push without required handoffs
- Uses `HANDOFF_REQUIREMENTS[sdType]` configuration
- Provides remediation command: `node scripts/handoff.js execute ...`

#### 3. PostToolUse Hooks (Detection)

**Phase State Machine** (`scripts/hooks/phase-state-enforcement.js`):
- Validates phase transitions using state machine
- Type-aware: PRD required for EXEC, UAT required for COMPLETED
- Supports back-tracking (EXEC→PLAN) and iterative cycles

#### 4. Stop Hook Enhancements (`scripts/hooks/stop-subagent-enforcement.js`)

**Post-Completion Validation** (Child F):
```javascript
async function validatePostCompletion(supabase, sd, sdKey) {
  // Blocks if /ship missing with code changes
  // Warns if /learn or /document missing
}
```

**Type-Aware Completion** (Child H):
```javascript
async function validateCompletionForType(supabase, sd, sdKey) {
  // Validates UAT execution for types that require it
  // Validates E2E tests for code-producing types
  // Warns about missing human verification
}
```

**Bias Detection** (Child J):
```javascript
async function detectBiasesForType(supabase, sd, sdKey, requirements) {
  // COMPLETION_BIAS: Code on main but SD not complete
  // EFFICIENCY_BIAS: In EXEC without handoffs
  // AUTONOMY_BIAS: Code without PRD
}
```

#### 5. Post-Completion Sequence (`lib/utils/post-completion-requirements.js`)

SD type determines post-completion commands:

```javascript
// Full sequence for code-producing SDs
['restart', 'ship', 'document', 'learn']

// Minimal sequence for infrastructure SDs
['ship']
```

### Database Updates

#### Database Section 377 (`critical_term_definitions`)
Updated "Continue autonomously" definition with type-aware behavior.

#### Database Section 317 (`parent_child_overview`)
Updated orchestrator STOP conditions with dependency awareness.

#### Database Table: `claude_sessions` (v4.3.3.1+)
Enhanced `metadata` JSONB column to store session preferences:
- **Field**: `metadata.auto_proceed` (boolean)
- **Default**: `true` (auto-proceed ON)
- **Usage**: Runtime check before workflow auto-progression
- **Access**: Query active session's metadata to determine behavior

```sql
-- Example query
SELECT metadata->>'auto_proceed' as auto_proceed_enabled
FROM claude_sessions
WHERE status = 'active'
ORDER BY heartbeat_at DESC
LIMIT 1;
```

### Test Coverage

**95+ new unit tests**:
- `test/unit/type-aware-completion.test.js` (32 tests)
- `test/unit/bias-detection.test.js` (28 tests)
- `test/unit/phase-state-machine.test.js` (35 tests)

All tests passing.

### Generated Files
All `CLAUDE_*.md` files regenerated from database via:
```bash
node scripts/generate-claude-md-from-db.js
```

## Workflow Changes

### Before (v4.3.2 and earlier)
```
SD Complete → [WAIT] → User: "what's next?" → [WAIT] →
  User: "yes, ship it" → [WAIT] → User: "yes, document" → ...
```

### After (v4.3.3+)
```
SD Complete → /restart (auto) → /document (auto) → /ship (auto) →
  /learn (auto) → sd:next (auto)
```

## Benefits

1. **Reduced Friction**: Eliminates unnecessary confirmation prompts
2. **Faster Execution**: Auto-proceeds through standard workflows
3. **Clear Stop Points**: Explicit conditions for when human input is needed
4. **User Control**: Users can still override by asking questions
5. **Predictable Behavior**: Well-defined autonomous execution model

## Backward Compatibility

### For Users
- **No breaking changes** - Users can still manually control by asking questions
- **Improved UX** - Fewer interruptions during standard workflows
- **Override support** - Explicit user questions still stop auto-proceed

### For Protocol
- **Database-first** - Changes stored in database, not files
- **Regeneration** - CLAUDE files auto-regenerate correctly
- **Sub-agent compatible** - Works with all existing sub-agents

## Testing

### Implementation Validation
- [x] All 15 children implemented and merged
- [x] 95+ unit tests passing
- [x] PreToolUse hooks blocking correctly
- [x] PostToolUse hooks warning correctly
- [x] Type-aware validation working
- [x] Bias detection identifying patterns
- [x] Phase state machine enforcing transitions
- [x] Post-completion sequences triggering
- [x] Database sections updated correctly
- [x] CLAUDE files regenerated successfully
- [x] Documentation updated with implementation details
- [x] No breaking changes to existing workflows

### Hook Validation

**PreToolUse Hooks** (Blocking):
- [x] Database-First Enforcer blocks edits without PRD
- [x] Handoff Enforcement blocks commits without handoffs

**PostToolUse Hooks** (Warning):
- [x] Phase State Machine validates transitions

**Stop Hook Enhancements** (Context-aware):
- [x] Post-completion validation catches missing /ship
- [x] Type-aware completion checks UAT for feature SDs
- [x] Bias detection identifies completion/efficiency/autonomy biases

### Integration Testing
- [x] Full orchestrator SD workflow (15 children)
- [x] Type-aware validation across SD types
- [x] Hook interactions (Pre/Post/Stop)
- [x] Database-first compliance
- [x] Auto-proceed intelligence working end-to-end

## Rollback Plan

If issues arise, rollback by:
1. Revert database section changes:
   ```sql
   UPDATE leo_protocol_sections SET content = '[OLD CONTENT]' WHERE id IN (317, 377);
   ```
2. Revert `.claude/commands/leo.md` changes via git
3. Regenerate CLAUDE files

## Related Documentation

- **Phase Transitions**: `docs/leo/phases/README.md`
- **Operational Behavior**: `docs/leo/operational/README.md`
- **Command Reference**: `.claude/commands/leo.md`
- **Database Schema**: Section 377 (critical_term_definitions), Section 317 (parent_child_overview)

## Version History

| Version | Date | Change |
|---------|------|--------|
| v4.3.3.1 | 2026-01-23 | Added session-based preference control for auto-proceed |
| v4.3.3 | 2026-01-22 | Auto-proceed mode added as default |
| v4.3.2 | 2026-01-20 | Gate refinements |
| v4.3.1 | 2026-01-18 | Sub-agent integration |

## Changes in v4.3.3.1 (2026-01-23)

### Feature: Session-Based Auto-Proceed Preferences

**Problem**: Auto-proceed was always ON with no user control except manual interruption.

**Solution**:
1. **Session initialization prompt** - At session start, Claude asks if user wants to disable auto-proceed
2. **Database persistence** - Preference stored in `claude_sessions.metadata.auto_proceed`
3. **Runtime checks** - Commands query session preference before auto-proceeding
4. **Explicit override** - `/leo init` command to change preference anytime

**Files Changed**:
- `.claude/commands/leo.md` - Added session initialization logic and `/leo init` command
- `database/migrations/20251204_multi_session_coordination.sql` - Already supports `metadata` JSONB field
- This documentation file - Updated with new preference system

**User Experience**:
```
# Session start
User: /leo next
Claude: Auto-proceed mode is ON by default. Would you like to disable it?
  [Keep ON (Recommended)] | [Turn OFF]
User: Keep ON
Claude: ✅ Session Initialized - Auto-Proceed: ON
```

**Backward Compatibility**:
- Default remains ON (no breaking changes)
- Existing sessions without preference default to ON
- All existing auto-proceed behavior preserved

---

**Last Updated**: 2026-01-23
**Maintained By**: LEO Protocol Team
**Status**: Active and In Production
