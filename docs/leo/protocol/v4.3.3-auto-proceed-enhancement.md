# LEO Protocol v4.3.3 - Auto-Proceed Enhancement


## Metadata
- **Category**: Protocol
- **Status**: Approved
- **Version**: 1.3.0
- **Author**: DOCMON
- **Last Updated**: 2026-01-30
- **Tags**: auto-proceed, continuation, cross-session, LEO

**Version**: 4.3.3
**Date**: 2026-01-22
**Type**: Protocol Enhancement
**Status**: Active

## Overview

LEO Protocol v4.3.3 introduces **auto-proceed mode** as the default workflow behavior, eliminating manual confirmation checkpoints during Strategic Directive execution.

## Problem Statement

Previous behavior required user confirmation at multiple points:
- After SD completion: "What's next?" prompts
- Implicit stopping points between phases
- Unclear about when to proceed automatically

This created workflow friction and reduced autonomous execution efficiency.

## Solution

### Auto-Proceed Mode (Default)

**Enabled by default** for all Strategic Directive workflows:

| Action | Previous Behavior | New Behavior (v4.3.3+) |
|--------|------------------|----------------------|
| Phase transitions | Implicit stops | **Automatic progression** |
| Post-completion | Ask "what's next?" | **Auto-execute sequence** |
| Next SD | Manual selection | **Auto-show queue** |

### Session Preferences (v4.3.3.1+)

**NEW**: Auto-proceed can now be configured per-session:

| Component | Behavior |
|-----------|----------|
| **Default Setting** | Auto-proceed ON (recommended) |
| **Session Initialization** | At session start, Claude asks if user wants to disable |
| **Storage** | Preference stored in `claude_sessions.metadata.auto_proceed` |
| **Runtime Check** | Commands check session preference before auto-proceeding |
| **Override** | Run `/leo init` anytime to change preference |

#### Session Preference Architecture

```javascript
// Session metadata structure
{
  session_id: 'session_1769205775472_9sou6djf',
  status: 'active',
  metadata: {
    auto_proceed: true  // Default: ON
  }
}
```

#### Commands Respecting Session Preference

| Command | When auto_proceed=true | When auto_proceed=false |
|---------|----------------------|------------------------|
| `/leo complete` | Auto-runs documentâ†’shipâ†’learnâ†’next | Asks before each step |
| `/document` | Auto-proceeds to next command | Asks user what's next |
| `/ship` | Auto-proceeds to /learn | Asks if user wants /learn |
| Phase transitions | Automatic handoff execution | Asks before executing |

### Stop Conditions (Explicit)

Auto-proceed **only stops** for (regardless of preference):
1. **Blocking errors** - Merge conflicts, critical failures
2. **Test failures** - After 2 retry attempts
3. **Security/Data-loss** - Critical scenarios requiring human judgment

## Implementation

### Strategic Directive: SD-LEO-ORCH-AUTO-PROCEED-INTELLIGENCE-001

This enhancement was implemented as a full orchestrator SD with **15 infrastructure children**, each targeting a specific intelligence capability.

#### Orchestrator Architecture

| Child | Title | Implementation | PR |
|-------|-------|---------------|-----|
| **A** | SD-Type-Aware Post-Completion Sequences | `lib/utils/post-completion-requirements.js` | Merged |
| **B** | AskUserQuestion AUTO-PROCEED Awareness | Modified AskUserQuestion handling | Merged |
| **C** | Learn Loop Prevention | Loop detection in `/learn` | Merged |
| **D** | Dependency Chain Integration | Child SD dependency validation | Merged |
| **E** | Orchestrator Child Completion Flow | `lib/utils/orchestrator-child-completion.js` | Merged |
| **F** | Stop Hook Post-Completion Validation | Enhanced `stop-subagent-enforcement.js` | Merged |
| **G** | Database-First PreToolUse Enforcer | `scripts/hooks/database-first-enforcer.js` | Merged |
| **H** | Type-Aware SD Completion Validation | Added `validateCompletionForType()` | Merged |
| **I** | Handoff Enforcement PreToolUse Hook | `scripts/hooks/handoff-enforcement.js` | Merged |
| **J** | Type-Aware Bias Detection | Added `detectBiasesForType()` | Merged |
| **K** | Enhanced Session Verification | Session state validation | Merged |
| **L** | Phase State Machine Enforcement | `scripts/hooks/phase-state-enforcement.js` | Merged |
| **M** | Timezone Normalization Fix | UTC timestamp handling | Merged |
| **N** | leo-continuous.js Integration | Post-completion sequence | Merged |
| **O** | Task Tool Database Recording | Sub-agent execution tracking | Merged |

### Core Enhancements

#### 1. Type-Aware Validation (`lib/utils/sd-type-validation.js`)

Different SD types now have different requirements:

```javascript
// Feature SDs require full validation
{
  requiresUATExecution: true,
  requiresE2ETests: true,
  requiresHumanVerifiableOutcome: true,
  requiresLLMUXValidation: true
}

// Infrastructure SDs have minimal requirements
{
  requiresUATExecution: false,
  requiresE2ETests: false,
  skipCodeValidation: true
}
```

#### 2. PreToolUse Hooks (Prevention)

**Database-First Enforcer** (`scripts/hooks/database-first-enforcer.js`):
- Blocks Edit/Write tools if PRD missing for code-requiring SDs
- Allows test files, docs, config without PRD
- Exit code 2 triggers Claude to create PRD first

**Handoff Enforcement** (`scripts/hooks/handoff-enforcement.js`):
- Blocks git commit/push without required handoffs
- Uses `HANDOFF_REQUIREMENTS[sdType]` configuration
- Provides remediation command: `node scripts/handoff.js execute ...`

#### 3. PostToolUse Hooks (Detection)

**Phase State Machine** (`scripts/hooks/phase-state-enforcement.js`):
- Validates phase transitions using state machine
- Type-aware: PRD required for EXEC, UAT required for COMPLETED
- Supports back-tracking (EXECâ†’PLAN) and iterative cycles

#### 4. Stop Hook Enhancements (`scripts/hooks/stop-subagent-enforcement.js`)

**Post-Completion Validation** (Child F):
```javascript
async function validatePostCompletion(supabase, sd, sdKey) {
  // Blocks if /ship missing with code changes
  // Warns if /learn or /document missing
}
```

**Type-Aware Completion** (Child H):
```javascript
async function validateCompletionForType(supabase, sd, sdKey) {
  // Validates UAT execution for types that require it
  // Validates E2E tests for code-producing types
  // Warns about missing human verification
}
```

**Bias Detection** (Child J):
```javascript
async function detectBiasesForType(supabase, sd, sdKey, requirements) {
  // COMPLETION_BIAS: Code on main but SD not complete
  // EFFICIENCY_BIAS: In EXEC without handoffs
  // AUTONOMY_BIAS: Code without PRD
}
```

#### 5. Post-Completion Sequence (`lib/utils/post-completion-requirements.js`)

SD type determines post-completion commands:

```javascript
// Full sequence for code-producing SDs
['restart', 'ship', 'document', 'learn']

// Minimal sequence for infrastructure SDs
['ship']
```

#### 6. Child SD Continuation (`scripts/modules/handoff/child-sd-selector.js`)

**NEW in v4.3.3.2** (PR #622): Implements automatic continuation between orchestrator child SDs.

**Problem Addressed**: When a child SD completed during AUTO-PROCEED, the system would pause instead of automatically picking the next ready child. The orchestrator-completion-hook (SD-03) only handled the case when ALL children were done, not individual child completions.

**Root Cause**: No "child completion â†’ pick next child â†’ continue" logic existed in the handoff system.

**Solution**:
- **Child SD Selector Module** (`child-sd-selector.js`):
  ```javascript
  // Get next ready child from parent orchestrator
  export async function getNextReadyChild(supabase, parentSdId, excludeCompletedId) {
    // Query: status IN ('draft', 'in_progress', 'planning', 'active', 'pending_approval', 'review')
    // ORDER BY: sequence_rank ASC, priority DESC, created_at ASC
    // Exclude just-completed SD
    // Returns {sd: object|null, allComplete: boolean, reason: string}
  }

  export function isChildSD(sd) {
    return !!sd.parent_sd_id;
  }

  export async function getOrchestratorContext(supabase, parentSdId) {
    // Returns {parent, children, stats: {total, completed, blocked, remaining}}
  }
  ```

- **Continuation Loop** (`cli-main.js`):
  ```javascript
  export async function handleExecuteWithContinuation(handoffType, sdId, args) {
    const autoProceedEnabled = await resolveAutoProceed({ supabase });
    let currentResult = await handleExecuteCommand(handoffType, sdId, args);

    // Continue loop only if AUTO-PROCEED enabled and LEAD-FINAL-APPROVAL succeeded
    while (autoProceedEnabled && currentResult.success) {
      if (handoffType !== 'LEAD-FINAL-APPROVAL') break;

      const completedSD = await getSDById(currentSdId);
      if (!completedSD.parent_sd_id) break; // Top-level SD, stop

      const { sd: nextChild, allComplete } = await getNextReadyChild(
        supabase, completedSD.parent_sd_id, currentSdId
      );

      if (allComplete) break; // Orchestrator hook handles this
      if (!nextChild) break;  // Blocked or no more children

      // Continue with LEAD-TO-PLAN for next child
      console.log(`ðŸ”„ AUTO-PROCEED: Continuing to ${nextChild.sd_key}`);
      currentResult = await handleExecuteCommand('LEAD-TO-PLAN', nextChild.id, args);
    }
    return currentResult;
  }
  ```

- **Conditional State Clearing** (`lead-final-approval/index.js`):
  ```javascript
  // Only clear AUTO-PROCEED state for top-level SDs
  if (!sd.parent_sd_id) {
    clearAutoProceedState(true);
    console.log('âœ… AUTO-PROCEED state cleared (top-level SD)');
  } else {
    console.log('â„¹ï¸  AUTO-PROCEED state retained (child SD - continuation possible)');
  }
  ```

- **Orchestrator State Clearing** (`orchestrator-completion-hook.js`):
  ```javascript
  // Clear AUTO-PROCEED state when orchestrator completes
  if (autoProceedResult.autoProceed) {
    // ... invoke /learn, display queue ...

    clearAutoProceedState(true);
    console.log('âœ… AUTO-PROCEED state cleared (orchestrator complete)');
  }
  ```

**Execution Flow**:
```
Child A completes LEAD-FINAL-APPROVAL
  â†’ handleExecuteWithContinuation detects child completion
  â†’ Calls getNextReadyChild(parentId, excludeA)
  â†’ Finds Child B
  â†’ Logs: "ðŸ”„ AUTO-PROCEED: Continuing to SD-CHILD-B"
  â†’ Executes LEAD-TO-PLAN for Child B
  â†’ ... continues through all children ...
  â†’ Last child completes
  â†’ checkAndCompleteParentSD() triggers orchestrator-completion-hook
  â†’ /learn invoked, queue displayed, AUTO-PROCEED state cleared
  â†’ PAUSE (per D08)
```

**Discovery Decisions Implemented**:
- **D26**: Smooth continuation between SDs (no acknowledgment prompts between children)
- **D01**: Pause only at orchestrator completion (not individual child completions)

**Test Coverage**:
- `tests/unit/handoff/child-sd-selector.test.js` (12 tests) - NEW
- `tests/unit/handoff/orchestrator-completion-hook.test.js` (10 tests) - Updated
- `tests/unit/handoff/auto-proceed-resolver.test.js` (21 tests) - Fixed vitestâ†’Jest

**Files Modified**:
- `scripts/modules/handoff/child-sd-selector.js` (NEW - 186 lines)
- `scripts/modules/handoff/cli/cli-main.js` (+114 lines)
- `scripts/modules/handoff/executors/lead-final-approval/index.js` (+15 lines)
- `scripts/modules/handoff/orchestrator-completion-hook.js` (+9 lines)
- Test files (fixed vitestâ†’Jest imports)

**PR**: #622 (feat/auto-proceed-child-continuation)

### Database Updates

#### Database Section 377 (`critical_term_definitions`)
Updated "Continue autonomously" definition with type-aware behavior.

#### Database Section 317 (`parent_child_overview`)
Updated orchestrator STOP conditions with dependency awareness.

#### Database Table: `claude_sessions` (v4.3.3.1+)
Enhanced `metadata` JSONB column to store session preferences:
- **Field**: `metadata.auto_proceed` (boolean)
- **Default**: `true` (auto-proceed ON)
- **Usage**: Runtime check before workflow auto-progression
- **Access**: Query active session's metadata to determine behavior

```sql
-- Example query
SELECT metadata->>'auto_proceed' as auto_proceed_enabled
FROM claude_sessions
WHERE status = 'active'
ORDER BY heartbeat_at DESC
LIMIT 1;
```

### Test Coverage

**95+ new unit tests**:
- `test/unit/type-aware-completion.test.js` (32 tests)
- `test/unit/bias-detection.test.js` (28 tests)
- `test/unit/phase-state-machine.test.js` (35 tests)

All tests passing.

### Generated Files
All `CLAUDE_*.md` files regenerated from database via:
```bash
node scripts/generate-claude-md-from-db.js
```

## Workflow Changes

### Before (v4.3.2 and earlier)
```
SD Complete â†’ [WAIT] â†’ User: "what's next?" â†’ [WAIT] â†’
  User: "yes, ship it" â†’ [WAIT] â†’ User: "yes, document" â†’ ...
```

### After (v4.3.3+)
```
SD Complete â†’ /restart (auto) â†’ /document (auto) â†’ /ship (auto) â†’
  /learn (auto) â†’ sd:next (auto)
```

## Benefits

1. **Reduced Friction**: Eliminates unnecessary confirmation prompts
2. **Faster Execution**: Auto-proceeds through standard workflows
3. **Clear Stop Points**: Explicit conditions for when human input is needed
4. **User Control**: Users can still override by asking questions
5. **Predictable Behavior**: Well-defined autonomous execution model

## Backward Compatibility

### For Users
- **No breaking changes** - Users can still manually control by asking questions
- **Improved UX** - Fewer interruptions during standard workflows
- **Override support** - Explicit user questions still stop auto-proceed

### For Protocol
- **Database-first** - Changes stored in database, not files
- **Regeneration** - CLAUDE files auto-regenerate correctly
- **Sub-agent compatible** - Works with all existing sub-agents

## Testing

### Implementation Validation
- [x] All 15 children implemented and merged
- [x] 95+ unit tests passing
- [x] PreToolUse hooks blocking correctly
- [x] PostToolUse hooks warning correctly
- [x] Type-aware validation working
- [x] Bias detection identifying patterns
- [x] Phase state machine enforcing transitions
- [x] Post-completion sequences triggering
- [x] Database sections updated correctly
- [x] CLAUDE files regenerated successfully
- [x] Documentation updated with implementation details
- [x] No breaking changes to existing workflows

### Hook Validation

**PreToolUse Hooks** (Blocking):
- [x] Database-First Enforcer blocks edits without PRD
- [x] Handoff Enforcement blocks commits without handoffs

**PostToolUse Hooks** (Warning):
- [x] Phase State Machine validates transitions

**Stop Hook Enhancements** (Context-aware):
- [x] Post-completion validation catches missing /ship
- [x] Type-aware completion checks UAT for feature SDs
- [x] Bias detection identifies completion/efficiency/autonomy biases

### Integration Testing
- [x] Full orchestrator SD workflow (15 children)
- [x] Type-aware validation across SD types
- [x] Hook interactions (Pre/Post/Stop)
- [x] Database-first compliance
- [x] Auto-proceed intelligence working end-to-end

## Rollback Plan

If issues arise, rollback by:
1. Revert database section changes:
   ```sql
   UPDATE leo_protocol_sections SET content = '[OLD CONTENT]' WHERE id IN (317, 377);
   ```
2. Revert `.claude/commands/leo.md` changes via git
3. Regenerate CLAUDE files

## Related Documentation

- **Phase Transitions**: `docs/leo/phases/README.md`
- **Operational Behavior**: `docs/leo/operational/README.md`
- **Command Reference**: `.claude/commands/leo.md`
- **Database Schema**: Section 377 (critical_term_definitions), Section 317 (parent_child_overview)

## Version History

| Version | Date | Change |
|---------|------|--------|
| v4.3.3.1 | 2026-01-23 | Added session-based preference control for auto-proceed |
| v4.3.3 | 2026-01-22 | Auto-proceed mode added as default |
| v4.3.2 | 2026-01-20 | Gate refinements |
| v4.3.1 | 2026-01-18 | Sub-agent integration |

## Changes in v4.3.3.1 (2026-01-23)

### Feature: Session-Based Auto-Proceed Preferences

**Problem**: Auto-proceed was always ON with no user control except manual interruption.

**Solution**:
1. **Session initialization prompt** - At session start, Claude asks if user wants to disable auto-proceed
2. **Database persistence** - Preference stored in `claude_sessions.metadata.auto_proceed`
3. **Runtime checks** - Commands query session preference before auto-proceeding
4. **Explicit override** - `/leo init` command to change preference anytime

**Files Changed**:
- `.claude/commands/leo.md` - Added session initialization logic and `/leo init` command
- `database/migrations/20251204_multi_session_coordination.sql` - Already supports `metadata` JSONB field
- `database/migrations/20260130_multi_session_pessimistic_locking.sql` - Enhanced multi-session coordination (unique index, heartbeat, triggers)
- This documentation file - Updated with new preference system

**User Experience**:
```
# Session start
User: /leo next
Claude: Auto-proceed mode is ON by default. Would you like to disable it?
  [Keep ON (Recommended)] | [Turn OFF]
User: Keep ON
Claude: âœ… Session Initialized - Auto-Proceed: ON
```

**Backward Compatibility**:
- Default remains ON (no breaking changes)
- Existing sessions without preference default to ON
- All existing auto-proceed behavior preserved

---

## Changes in v4.3.3.3 (2026-01-30)

### Feature: Cross-Session AUTO-PROCEED Continuation

**SD**: SD-LEO-INFRA-STOP-HOOK-ENHANCEMENT-001
**PR**: #694

**Problem**: AUTO-PROCEED works within sessions but cannot continue across session boundaries. When Claude reaches context limits or a session ends, the workflow stops instead of continuing autonomously.

**Solution**: External loop runner that restarts Claude Code sessions when incomplete work is detected.

#### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXTERNAL LOOP (PowerShell)                           â”‚
â”‚                    leo-continuous-loop.ps1                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Start Loop  â”‚â”€â”€â”€>â”‚ Check State  â”‚â”€â”€â”€>â”‚ Generate Continuation Promptâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         ^                   â”‚                          â”‚                 â”‚
â”‚         â”‚                   â–¼                          â–¼                 â”‚
â”‚         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚         â”‚           â”‚  Complete?   â”‚    â”‚ Feed to Claude Code          â”‚â”‚
â”‚         â”‚           â”‚ (Exit Loop)  â”‚    â”‚ claude --dangerously-skip... â”‚â”‚
â”‚         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                              â–¼                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  Safety: MaxRetries(10) | Cooldown(60s) | CircuitBreaker(3) | Lockfile  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Exit Code 3 = "Incomplete"
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STOP HOOK Enhancement                            â”‚
â”‚              scripts/hooks/stop-subagent-enforcement/index.js            â”‚
â”‚                                                                          â”‚
â”‚  New exit code: 3 = Incomplete (continuation needed)                     â”‚
â”‚  Writes: .claude/continuation-state.json                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### New Files

| File | Purpose |
|------|---------|
| `scripts/modules/handoff/continuation-state.js` | State management with schema validation |
| `scripts/modules/handoff/continuation-prompt-generator.js` | Context-aware prompt generation |
| `scripts/leo-continuous-loop.ps1` | External PowerShell loop runner (Windows) |
| `scripts/generate-continuation-prompt.js` | CLI wrapper for prompt generation |
| `tests/unit/continuation-state.test.js` | 31 unit tests for state management |

#### Modified Files

| File | Changes |
|------|---------|
| `scripts/hooks/stop-subagent-enforcement/index.js` | Exit code 3 signaling when continuation needed |
| `scripts/leo-continuous.js` | Execute post-completion commands (not just log) |

#### Continuation State Schema

```json
{
  "version": "1.0.0",
  "status": "incomplete|complete|error|paused",
  "reason": "context_limit|session_end|user_interrupt|error",
  "sd": {
    "id": "SD-XXX-001",
    "phase": "EXEC",
    "progress": 75,
    "type": "infrastructure"
  },
  "pendingCommands": ["/document", "/ship", "/learn"],
  "lastAction": "Completed LEAD-FINAL-APPROVAL handoff",
  "retryCount": 0,
  "maxRetries": 10,
  "consecutiveErrors": 0,
  "errorDetails": null
}
```

#### Safety Mechanisms

| Mechanism | Value | Purpose |
|-----------|-------|---------|
| **MaxRetries** | 10 (default) | Prevents infinite retry loops |
| **CooldownSeconds** | 60 (default) | Minimum wait between restarts |
| **MaxCooldownSeconds** | 300 | Cap for exponential backoff |
| **CircuitBreakerThreshold** | 3 | Consecutive failures before trip |
| **CircuitBreakerResetMinutes** | 10 | Time before circuit breaker resets |
| **Lockfile** | `.claude/loop.lock` | Prevents multiple loop instances |

#### Exit Codes

| Code | Meaning | Loop Action |
|------|---------|-------------|
| 0 | Success/Complete | Exit loop |
| 1 | Error | Increment retry, apply backoff |
| 3 | Incomplete | Continue with next session |

#### Usage

```powershell
# Start with default settings
.\scripts\leo-continuous-loop.ps1

# Custom configuration
.\scripts\leo-continuous-loop.ps1 -MaxRetries 5 -CooldownSeconds 30

# Dry run (no actual sessions)
.\scripts\leo-continuous-loop.ps1 -DryRun
```

#### Continuation Prompt Generation

```bash
# Check if continuation is needed
node scripts/generate-continuation-prompt.js --check

# Generate prompt to stdout
node scripts/generate-continuation-prompt.js --stdout

# Show current state status
node scripts/generate-continuation-prompt.js --status
```

#### Stop Hook Integration

The stop hook now checks if AUTO-PROCEED is enabled and continuation is needed:

```javascript
// In scripts/hooks/stop-subagent-enforcement/index.js
const autoProceedResult = await safeAsync(async () => {
  const { data: sessionData } = await supabase
    .from('claude_sessions')
    .select('metadata')
    .eq('status', 'active')
    .order('heartbeat_at', { ascending: false })
    .limit(1)
    .single();

  const autoProceed = sessionData?.metadata?.auto_proceed ?? true;

  if (autoProceed) {
    const continuationCheck = await checkContinuationNeeded(supabase, sd, sdKey);
    if (continuationCheck.needed) {
      writeContinuationState(continuationCheck.state);
      writeContinuationPrompt();
      return { exitCode3: true };
    }
  }
  return { exitCode3: false };
}, 'checkAutoProceedContinuation');

if (autoProceedResult?.exitCode3) {
  gracefulExit(3);  // Signal external loop to continue
}
```

---

### Feature: Multi-Session Coordination with Pessimistic Locking

**SD**: SD-LEO-INFRA-MULTI-SESSION-COORDINATION-001
**PR**: #708, #710
**Date**: 2026-01-30

**Problem**: Before this enhancement, multiple Claude Code sessions could simultaneously claim the same Strategic Directive, leading to race conditions and duplicate work.

**Solution**: Database-level pessimistic locking with automatic heartbeat monitoring prevents concurrent SD claims.

#### Core Components

**1. Unique Index Constraint** (`idx_claude_sessions_unique_active_claim`)

Enforces single active claim per SD at the database level:

```sql
CREATE UNIQUE INDEX idx_claude_sessions_unique_active_claim
ON claude_sessions (sd_id)
WHERE sd_id IS NOT NULL AND status = 'active';
```

**Effect**: If Session A has claimed `SD-XXX-001`, Session B's attempt to claim the same SD will fail with a unique violation error. The database enforces this atomicallyâ€”no application-level race conditions.

**2. Heartbeat Manager** (`lib/heartbeat-manager.mjs`)

Automatic session liveness detection:
- **Interval**: 30 seconds (exceeds FR requirement of 60s)
- **Stale Threshold**: 5 minutes (300 seconds)
- **Max Failures**: 3 consecutive failures before auto-stop

**Integration**:
```javascript
// In BaseExecutor.js - Start heartbeat on claim
const heartbeatStatus = heartbeatManager.isHeartbeatActive();
if (!heartbeatStatus.active || heartbeatStatus.sessionId !== session.session_id) {
  heartbeatManager.startHeartbeat(session.session_id);
}

// In lead-final-approval/helpers.js - Stop heartbeat on release
if (heartbeatStatus.active && heartbeatStatus.sessionId === session.session_id) {
  heartbeatManager.stopHeartbeat();
}
```

**3. Enhanced View** (`v_active_sessions`)

Real-time session monitoring with computed staleness:

```sql
SELECT
  session_id,
  sd_id,
  heartbeat_age_seconds,      -- Seconds since last heartbeat
  heartbeat_age_human,         -- "30s ago", "2m ago"
  seconds_until_stale,         -- Countdown to 5-minute threshold
  computed_status              -- 'active', 'stale', 'idle', 'released'
FROM v_active_sessions;
```

**4. Automatic is_working_on Synchronization**

Trigger `sync_is_working_on_trigger` keeps `strategic_directives_v2.is_working_on` in sync:
- **On claim**: Sets `is_working_on = true`, `active_session_id = [session_id]`
- **On release**: Sets `is_working_on = false`, `active_session_id = NULL`

#### AUTO-PROCEED Integration

**Heartbeat Lifecycle**:
1. **Session starts** â†’ AUTO-PROCEED checks session preference
2. **SD claimed** â†’ Heartbeat starts automatically
3. **Work continues** â†’ Heartbeat pings every 30s
4. **Completion** â†’ Heartbeat stops on SD release
5. **Next SD** â†’ Heartbeat restarts on new claim

**Stale Session Detection**:

```bash
# Find sessions approaching stale (>3min, <5min)
SELECT session_id, sd_id, heartbeat_age_seconds, seconds_until_stale
FROM v_active_sessions
WHERE heartbeat_age_seconds > 180 AND heartbeat_age_seconds <= 300;
```

**Claim Rejection with Owner Details**:

When AUTO-PROCEED tries to claim an SD already claimed by another session:

```javascript
{
  success: false,
  error: 'already_claimed',
  claimed_by: 'session_abc123_tty1_1234',
  heartbeat_age_seconds: 45,
  heartbeat_age_human: '45s ago',
  hostname: 'dev-machine',
  tty: 'win-1234'
}
```

This enables AUTO-PROCEED to make intelligent decisions:
- **If heartbeat <5min**: Wait or pick different SD (session is active)
- **If heartbeat >5min**: Force release and claim (session is stale)

#### Migration Notes

**File**: `database/migrations/20260130_multi_session_pessimistic_locking.sql`

**Prerequisites**:
- PostgreSQL 14+ (for partial unique indexes)
- No duplicate active claims (cleaned up before migration)

**Rollback**:
```sql
DROP TRIGGER IF EXISTS sync_is_working_on_trigger ON claude_sessions;
DROP FUNCTION IF EXISTS sync_is_working_on_with_session();
DROP INDEX IF EXISTS idx_claude_sessions_unique_active_claim;
```

#### References

- **Documentation**:
  - [Heartbeat Manager API](../../reference/heartbeat-manager.md)
  - [Migration Guide](../../database/migrations/multi-session-pessimistic-locking.md)
  - [Operations Runbook](../../06_deployment/multi-session-coordination-ops.md)
- **Implementation Summary**: [SD-LEO-INFRA-MULTI-SESSION-COORDINATION-001](../../summaries/implementations/SD-LEO-INFRA-MULTI-SESSION-COORDINATION-001-summary.md)
```

#### Post-Completion Command Execution

`leo-continuous.js` now executes post-completion commands instead of just logging them:

```javascript
async function executePostCompletionCommand(command, supabase, sd, sdKey) {
  // Execute commands like /document, /ship, /learn
  // Track results in continuation state
  // Support both synchronous and async execution
}
```

#### Test Coverage

- 31 unit tests in `tests/unit/continuation-state.test.js`
- Schema validation tests
- State transition tests
- Circuit breaker logic tests
- All tests passing

#### Verification

```bash
# Verify stop hook has exit code 3 logic
grep "exitCode3\|gracefulExit(3)" scripts/hooks/stop-subagent-enforcement/index.js

# Verify continuation state module
node -e "const cs = require('./scripts/modules/handoff/continuation-state.js'); console.log('Module loaded:', Boolean(cs.readState))"

# Test prompt generation
node scripts/generate-continuation-prompt.js --check
```

---

---

## Changes in v4.3.3.4 (2026-01-31)

### Feature: Global Defaults for AUTO-PROCEED and Orchestrator Chaining

**SD**: SD-LEO-INFRA-DEPRECATE-UAT-DEFECTS-001
**Date**: 2026-01-31

**Problem**: Each new session required explicit configuration of AUTO-PROCEED and Orchestrator Chaining settings. No centralized way to set defaults that apply to all new sessions. Hard-coded `DEFAULT_AUTO_PROCEED = false` contradicted documentation claiming "ON by default".

**Solution**: Singleton global settings table (`leo_settings`) that stores defaults and automatically applies them to new sessions.

#### Database Schema

**Table**: `leo_settings` (singleton pattern)

```sql
CREATE TABLE leo_settings (
  id INTEGER PRIMARY KEY DEFAULT 1,
  auto_proceed BOOLEAN NOT NULL DEFAULT TRUE,
  chain_orchestrators BOOLEAN NOT NULL DEFAULT FALSE,
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  updated_by TEXT,
  CONSTRAINT leo_settings_singleton CHECK (id = 1)
);
```

**Helper Functions**:
- `get_leo_global_defaults()` - Fetch current global defaults
- `set_leo_global_defaults(p_auto_proceed, p_chain_orchestrators, p_updated_by)` - Update global defaults

#### Settings Precedence Hierarchy

```
1. CLI flags (--auto-proceed, --no-auto-proceed, --chain, --no-chain)
2. Session metadata (claude_sessions.metadata.auto_proceed, chain_orchestrators)
3. Global defaults (leo_settings table) â† NEW
4. Hard-coded fallback (auto_proceed=true, chain_orchestrators=false)
```

#### Auto-Proceed Resolver Enhancement

**File**: `scripts/modules/handoff/auto-proceed-resolver.js`

**Changes**:
1. Fixed `DEFAULT_AUTO_PROCEED = true` (was incorrectly `false`)
2. Added `RESOLUTION_SOURCES.GLOBAL`
3. Implemented `readFromGlobal(supabase)` function
4. Implemented `writeToGlobal(supabase, ...)` function
5. Updated `resolveAutoProceed()` to check global defaults before fallback

#### Session Manager Integration

**File**: `lib/session-manager.mjs`

**Changes**:
1. Added `getGlobalDefaults()` helper function
2. Modified `getOrCreateSession()` to fetch and apply global defaults
3. New sessions automatically inherit both `auto_proceed` and `chain_orchestrators`

**Behavior**:
```javascript
// New session creation
const defaults = await getGlobalDefaults();  // Fetch from leo_settings

sessionData.metadata = {
  branch,
  auto_proceed: defaults.auto_proceed,           // From global defaults
  chain_orchestrators: defaults.chain_orchestrators
};
```

#### New /leo settings Command

**Added**: `/leo settings` (alias `/leo s`) to `.claude/commands/leo.md`

**Features**:
1. **View Mode**: Display global defaults and current session settings
2. **Session Configuration**: Modify settings for current session only
3. **Global Configuration**: Modify defaults for all future sessions

**Usage**:
```bash
/leo settings           # Interactive settings management

# View both global and session settings
# Modify session OR global defaults
# Clear explanation of precedence
```

#### Default Values

| Setting | Global Default | Rationale |
|---------|---------------|-----------|
| **auto_proceed** | `TRUE` (ON) | Matches documentation, enables autonomous operation |
| **chain_orchestrators** | `FALSE` (OFF) | Conservative default, pause at orchestrator boundaries |

#### Orchestrator Chaining Documentation

**Added**: New section "Orchestrator Chaining Mode" to `leo_protocol_sections` database and CLAUDE.md

**Content**:
- Default behavior (OFF = pause at orchestrator completion)
- Configuration methods (session vs global)
- When to enable/disable chaining
- Power user mode explanation
- Precedence hierarchy

#### Files Modified

| File | Type | Changes |
|------|------|---------|
| `database/migrations/20260131_leo_settings.sql` | **NEW** | Singleton table + RPC functions |
| `database/migrations/20260131_add_chaining_documentation.sql` | **NEW** | Protocol documentation |
| `scripts/modules/handoff/auto-proceed-resolver.js` | Modified | Global defaults precedence |
| `lib/session-manager.mjs` | Modified | Apply defaults to new sessions |
| `.claude/commands/leo.md` | Modified | Added `/leo settings` subcommand |
| `scripts/section-file-mapping.json` | Modified | Added `orchestrator_chaining` |
| `scripts/modules/claude-md-generator/file-generators.js` | Modified | Router template |
| `CLAUDE.md` | Regenerated | Now 26.1 KB (was 24.0 KB) |

#### Usage Examples

**Example 1: New User First Session**
```
Session created â†’ Inherits global defaults (auto_proceed=ON, chain=OFF)
User works through SD â†’ AUTO-PROCEED enabled
Orchestrator completes â†’ Pauses for review (chaining OFF)
```

**Example 2: Change Global Defaults**
```
/leo settings â†’ "Change global defaults"
â†’ Sets auto_proceed=OFF globally
â†’ All future sessions start with AUTO-PROCEED disabled
â†’ Current session unaffected
```

**Example 3: Session Override**
```
/leo settings â†’ "Change session settings"
â†’ Sets chain_orchestrators=ON for debugging
â†’ Current session only
â†’ Next session inherits global default (still OFF)
```

#### Verification

```bash
# Check global defaults
node -e "
require('dotenv').config();
const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
supabase.rpc('get_leo_global_defaults').then(({data}) => console.log(data));
"

# Expected output:
# [{ auto_proceed: true, chain_orchestrators: false, ... }]
```

#### Benefits

1. **Zero Configuration**: New users get optimal defaults automatically
2. **Centralized Control**: Change defaults once, applies to all new sessions
3. **Bug Fix**: `DEFAULT_AUTO_PROCEED = true` now matches documentation
4. **Database-First**: Settings stored in database, not hardcoded
5. **Backwards Compatible**: Existing sessions retain their settings

#### Related Documentation

- **Implementation Summary**: `docs/summaries/implementations/auto-proceed-global-settings-implementation.md`
- **Original Discovery**: `docs/discovery/auto-proceed-enhancement-discovery.md`

---

**Version History**:
- **v4.3.3.4** (2026-01-31): Added global defaults for AUTO-PROCEED and Orchestrator Chaining
  - New: `leo_settings` singleton table for global defaults
  - New: `/leo settings` command for managing session and global settings
  - Fixed: `DEFAULT_AUTO_PROCEED = true` (was incorrectly false)
  - Modified: `auto-proceed-resolver.js` with global defaults precedence
  - Modified: `session-manager.mjs` to apply defaults on session creation
  - Added: Orchestrator Chaining documentation to CLAUDE.md
  - Migration: `20260131_leo_settings.sql`, `20260131_add_chaining_documentation.sql`
- **v4.3.3.3** (2026-01-30): Added cross-session AUTO-PROCEED continuation (PR #694)
  - New: `continuation-state.js` module for cross-session state management
  - New: `continuation-prompt-generator.js` for context-aware prompts
  - New: `leo-continuous-loop.ps1` external PowerShell loop runner
  - New: Exit code 3 signaling for incomplete sessions
  - Modified: `stop-subagent-enforcement/index.js` with continuation detection
  - Modified: `leo-continuous.js` to execute (not just log) post-completion commands
  - Safety: MaxRetries, CircuitBreaker, rate limiting, lockfile
  - 31 new unit tests
- **v4.3.3.2** (2026-01-25): Added child SD continuation logic (PR #622)
  - New: `child-sd-selector.js` module for selecting next ready child
  - Modified: `cli-main.js` with `handleExecuteWithContinuation()` loop
  - Modified: Conditional AUTO-PROCEED state clearing
  - Implements D26 (smooth continuation) and D01 (pause at orchestrator boundary)
- **v4.3.3.1** (2026-01-23): Added session-based auto-proceed preferences
- **v4.3.3** (2026-01-22): Initial auto-proceed enhancement release

**Last Updated**: 2026-01-31
**Maintained By**: LEO Protocol Team
**Status**: Active and In Production
